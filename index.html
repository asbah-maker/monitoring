<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi Sinyalku - Inventory Pro V3.5 (Smart Input)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS UTAMA --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f9; padding: 10px; color: #333; margin: 0; font-size: 14px;
        }
        .container { max-width: 1000px; margin: 0 auto; width: 100%; }
        .header-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; text-align: center; }
        h1 { color: #2c3e50; margin: 0 0 15px 0; font-size: 1.5rem; line-height: 1.3; }
        
        .btn-group-header { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .btn-action-main {
            color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-copy-all { background-color: #17a2b8; }
        .btn-excel { background-color: #217346; }
        .btn-ticket { background-color: #6610f2; }
        .btn-gudang { background-color: #d35400; } 
        .btn-reset { background-color: #dc3545; border: 2px solid #b02a37; }
        .btn-action-main:active { transform: scale(0.95); }

        .team-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; border: 1px solid #e1e4e8; }
        .team-header { padding: 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        
        .bg-blue { background: linear-gradient(135deg, #007bff, #0056b3); } 
        .bg-green { background: linear-gradient(135deg, #28a745, #1e7e34); } 
        .bg-red { background: linear-gradient(135deg, #dc3545, #bd2130); }
        .bg-orange { background: linear-gradient(135deg, #fd7e14, #e35d0b); }
        .bg-purple { background: linear-gradient(135deg, #6f42c1, #59359a); }
        .bg-teal { background: linear-gradient(135deg, #20c997, #198766); }
        .bg-dark { background: linear-gradient(135deg, #343a40, #23272b); }

        .job-list { list-style: none; padding: 0; margin: 0; }
        .job-item { border-bottom: 1px solid #eee; padding: 15px; }
        .job-main-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; justify-content: space-between; }
        .job-left { display: flex; align-items: flex-start; gap: 12px; flex: 1 1 60%; min-width: 250px; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #28a745; flex-shrink: 0; margin-top: 2px; }
        .customer-info h3 { margin: 0; font-size: 1.05rem; color: #2c3e50; }
        .customer-info p { margin: 4px 0 0; font-size: 0.9rem; color: #666; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px; }
        .badge-psb { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .badge-mt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .toggle-btn, .btn-copy, .btn-delete, .btn-stok { padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; flex: 1; text-align: center; }
        .toggle-btn { background: #f0f7ff; border: 1px solid #007bff; color: #007bff; }
        .btn-copy { background: #fff5eb; border: 1px solid #fd7e14; color: #fd7e14; }
        .btn-delete { background: #ffebee; border: 1px solid #dc3545; color: #dc3545; }
        .btn-stok { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; flex: none; }
        .btn-stok:hover { background: rgba(255,255,255,0.4); }

        .job-details { display: none; margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .detail-item { background: white; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        .detail-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px;}
        .detail-value { font-size: 0.95rem; color: #333; font-weight: 500; word-break: break-word; }

        .manual-input-section { background-color: #fff; border: 1px solid #dfe6ed; padding: 15px; border-radius: 8px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }
        
        .locked-input { background-color: #e9ecef; color: #495057; cursor: not-allowed; border: 1px solid #ced4da; font-weight: bold; }

        .modem-selector { background-color: #e8f0fe; border: 1px solid #1a73e8; color: #1a73e8; font-weight: bold; margin-bottom: 10px; }
        /* Style untuk option yang disabled/terpakai */
        option:disabled { color: red; background-color: #f2f2f2; text-decoration: line-through; }

        .progress-container { height: 6px; background: #e9ecef; width: 100%; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease; }
        .job-item.completed { background-color: #f6fff9; opacity: 0.8; }
        .job-item.completed .customer-info h3 { text-decoration: line-through; color: #999; }
        
        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 50px; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .tab-header { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .btn-add-list { width: 100%; padding: 12px; background-color: #6610f2; color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .tech-select-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f0f7ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; margin-bottom: 15px; }
        .generator-box { background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #1a73e8; }
        .generator-box textarea { width: 100%; border: 1px solid #b1ccf0; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 0.85rem; resize: vertical; }
        .btn-generate { width: 100%; background-color: #1a73e8; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; margin-top: 8px; cursor: pointer; }

        /* TABLE STOK & GUDANG */
        .table-stock { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .table-stock th, .table-stock td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table-stock th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        .table-stock tr:nth-child(even) { background-color: #f9f9f9; }
        
        .btn-view-stock { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px; }
        .btn-view-stock:hover { background: rgba(0,0,0,0.4); }
        .btn-icon-del { background: #ffebee; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        .btn-icon-del:hover { background: #ffcdd2; }
        
        /* STATUS BADGES GUDANG */
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 2px;}
        .st-ready { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .st-installed { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .st-bad { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; } /* Style Baru untuk BAD */
        
        .time-badge { font-size: 0.7em; color: #666; display: block; margin-top: 2px; }
        .tech-badge { font-weight: bold; color: #333; display: block; font-size: 0.8em; }

        /* GUDANG CONTROLS */
        .gudang-control { display:flex; gap: 5px; align-items: center; }
        .gudang-select { padding: 5px; border-radius: 4px; border:1px solid #ccc; width: 120px; font-size: 0.8rem;}
        .btn-send-team { background-color: #28a745; color:white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem;}
        .btn-return { background-color: #ffc107; color: #333; border: 1px solid #e0a800; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; font-weight:bold;}
        .btn-bad-retur { background-color: #dc3545; color: white; border: 1px solid #b21f2d; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; font-weight:bold; }

        .stat-box { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-wrap: wrap;}
        .stat-item { text-align: center; min-width: 60px; }
        .stat-num { font-weight: bold; font-size: 1.1rem; display: block; }
        .stat-lbl { font-size: 0.75rem; color: #666; }

        /* GUDANG HEADER ACTIONS */
        .gudang-actions-header {
            display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap;
        }
        .btn-bulk { background: #20c997; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-clean { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-clean:hover { background: #5a6268; }

        /* SEARCH BOX GUDANG STYLE */
        .search-gudang-box {
            width: 100%;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 6px;
            font-size: 0.95rem;
            margin-bottom: 5px;
            background-color: #f0f7ff;
            height: 60px;
            resize: vertical;
        }
        .search-gudang-box:focus { outline: none; box-shadow: 0 0 5px rgba(0,123,255,0.5); }

        @media (max-width: 576px) {
            body { padding: 5px; background-color: #fff; } .container { padding: 0; }
            .team-card { border-radius: 0; border-left: none; border-right: none; box-shadow: none; border-bottom: 2px solid #eee; }
            .header-section { margin: 15px 10px; }
            .job-main-row { flex-direction: column; align-items: flex-start; }
            .job-left, .action-buttons, .toggle-btn, .btn-copy, .btn-delete { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>
            üìã Monitoring Teknisi<br>
            <span style="font-size: 0.6em; color: green; display: block; margin-top:5px;">Realtime Database ‚Ä¢ Inventory System V3.5</span>
            <div id="connection-status">Connecting to server...</div>
        </h1>
        <div class="btn-group-header">
            <button class="btn-action-main btn-ticket" onclick="openModal()">üìù Buat Tiket</button>
            <button class="btn-action-main btn-gudang" onclick="openGudangModal()">üè≠ Gudang Modem</button>
            <button class="btn-action-main btn-copy-all" onclick="copyAllSummary()">üìë Copy Rekap</button>
            <button class="btn-action-main btn-excel" onclick="downloadExcel()">üìä Download Excel</button>
            <button class="btn-action-main btn-reset" onclick="resetDatabase()">üî¥ Reset Tiket</button>
        </div>
    </div>

    <div id="teams-container">
        <p style="text-align: center; color: #888;">Memuat data...</p>
    </div>
</div>

<div id="modalGudang" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeGudangModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #d35400;">üè≠ GUDANG MODEM PUSAT</h2>
        
        <div class="stat-box">
            <div class="stat-item"><span id="stat-ready" class="stat-num" style="color:#28a745;">0</span><span class="stat-lbl">Ready</span></div>
            <div class="stat-item"><span id="stat-pending" class="stat-num" style="color:#fd7e14;">0</span><span class="stat-lbl">Pending</span></div>
            <div class="stat-item"><span id="stat-installed" class="stat-num" style="color:#007bff;">0</span><span class="stat-lbl">Terpasang</span></div>
            <div class="stat-item"><span id="stat-bad" class="stat-num" style="color:#dc3545;">0</span><span class="stat-lbl">BAD</span></div>
        </div>

        <div class="gudang-actions-header">
            <button class="btn-bulk" onclick="openBulkModal()">‚ûï Input Stok Massal</button>
            <button class="btn-clean" onclick="clearInstalledModems()">üóëÔ∏è Hapus Data Terpasang</button>
        </div>

        <div class="tab-header">
            <button class="tab-btn active" onclick="switchGudangTab('srb')">Modem SRB <span id="count-srb" class="badge badge-psb">0</span></button>
            <button class="tab-btn" onclick="switchGudangTab('syn')">Modem SYN <span id="count-syn" class="badge badge-mt">0</span></button>
        </div>

        <div style="margin-bottom: 10px;">
            <textarea id="gudang-search" class="search-gudang-box" placeholder="üîç Cari Banyak Modem (4 digit belakang). Pisahkan dengan koma/spasi/enter.
Contoh: A9C0, 74F8, 34B8" onkeyup="renderGudangTable()"></textarea>
            <div style="font-size:0.75rem; color:#666; text-align:right;">*Hasil filter otomatis muncul dibawah</div>
        </div>

        <div id="gudang-content" style="max-height: 400px; overflow-y: auto;">
            <table class="table-stock">
                <thead>
                    <tr>
                        <th style="width:30px;">No</th>
                        <th>Serial Number (SN)</th>
                        <th>MAC Address</th>
                        <th>Status / Posisi / Waktu</th>
                        <th style="width:160px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="gudang-table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalBulk" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" onclick="closeBulkModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #20c997;">‚ûï Input Stok Massal</h2>
        
        <div class="form-group">
            <label>Pilih Jenis Modem Tujuan:</label>
            <select id="bulk-type" style="font-weight: bold; color: #333;">
                <option value="srb">Modem SRB (Paket 150rb)</option>
                <option value="syn">Modem SYN (Paket Lain/MT)</option>
            </select>
        </div>

        <div class="generator-box" style="border: 1px dashed #20c997; background: #f0fff4;">
            <label style="color: #20c997; font-weight: bold;">üìã Paste Data (SN dan MAC)</label>
            <p style="font-size:0.8rem; margin:2px 0 5px 0; color:#666;">Format: Bisa 1 baris panjang atau enter. (SN [spasi] MAC)</p>
            <textarea id="bulk-text" rows="10" placeholder="Contoh:
FHTT9C7BA8F8 6C-D7-19-7B-A8-F8 FHTT9C803550 6C-D7-19-80-35-50"></textarea>
        </div>

        <button class="btn-add-list" style="background-color: #20c997;" onclick="processBulkInput()">‚ö° Proses & Simpan</button>
    </div>
</div>

<div id="modalStock" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeStockModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #007bff;">üì¶ Input Stok Manual (Darurat)</h2>
        <input type="hidden" id="stock-team-index">
        
        <div class="form-group">
            <label>Serial Number (SN)</label>
            <input type="text" id="stock-sn" placeholder="ZTEGC...">
        </div>
        <div class="form-group">
            <label>MAC Address</label>
            <input type="text" id="stock-mac" placeholder="A1:B2:C3...">
        </div>
        <button class="btn-add-list" style="background-color: #28a745;" onclick="saveStockToTeam()">‚ûï Simpan ke Stok Tim</button>
    </div>
</div>

<div id="modalStockList" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" onclick="closeStockListModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #17a2b8;">üì¶ Data Stok Modem Tim</h2>
        <h4 id="stock-list-title" style="text-align: center; margin: 0 0 15px 0; color: #666;"></h4>
        
        <div style="overflow-x: auto;">
            <table class="table-stock">
                <thead>
                    <tr>
                        <th style="width: 40px;">No</th>
                        <th>Serial Number (SN)</th>
                        <th>MAC Address</th>
                        <th style="width: 60px; text-align: center;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="stock-table-body">
                    </tbody>
            </table>
            <div id="stock-empty-msg" style="text-align: center; padding: 20px; color: #999; font-style: italic; display: none;">
                Belum ada data stok modem.
            </div>
        </div>
    </div>
</div>

<div id="modalTicket" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center;">Buat Tiket Baru</h2>
        
        <div class="tech-select-container">
            <div class="tech-select-wrapper">
                <label>üë§ Teknisi 1 (Wajib)</label>
                <select id="tech-1"></select>
            </div>
            <div class="tech-select-wrapper">
                <label>üë§ Teknisi 2 (Opsional)</label>
                <select id="tech-2">
                    <option value="">-- Kosong --</option>
                </select>
            </div>
        </div>

        <div class="tab-header">
            <button class="tab-btn active" onclick="switchTab('psb')">Tiket PSB</button>
            <button class="tab-btn" onclick="switchTab('mt')">Tiket MT / Lain</button>
        </div>

        <div id="form-psb">
            <div class="generator-box">
                <label style="color: #1a73e8; font-weight: bold; font-size: 0.9rem;">‚ú® Auto-Fill Data (Paste Format WA)</label>
                <textarea id="psb-raw-text" rows="3" placeholder="Paste format Nama, Alamat, dll disini..."></textarea>
                <button class="btn-generate" onclick="generateFromText()">‚ö° Generate Data PSB</button>
            </div>

            <div class="form-group"><label>Nama Lengkap</label><input type="text" id="psb-nama" placeholder="Contoh: Marlina"></div>
            <div class="form-group"><label>Jam Kunjungan</label><input type="text" id="psb-jam" placeholder="Contoh: 13:00"></div>
            <div class="form-group"><label>Alamat Lengkap</label><textarea id="psb-alamat" rows="2" placeholder="Jalan raya Bekasi..."></textarea></div>
            <div class="form-group"><label>Email Aktif</label><input type="email" id="psb-email" placeholder="email@gmail.com"></div>
            <div class="form-group"><label>No. WA</label><input type="tel" id="psb-wa" placeholder="08xxxxx"></div>
            <div class="form-group"><label>Paket Layanan</label><input type="text" id="psb-paket" placeholder="150 ribu + free regist"></div>
            <div class="form-group"><label>No KTP</label><input type="text" id="psb-ktp" placeholder="317506..."></div>
            <div class="form-group"><label>Tanggal Pemasangan</label><input type="text" id="psb-tgl" placeholder="Hari ini / Tgl tertentu"></div>
            <div class="form-group">
                <label>Status Kepemilikan</label>
                <select id="psb-status">
                    <option value="Pribadi">Pribadi</option>
                    <option value="Sewa/Kontrak">Sewa/Kontrak</option>
                    <option value="Kost">Kost</option>
                </select>
            </div>
        </div>

        <div id="form-mt" style="display: none;">
            <div class="generator-box">
                <label style="color: #1a73e8; font-weight: bold; font-size: 0.9rem;">‚ú® Auto-Fill Data MT (Paste Format WA)</label>
                <textarea id="mt-raw-text" rows="3" placeholder="Paste format MT (Nama, Kendala, dll)..."></textarea>
                <button class="btn-generate" onclick="generateFromTextMT()">‚ö° Generate Data MT</button>
            </div>

            <div class="form-group"><label>Nama Pelanggan</label><input type="text" id="mt-nama" placeholder="Contoh: ABDUL"></div>
            <div class="form-group"><label>Kendala / Tag</label><input type="text" id="mt-tag" placeholder="MT (LOS) / RAPIH KABEL"></div>
            <div class="form-group"><label>No Layanan</label><input type="text" id="mt-layanan" placeholder="0607352848"></div>
            <div class="form-group"><label>No Telp</label><input type="tel" id="mt-telp" placeholder="085280148797"></div>
            <div class="form-group"><label>Tanggal Daftar</label><input type="text" id="mt-tgl" placeholder="17 November 2023"></div>
            <div class="form-group"><label>Coverage</label><input type="text" id="mt-coverage" placeholder="Kel. Jatinegara"></div>
            <div class="form-group"><label>Alamat</label><textarea id="mt-alamat" rows="2" placeholder="Kp rawa badung rt01..."></textarea></div>
        </div>

        <button class="btn-add-list" onclick="addTicketToTeam()">‚ûï Tambahkan ke List (Simpan Permanen)</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
      authDomain: "monitoring-3aeb6.firebaseapp.com",
      databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
      projectId: "monitoring-3aeb6",
      storageBucket: "monitoring-3aeb6.firebasestorage.app",
      messagingSenderId: "888117973644",
      appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
      measurementId: "G-PTL0F1FPK0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'monitoring_teams_master'); 
    const gudangRef = ref(db, 'gudang_master_stock_v2');

    const techList = ["Ajis", "Bima", "Bimo", "Dani", "Deni", "Tomy", "Takim", "Reza", "Pian", "Rahmat", "Kholis", "Yudha", "Rival"];
    techList.sort(); 

    const defaultTeams = [];
    const extraColors = ["bg-orange", "bg-purple", "bg-teal", "bg-dark"];
    let teams = [];
    let gudangStock = { srb: [], syn: [] };

    window.resetDatabase = function() {
        let pin = prompt("‚ö†Ô∏è PERINGATAN: INI AKAN MENGHAPUS SEMUA TIKET!\n\nData Gudang (Pending/Terpasang) TIDAK AKAN DIHAPUS.\nMasukkan PIN untuk konfirmasi:");
        if (pin === "240525") {
            set(dbRef, []).then(() => {
                alert("‚úÖ Tiket & Tim berhasil di-reset bersih!\nData Gudang Modem tetap tersimpan.");
                location.reload();
            }).catch((err) => {
                alert("Gagal mereset database: " + err);
            });
        } else if (pin) {
            alert("‚ùå PIN SALAH!");
        }
    }

    function loadFirebaseData() {
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            document.getElementById('connection-status').innerText = "‚úÖ Terhubung Online (Data Tersimpan)";
            document.getElementById('connection-status').style.color = "green";
            if (data) {
                teams = data;
                teams.forEach(t => { if(!t.inventory) t.inventory = []; });
            } else {
                teams = JSON.parse(JSON.stringify(defaultTeams));
            }
            if(gudangStock.srb || gudangStock.syn) {
                renderJobs();
                syncInstalledModems();
            }
        });

        onValue(gudangRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                gudangStock = data;
                if(!gudangStock.srb) gudangStock.srb = [];
                if(!gudangStock.syn) gudangStock.syn = [];
            } else {
                const newStock = { srb: [], syn: [] };
                set(gudangRef, newStock);
                gudangStock = newStock;
            }
            
            updateGudangCounts();
            if(document.getElementById("modalGudang").style.display === "block") {
                renderGudangTable(currentGudangTab);
            }
            renderJobs();
        });
    }

    // --- SYNC MODEM TERPASANG ---
    function syncInstalledModems() {
        let needsUpdate = false;
        const installedData = {};
        
        teams.forEach(team => {
            if(team.jobs) {
                team.jobs.forEach(job => {
                    if(job.completed && job.technical && job.technical.sn && job.technical.sn !== '-') {
                        const time = job.completedAt || new Date().toLocaleString('id-ID');
                        installedData[job.technical.sn] = {
                            teamName: team.teamName,
                            time: time
                        };
                    }
                });
            }
        });

        function updateItem(item) {
            // Jika item sudah di mark BAD, JANGAN diubah jadi installed walaupun ada di tiket
            if (item.status === 'bad') return;

            if (installedData[item.sn]) {
                if (item.status !== 'installed' || !item.installedDate) {
                    item.status = 'installed';
                    item.teamName = installedData[item.sn].teamName; 
                    item.installedDate = installedData[item.sn].time;
                    needsUpdate = true;
                }
            }
        }

        gudangStock.srb.forEach(updateItem);
        gudangStock.syn.forEach(updateItem);

        if (needsUpdate) {
            saveGudangToFirebase();
        }
    }

    function getModemStatusGlobal(sn) {
        let item = gudangStock.srb.find(x => x.sn === sn);
        if(!item) item = gudangStock.syn.find(x => x.sn === sn);
        return item ? item.status : 'unknown';
    }

    function saveDataToFirebase() {
        set(dbRef, teams).catch((err) => alert("Gagal menyimpan data ke server!"));
    }
    
    function saveGudangToFirebase() {
        set(gudangRef, gudangStock).catch((err) => alert("Gagal update gudang!"));
    }

    function renderJobs() {
        const container = document.getElementById('teams-container');
        container.innerHTML = ''; 

        if (!Array.isArray(teams)) { teams = []; }

        teams.sort((a, b) => {
            const getNum = (str) => {
                const match = str.match(/Tim\s+(\d+)/i);
                return match ? parseInt(match[1]) : 99999;
            };
            return getNum(a.teamName) - getNum(b.teamName);
        });
        
        let visibleTeamsCount = 0;

        teams.forEach((team, tIndex) => {
            if(!team.jobs) team.jobs = [];
            if(!team.inventory) team.inventory = [];

            if (team.jobs.length === 0) { return; }
            visibleTeamsCount++;

            const stockCount = team.inventory.filter(inv => {
                 const st = getModemStatusGlobal(inv.sn);
                 return st !== 'installed' && st !== 'bad';
            }).length;
            
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-card';
            
            teamDiv.innerHTML = `
                <div class="team-header ${team.colorClass}">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span>${team.teamName}</span>
                        <span style="font-size: 0.75em; opacity: 0.9;">üì¶ Sisa Stok: ${stockCount} pcs</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <button class="btn-stok" onclick="openStockModal(${tIndex})">‚ûï Input</button>
                        <button class="btn-view-stock" onclick="openStockListModal(${tIndex})">MODEM</button>
                        <span id="count-${team.id}" style="font-size: 0.9em; margin-left: 5px;">0/0</span>
                    </div>
                </div>
                <div class="progress-container"><div class="progress-bar" id="progress-${team.id}"></div></div>
                <ul class="job-list" id="list-${team.id}"></ul>
            `;
            container.appendChild(teamDiv);

            const listContainer = document.getElementById(`list-${team.id}`);
            
            let modemOptions = `<option value="">-- Pilih Modem dari Stok (${stockCount}) --</option>`;
            team.inventory.forEach(inv => {
                const status = getModemStatusGlobal(inv.sn);
                if (status === 'installed') {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}" disabled>‚ùå ${inv.sn} (Terpasang)</option>`;
                } else if (status === 'bad') {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}" disabled>‚ö†Ô∏è ${inv.sn} (BAD)</option>`;
                } else {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}">üì¶ ${inv.sn}</option>`;
                }
            });
            
            team.jobs.forEach((job, index) => {
                const li = document.createElement('li');
                li.className = 'job-item';
                if(job.completed) li.classList.add('completed');
                
                let detailHTML = '';
                for (const [key, value] of Object.entries(job.details)) {
                    detailHTML += `<div class="detail-item"><span class="detail-label">${key}</span><span class="detail-value">${value}</span></div>`;
                }

                const uniqueId = `details-${team.id}-${index}`;
                const checkboxId = `chk-${team.id}-${index}`;
                const isPSB = job.tag.toUpperCase().includes("PSB");
                const tech = job.technical || {};

                let formHTML = '';
                if (isPSB) {
                    formHTML = `
                    <div class="manual-input-section">
                        <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìù Input Data Teknis</h4>
                        
                        <div style="margin-bottom:10px;">
                            <label style="font-size:0.8rem; color:#007bff; font-weight:bold;">üì¶ Ambil Modem dari Stok:</label>
                            <select class="modem-selector" onchange="fillModemData(this, ${tIndex}, ${index})">
                                ${modemOptions}
                            </select>
                        </div>

                        <div class="input-grid">
                            <div class="input-group"><label>Kode SN</label><input type="text" id="sn-${tIndex}-${index}" class="realtime-input locked-input" data-key="sn" data-team="${tIndex}" data-job="${index}" value="${tech.sn || ''}" placeholder="Otomatis..." readonly></div>
                            <div class="input-group"><label>Mac</label><input type="text" id="mac-${tIndex}-${index}" class="realtime-input locked-input" data-key="mac" data-team="${tIndex}" data-job="${index}" value="${tech.mac || ''}" placeholder="Otomatis..." readonly></div>
                            <div class="input-group"><label>Mac vlan (+1)</label><input type="text" id="vlan-${tIndex}-${index}" class="realtime-input locked-input" data-key="vlan" data-team="${tIndex}" data-job="${index}" value="${tech.vlan || ''}" placeholder="Otomatis..." readonly></div>
                            <div class="input-group"><label>Panjang kabel</label><input type="text" class="realtime-input" data-key="kabel" data-team="${tIndex}" data-job="${index}" value="${tech.kabel || ''}" placeholder="150m"></div>
                            <div class="input-group"><label>Port</label><input type="text" class="realtime-input" data-key="port" data-team="${tIndex}" data-job="${index}" value="${tech.port || ''}" placeholder="2"></div>
                            <div class="input-group"><label>Id ODP</label><input type="text" class="realtime-input" data-key="odp" data-team="${tIndex}" data-job="${index}" value="${tech.odp || ''}" placeholder="ODP-.."></div>
                            <div class="input-group" style="grid-column: 1/-1;"><label>Redaman</label><input type="text" class="realtime-input" data-key="redaman" data-team="${tIndex}" data-job="${index}" value="${tech.redaman || ''}" placeholder="-18 dBm"></div>
                        </div>
                    </div>`;
                }

                li.innerHTML = `
                    <div class="job-main-row">
                        <div class="job-left">
                            <input type="checkbox" id="${checkboxId}" class="custom-checkbox" ${job.completed ? 'checked' : ''}>
                            <div class="customer-info">
                                <h3>${job.name} <span class="badge ${job.tagClass}">${job.tag}</span></h3>
                                <p>üìç ${job.address}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyData(${tIndex}, ${index}, this)">üìã Copy</button>
                            <button class="toggle-btn" onclick="toggleDetails('${uniqueId}')">üîΩ Detail</button>
                            <button class="btn-delete" onclick="deleteTicket(${tIndex}, ${index})">‚ùå Hapus</button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="job-details">
                        <div class="detail-grid">
                            <div class="detail-item"><span class="detail-label">Jadwal</span><span class="detail-value">${job.time}</span></div>
                            ${detailHTML}
                        </div>
                        ${formHTML}
                    </div>
                `;
                listContainer.appendChild(li);

                const checkbox = document.getElementById(checkboxId);
                checkbox.addEventListener('change', (e) => {
                    teams[tIndex].jobs[index].completed = e.target.checked;
                    if(e.target.checked) {
                        teams[tIndex].jobs[index].completedAt = new Date().toLocaleString('id-ID');
                    } else {
                        teams[tIndex].jobs[index].completedAt = null;
                    }

                    saveDataToFirebase(); 
                    setTimeout(() => {
                        syncInstalledModems();
                        renderJobs(); 
                    }, 1000); 
                });

                if(isPSB) {
                    const inputs = li.querySelectorAll('.realtime-input');
                    inputs.forEach(input => {
                        input.addEventListener('change', (e) => {
                            const key = e.target.getAttribute('data-key');
                            if(!teams[tIndex].jobs[index].technical) teams[tIndex].jobs[index].technical = {};
                            teams[tIndex].jobs[index].technical[key] = e.target.value;
                            saveDataToFirebase(); 
                        });
                    });
                }
            });
            updateProgressUI(team.id, team.jobs);
        });

        if (visibleTeamsCount === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#999; font-style:italic;">üëã Belum ada tiket aktif.<br>Silakan buat tiket baru untuk memunculkan Tim.</div>';
        }
    }

    // --- LOGIKA GUDANG MODEM V2 ---
    let currentGudangTab = 'srb';
    
    window.openGudangModal = function() {
        document.getElementById('modalGudang').style.display = "block";
        switchGudangTab(currentGudangTab);
    }
    
    window.closeGudangModal = function() {
        document.getElementById('modalGudang').style.display = "none";
    }

    window.switchGudangTab = function(type) {
        currentGudangTab = type;
        // Reset Search saat pindah tab agar tidak bingung
        document.getElementById('gudang-search').value = "";
        
        document.querySelectorAll('.tab-header .tab-btn').forEach(btn => btn.classList.remove('active'));
        if(type === 'srb') document.querySelectorAll('.tab-header .tab-btn')[0].classList.add('active');
        else document.querySelectorAll('.tab-header .tab-btn')[1].classList.add('active');
        
        renderGudangTable(type);
    }

    function updateGudangCounts() {
        const allItems = [...(gudangStock.srb || []), ...(gudangStock.syn || [])];
        const ready = allItems.filter(i => !i.status || i.status === 'ready').length;
        const pending = allItems.filter(i => i.status === 'pending').length;
        const installed = allItems.filter(i => i.status === 'installed').length;
        const bad = allItems.filter(i => i.status === 'bad').length;

        document.getElementById('stat-ready').innerText = ready;
        document.getElementById('stat-pending').innerText = pending;
        document.getElementById('stat-installed').innerText = installed;
        document.getElementById('stat-bad').innerText = bad;

        document.getElementById('count-srb').innerText = gudangStock.srb ? gudangStock.srb.length : 0;
        document.getElementById('count-syn').innerText = gudangStock.syn ? gudangStock.syn.length : 0;
    }

    // --- LOGIKA FILTER SEARCH BANYAK & RENDER ---
    window.renderGudangTable = function(type) {
        if (!type) {
            type = currentGudangTab;
        }

        const tbody = document.getElementById('gudang-table-body');
        tbody.innerHTML = '';
        let data = gudangStock[type] || [];

        // 1. FILTER SEARCH LOGIC (MULTI KEYWORD)
        const searchInput = document.getElementById('gudang-search').value;
        if (searchInput.trim() !== "") {
            const keywords = searchInput.toUpperCase().split(/[\s,]+/).filter(k => k.length > 0);
            
            if (keywords.length > 0) {
                data = data.filter(item => {
                    const sn = (item.sn || '').toUpperCase(); 
                    return keywords.some(key => sn.endsWith(key) || sn.includes(key));
                });
            }
        }

        const statusOrder = { 'ready': 1, 'pending': 2, 'installed': 3, 'bad': 4 };
        data.sort((a, b) => (statusOrder[a.status || 'ready'] - statusOrder[b.status || 'ready']));

        let teamOptions = '<option value="">-- Pilih Tim --</option>';
        teams.forEach((t, idx) => {
             if(t.jobs && t.jobs.length > 0) {
                 teamOptions += `<option value="${idx}">${t.teamName}</option>`;
             }
        });

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">Data tidak ditemukan</td></tr>';
            return;
        }

        data.forEach((item, index) => {
            const originalIndex = gudangStock[type].indexOf(item);

            const tr = document.createElement('tr');
            
            let statusBadge = `<span class="status-badge st-ready">Ready</span>`;
            let aksiContent = '';

            if (item.status === 'pending') {
                statusBadge = `
                    <span class="status-badge st-pending">Pending</span>
                    <span class="tech-badge">@ ${item.teamName || 'Tim ?'}</span>
                    <span class="time-badge">üïí ${item.pendingDate || '-'}</span>
                `;
                aksiContent = `<button class="btn-return" onclick="returnToWarehouse('${type}', ${originalIndex})">‚Ü©Ô∏è Tarik Balik</button>`;
            } else if (item.status === 'installed') {
                statusBadge = `
                    <span class="status-badge st-installed">Terpasang</span>
                    <span class="tech-badge">üë§ ${item.teamName || 'Teknisi ?'}</span>
                    <span class="time-badge">‚úÖ ${item.installedDate || '-'}</span>
                `;
                aksiContent = `
                    <div style="display:flex; gap:5px;">
                        <button class="btn-return" onclick="processModemAction('${type}', ${originalIndex}, 'retur')">‚Ü©Ô∏è Retur</button>
                        <button class="btn-bad-retur" onclick="processModemAction('${type}', ${originalIndex}, 'bad')">‚ö†Ô∏è Set BAD</button>
                    </div>
                `;
            } else if (item.status === 'bad') {
                statusBadge = `
                    <span class="status-badge st-bad">BAD / RUSAK</span>
                    <span class="time-badge">‚õî Tidak Layak</span>
                `;
                aksiContent = `<button class="btn-return" onclick="processModemAction('${type}', ${originalIndex}, 'reset')">üîÑ Reset Ready</button> <button class="btn-icon-del" onclick="deleteFromWarehouse('${type}', ${originalIndex})">üóëÔ∏è</button>`;
            } else {
                aksiContent = `
                    <div class="gudang-control">
                        <select id="team-sel-${type}-${originalIndex}" class="gudang-select">
                            ${teamOptions}
                        </select>
                        <button class="btn-send-team" onclick="sendToTeam('${type}', ${originalIndex})">‚û°Ô∏è Kirim</button>
                    </div>`;
            }

            // Highlight keyword
            let snDisplay = item.sn;
            if(searchInput.trim() !== "") {
                 snDisplay = `<span style="background-color: yellow;">${item.sn}</span>`;
            }

            tr.innerHTML = `
                <td style="text-align:center;">${index + 1}</td>
                <td><span style="font-weight:bold; color:#333;">${snDisplay}</span></td>
                <td>${item.mac}</td>
                <td>${statusBadge}</td>
                <td>${aksiContent}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- LOGIKA BULK INPUT & CLEANER (DIPERBARUI) ---
    window.openBulkModal = function() {
        document.getElementById('modalBulk').style.display = "block";
    }

    window.closeBulkModal = function() {
        document.getElementById('modalBulk').style.display = "none";
    }

    window.processBulkInput = function() {
        const raw = document.getElementById('bulk-text').value;
        const type = document.getElementById('bulk-type').value;

        if(!raw.trim()) { alert("Data masih kosong!"); return; }

        let successCount = 0;
        
        // --- LOGIKA BARU: SPLIT BERDASARKAN SPASI/ENTER/KOMA ---
        // Ini akan menangkap format: "SN1 MAC1 SN2 MAC2" dalam satu baris panjang
        // atau dalam format berbaris-baris.
        const tokens = raw.replace(/[\n,]/g, ' ').trim().split(/\s+/);

        // Loop setiap 2 item (Item genap=SN, Item ganjil=MAC)
        for (let i = 0; i < tokens.length; i += 2) {
            const sn = tokens[i];
            const mac = tokens[i + 1];

            // Pastikan pasangan ada (SN dan MAC)
            if (sn && mac) {
                // Cek duplikat sederhana
                let exists = gudangStock[type].find(item => item.sn === sn);
                if(!exists) {
                    gudangStock[type].push({
                        sn: sn,
                        mac: mac,
                        status: 'ready'
                    });
                    successCount++;
                }
            }
        }

        if(successCount > 0) {
            saveGudangToFirebase();
            alert(`‚úÖ Berhasil menambahkan ${successCount} Modem ke ${type.toUpperCase()}!`);
            closeBulkModal();
            document.getElementById('bulk-text').value = ''; 
            renderGudangTable(type);
            updateGudangCounts();
        } else {
            alert("‚ö†Ô∏è Tidak ada data baru yang ditambahkan atau format salah.\nPastikan urutannya: SN [spasi] MAC.");
        }
    }

    window.clearInstalledModems = function() {
        let pin = prompt("‚ö†Ô∏è PERINGATAN: INI AKAN MENGHAPUS DATA MODEM YANG BERSTATUS 'TERPASANG'!\n\nData Ready, Pending, dan BAD tidak akan terhapus.\nMasukkan PIN untuk konfirmasi:");
        
        if(pin === "240525") {
            const srbCountBefore = gudangStock.srb.length;
            gudangStock.srb = gudangStock.srb.filter(item => item.status !== 'installed');
            const srbDeleted = srbCountBefore - gudangStock.srb.length;

            const synCountBefore = gudangStock.syn.length;
            gudangStock.syn = gudangStock.syn.filter(item => item.status !== 'installed');
            const synDeleted = synCountBefore - gudangStock.syn.length;

            saveGudangToFirebase();
            alert(`‚úÖ PEMBERSIHAN SELESAI!\nDeleted SRB: ${srbDeleted}\nDeleted SYN: ${synDeleted}`);
            renderGudangTable(currentGudangTab);
            updateGudangCounts();

        } else if (pin) {
            alert("‚ùå PIN SALAH!");
        }
    }

    window.processModemAction = function(type, index, action) {
        const item = gudangStock[type][index];
        
        if (action === 'retur') {
            if(confirm(`‚ö†Ô∏è RETUR MODEM?\n\nApakah anda yakin menarik modem SN: ${item.sn} kembali ke Stok Ready?`)) {
                gudangStock[type][index].status = 'ready';
                gudangStock[type][index].teamName = '';
                gudangStock[type][index].teamId = null;
                gudangStock[type][index].pendingDate = null;
                gudangStock[type][index].installedDate = null;
                finalizeAction();
            }
        } else if (action === 'bad') {
            if(confirm(`‚ö†Ô∏è SET MODEM BAD?\n\nSN: ${item.sn} akan ditandai sebagai RUSAK/BAD.`)) {
                gudangStock[type][index].status = 'bad';
                finalizeAction();
            }
        } else if (action === 'reset') {
             if(confirm(`Kembalikan modem BAD (SN: ${item.sn}) menjadi READY?`)) {
                gudangStock[type][index].status = 'ready';
                finalizeAction();
             }
        }

        function finalizeAction() {
            saveGudangToFirebase();
            renderGudangTable(type);
            updateGudangCounts();
            renderJobs(); 
        }
    }

    window.deleteFromWarehouse = function(type, index) {
        if(confirm("Hapus modem ini permanen dari database gudang?")) {
            gudangStock[type].splice(index, 1);
            saveGudangToFirebase();
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.sendToTeam = function(type, index) {
        const select = document.getElementById(`team-sel-${type}-${index}`);
        const teamIdx = select.value;
        
        if(teamIdx === "") { alert("Pilih tim tujuan dulu!"); return; }
        
        const item = gudangStock[type][index];
        const teamName = teams[teamIdx].teamName;

        if(confirm(`Kirim modem SN: ${item.sn} ke ${teamName}?`)) {
            gudangStock[type][index].status = 'pending';
            gudangStock[type][index].teamName = teamName;
            gudangStock[type][index].teamId = teamIdx;
            gudangStock[type][index].pendingDate = new Date().toLocaleString('id-ID');

            if(!teams[teamIdx].inventory) teams[teamIdx].inventory = [];
            teams[teamIdx].inventory.push({ sn: item.sn, mac: item.mac });
            
            saveDataToFirebase();
            saveGudangToFirebase();
            
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.returnToWarehouse = function(type, index) {
        const item = gudangStock[type][index];
        const teamName = item.teamName;
        
        if(confirm(`Tarik kembali modem ${item.sn} dari ${teamName} ke Gudang?`)) {
            teams.forEach(t => {
                if(t.inventory) {
                    const invIndex = t.inventory.findIndex(inv => inv.sn === item.sn);
                    if(invIndex > -1) {
                        t.inventory.splice(invIndex, 1);
                    }
                }
            });

            gudangStock[type][index].status = 'ready';
            gudangStock[type][index].teamName = '';
            gudangStock[type][index].teamId = null;
            gudangStock[type][index].pendingDate = null;

            saveDataToFirebase();
            saveGudangToFirebase();
            
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.openStockModal = function(teamIndex) {
        let pin = prompt("üîí Masukkan PIN untuk Input Stok Manual:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        document.getElementById('stock-team-index').value = teamIndex;
        document.getElementById('stock-sn').value = '';
        document.getElementById('stock-mac').value = '';
        document.getElementById('modalStock').style.display = "block";
    }

    window.closeStockModal = function() {
        document.getElementById('modalStock').style.display = "none";
    }

    window.saveStockToTeam = function() {
        const idx = document.getElementById('stock-team-index').value;
        const sn = document.getElementById('stock-sn').value;
        const mac = document.getElementById('stock-mac').value;

        if(!sn || !mac) { alert("SN dan Mac harus diisi!"); return; }

        if(!teams[idx].inventory) teams[idx].inventory = [];
        
        teams[idx].inventory.push({ sn: sn, mac: mac });
        saveDataToFirebase();
        closeStockModal();
        alert("‚úÖ Stok Modem berhasil ditambahkan!");
    }

    window.openStockListModal = function(teamIndex) {
        const team = teams[teamIndex];
        const tbody = document.getElementById('stock-table-body');
        const title = document.getElementById('stock-list-title');
        const emptyMsg = document.getElementById('stock-empty-msg');
        
        title.innerText = team.teamName;
        tbody.innerHTML = '';

        if (!team.inventory || team.inventory.length === 0) {
            emptyMsg.style.display = 'block';
        } else {
            emptyMsg.style.display = 'none';
            team.inventory.forEach((item, stockIdx) => {
                const tr = document.createElement('tr');
                
                const status = getModemStatusGlobal(item.sn);
                let displaySN = item.sn;
                let displayAction = `<button class="btn-icon-del" onclick="deleteStock(${teamIndex}, ${stockIdx})">üóëÔ∏è</button>`;

                if(status === 'installed') {
                     displaySN = `<span style="text-decoration:line-through; color:red;">${item.sn}</span> <span class="badge badge-psb">Terpasang</span>`;
                     displayAction = `<span style="font-size:0.8em; color:#ccc;">Locked</span>`;
                } else if(status === 'bad') {
                     displaySN = `<span style="text-decoration:line-through; color:darkred;">${item.sn}</span> <span class="badge badge-reset" style="background:red; color:white;">BAD</span>`;
                     displayAction = `<span style="font-size:0.8em; color:#ccc;">Locked</span>`;
                }

                tr.innerHTML = `
                    <td style="text-align:center;">${stockIdx + 1}</td>
                    <td>${displaySN}</td>
                    <td>${item.mac}</td>
                    <td style="text-align:center;">
                        ${displayAction}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        document.getElementById('modalStockList').style.display = 'block';
    }

    window.closeStockListModal = function() {
        document.getElementById('modalStockList').style.display = "none";
    }

    window.deleteStock = function(teamIndex, stockIndex) {
        let pin = prompt("üîí Masukkan PIN untuk Hapus Stok Modem:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        teams[teamIndex].inventory.splice(stockIndex, 1);
        saveDataToFirebase();
        openStockListModal(teamIndex);
    }

    window.fillModemData = function(selectEl, teamIdx, jobIdx) {
        const val = selectEl.value;
        if(val === "" || val === "manual") return; 

        const parts = val.split("|");
        const sn = parts[0];
        const mac = parts[1];

        let vlanMac = "";
        try {
            const sep = mac.includes('-') ? '-' : ':';
            const macParts = mac.split(sep);
            
            if(macParts.length === 6) {
                let lastByte = parseInt(macParts[5], 16);
                lastByte = lastByte + 1;
                lastByte = lastByte % 256;
                let newLastPart = lastByte.toString(16).toUpperCase().padStart(2, '0');
                macParts[5] = newLastPart;
                vlanMac = macParts.join(sep);
            } else {
                vlanMac = mac; 
            }
        } catch(e) {
            vlanMac = mac;
            console.error("Error calculating vlan mac", e);
        }

        document.getElementById(`sn-${teamIdx}-${jobIdx}`).value = sn;
        document.getElementById(`mac-${teamIdx}-${jobIdx}`).value = mac;
        document.getElementById(`vlan-${teamIdx}-${jobIdx}`).value = vlanMac;

        if(!teams[teamIdx].jobs[jobIdx].technical) teams[teamIdx].jobs[jobIdx].technical = {};
        teams[teamIdx].jobs[jobIdx].technical['sn'] = sn;
        teams[teamIdx].jobs[jobIdx].technical['mac'] = mac;
        teams[teamIdx].jobs[jobIdx].technical['vlan'] = vlanMac;
        
        saveDataToFirebase();
    }

    function updateProgressUI(teamId, jobs) {
        const total = jobs.length;
        const checked = jobs.filter(j => j.completed).length;
        const percent = (total === 0) ? 0 : (checked / total) * 100;
        const bar = document.getElementById(`progress-${teamId}`);
        const txt = document.getElementById(`count-${teamId}`);
        if(bar) bar.style.width = percent + '%';
        if(txt) txt.innerText = `${checked}/${total} Selesai`;
    }

    window.deleteTicket = function(teamIndex, jobIndex) {
        let pin = prompt("üîê Masukkan PIN untuk menghapus tiket:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        teams[teamIndex].jobs.splice(jobIndex, 1);
        saveDataToFirebase();
    }

    window.generateFromText = function() {
        const raw = document.getElementById('psb-raw-text').value;
        if (!raw) { alert("Paste data dulu!"); return; }

        function getValue(label) {
            const regex = new RegExp(label + "\\s*[:=]\\s*(.*)", "i");
            const match = raw.match(regex);
            return match ? match[1].trim() : "";
        }

        document.getElementById('psb-nama').value = getValue("Nama Lengkap");
        document.getElementById('psb-alamat').value = getValue("Alamat Lengkap");
        document.getElementById('psb-email').value = getValue("Email Aktif");
        document.getElementById('psb-wa').value = getValue("No. WA");
        document.getElementById('psb-paket').value = getValue("Paket Layanan");
        document.getElementById('psb-ktp').value = getValue("No KTP");
        document.getElementById('psb-tgl').value = getValue("Tanggal Pemasangan");
        
        const statusRaw = getValue("Status kepemilikan rumah").toLowerCase();
        const selectStatus = document.getElementById('psb-status');
        if (statusRaw.includes("sewa") || statusRaw.includes("kontrak")) { selectStatus.value = "Sewa/Kontrak"; } 
        else if (statusRaw.includes("kost")) { selectStatus.value = "Kost"; } 
        else { selectStatus.value = "Pribadi"; }
        alert("‚úÖ Data PSB berhasil di-generate ke form!");
    }

    window.generateFromTextMT = function() {
        const raw = document.getElementById('mt-raw-text').value;
        if (!raw) { alert("Paste data MT dulu!"); return; }

        function getValue(label) {
            const regex = new RegExp(label + "\\s*[:=]\\s*(.*)", "i");
            const match = raw.match(regex);
            return match ? match[1].trim() : "";
        }

        const nama = getValue("Nama Pelanggan") || getValue("Nama");
        if(nama) document.getElementById('mt-nama').value = nama;
        const kendala = getValue("Kendala") || getValue("Keluhan") || getValue("Tag");
        if(kendala) document.getElementById('mt-tag').value = kendala;
        else document.getElementById('mt-tag').value = "MT"; 
        const layanan = getValue("No Layanan") || getValue("ID Pelanggan") || getValue("ID");
        if(layanan) document.getElementById('mt-layanan').value = layanan;
        const telp = getValue("No Telp") || getValue("No WA") || getValue("CP") || getValue("Contact");
        if(telp) document.getElementById('mt-telp').value = telp;
        const tgl = getValue("Tanggal Daftar") || getValue("Tanggal Lapor") || getValue("Tanggal");
        if(tgl) document.getElementById('mt-tgl').value = tgl;
        const cov = getValue("Coverage") || getValue("Area") || getValue("Cover");
        if(cov) document.getElementById('mt-coverage').value = cov;
        const alamat = getValue("Alamat") || getValue("Alamat Lengkap") || getValue("Lokasi");
        if(alamat) document.getElementById('mt-alamat').value = alamat;
        alert("‚úÖ Data MT berhasil di-generate ke form!");
    }

    window.addTicketToTeam = function() {
        const t1 = document.getElementById('tech-1').value;
        const t2 = document.getElementById('tech-2').value;

        if(!t1) { alert("Pilih minimal Teknisi 1!"); return; }

        let selectedMembers = [t1.toLowerCase()];
        if(t2 && t2 !== "") selectedMembers.push(t2.toLowerCase());
        selectedMembers.sort(); 

        let targetTeamIndex = teams.findIndex(team => {
            return JSON.stringify(team.members.sort()) === JSON.stringify(selectedMembers);
        });

        if (targetTeamIndex === -1) {
            const newId = Date.now(); 
            const colorIndex = (teams.length) % extraColors.length; 
            
            const usedNumbers = teams.map(t => {
                const match = t.teamName.match(/Tim\s+(\d+)/i);
                return match ? parseInt(match[1]) : 0;
            });
            
            let nextNum = 1;
            while (usedNumbers.includes(nextNum)) {
                nextNum++;
            }
            
            const teamNameStr = `Tim ${nextNum}: ${t1}${t2 ? ' & '+t2 : ''}`;

            const newTeamObj = {
                id: newId,
                teamName: teamNameStr,
                colorClass: extraColors[colorIndex] || "bg-dark",
                members: selectedMembers,
                jobs: [],
                inventory: []
            };
            teams.push(newTeamObj);
            targetTeamIndex = teams.length - 1;
        }
        
        let newJob = {};
        if(currentTab === 'psb') {
            const nama = document.getElementById('psb-nama').value || "Tanpa Nama";
            const jam = document.getElementById('psb-jam').value || "FLEXIBEL";
            const alamat = document.getElementById('psb-alamat').value || "-";
            const email = document.getElementById('psb-email').value;
            const wa = document.getElementById('psb-wa').value;
            const paket = document.getElementById('psb-paket').value;
            const ktp = document.getElementById('psb-ktp').value;
            const tgl = document.getElementById('psb-tgl').value;
            const status = document.getElementById('psb-status').value;

            newJob = {
                completed: false,
                completedAt: null, 
                technical: {},
                name: nama,
                tag: `PSB (${paket})`,
                tagClass: "badge-psb",
                time: jam,
                address: alamat,
                details: { "Paket": paket, "Email": email, "No WA": wa, "No KTP": ktp, "Status": status, "Tgl Pasang": tgl }
            };
        } else {
            const nama = document.getElementById('mt-nama').value || "Tanpa Nama";
            const layanan = document.getElementById('mt-layanan').value;
            const tag = document.getElementById('mt-tag').value || "MT (LAIN)";
            const telp = document.getElementById('mt-telp').value;
            const tgl = document.getElementById('mt-tgl').value;
            const coverage = document.getElementById('mt-coverage').value;
            const alamat = document.getElementById('mt-alamat').value || "-";

            newJob = {
                completed: false,
                completedAt: null,
                technical: {},
                name: nama,
                tag: tag,
                tagClass: "badge-mt", 
                time: "FLEXIBEL",
                address: alamat,
                details: { "Layanan": layanan, "No Telp": telp, "Tgl Daftar": tgl, "Coverage": coverage }
            };
        }

        teams[targetTeamIndex].jobs.push(newJob);
        saveDataToFirebase();
        closeModal();
        alert(`‚úÖ Tiket berhasil disimpan permanen ke ${teams[targetTeamIndex].teamName}`);
    }

    function parseAddress(addr) {
        const rtMatch = addr.match(/RT\s*[\.\:\-\/]?\s*0?(\d+)/i);
        const rwMatch = addr.match(/RW\s*[\.\:\-\/]?\s*0?(\d+)/i);
        const kelMatch = addr.match(/Kel\.?\s*([A-Za-z\s]+)/i);
        return {
            rt: rtMatch ? rtMatch[1] : '-',
            rw: rwMatch ? rwMatch[1] : '-',
            kel: kelMatch ? kelMatch[1] : '-'
        };
    }

    window.toggleDetails = function(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "block") ? "none" : "block";
    };

    window.copyData = async function(teamIndex, jobIndex, btn) {
        const team = teams[teamIndex];
        const job = team.jobs[jobIndex];
        const d = job.details;
        const tech = job.technical || {};
        const isPSB = job.tag.toUpperCase().includes("PSB");
        let textToCopy = "";

        if (isPSB) {
            const snVal = tech.sn || '-';
            const macVal = tech.mac || '-';
            const vlanVal = tech.vlan || '-';
            const kabelVal = tech.kabel || '-';
            const portVal = tech.port || '-';
            const odpVal = tech.odp || '-';
            const redamanVal = tech.redaman || '-';
            
            textToCopy = `TEKNISI : ${team.teamName}
KATEGORI : ${job.tag}
--------------------------------
Nama Lengkap : ${job.name} ( JAM ${job.time} )
Alamat Lengkap : ${job.address}
Email Aktif: ${d['Email'] || '-'}
No. Wa: ${d['No WA'] || d['No Telp'] || '-'}
Paket Layanan : ${d['Paket'] || '-'}
Biaya regist : -
No KTP : ${d['No KTP'] || '-'}
Tanggal/Jam Pemasangan : ${job.time === 'FLEXIBEL' ? 'FLEXIBEL' : 'Sesuai Jadwal'}
Refrensi SRB dari : ${d['Status'] || '-'}
FOTO Depan Rumah :

--- DATA TEKNIS ---
kode SN : ${snVal}
Mac : ${macVal}
Mac vlan : ${vlanVal}
Panjang kabel : ${kabelVal}
Port : ${portVal}
Id ODP : ${odpVal}
Redaman : ${redamanVal}`;
        } else {
            textToCopy = `TEKNISI : ${team.teamName}
KATEGORI : ${job.tag}
--------------------------------
Nama Pelanggan : ${job.name}
No Layanan : ${d['Layanan']||'-'}
No Telp. : ${d['No Telp']||'-'}
Tanggal Daftar : ${d['Tgl Daftar']||'-'}
Coverage : ${d['Coverage']||'-'}
Alamat : ${job.address}`;
        }
        copyToClipboard(textToCopy, btn);
    };

    window.copyAllSummary = function() {
        let summaryText = `üìã *MONITORING TEKNISI SINYALKU*\nüìÖ ${new Date().toLocaleDateString('id-ID')}\n\n`;
        teams.forEach(team => {
            summaryText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüõ†Ô∏è *${team.teamName.toUpperCase()}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            team.jobs.forEach((job, index) => {
                const statusText = job.completed ? "‚úÖ SELESAI" : "‚è≥ PENDING";
                const phone = job.details['No WA'] || job.details['No Telp'] || '-';
                summaryText += `*${index + 1}. ${job.name}*\n   üì± ${phone} | üìç ${job.address}\n   üè∑Ô∏è ${job.tag} | ${statusText}\n\n`;
            });
        });
        const btn = document.querySelector('.btn-copy-all');
        copyToClipboard(summaryText, btn, "‚úÖ Rekap Tersalin!");
    };

    window.downloadExcel = function() {
        let dataToExport = [];
        const todayStr = new Date().toLocaleDateString('id-ID');
        teams.forEach(team => {
            const rawTechName = team.teamName.split(':')[1]?.trim() || team.teamName;
            team.jobs.forEach((job, index) => {
                const d = job.details;
                const tech = job.technical || {};
                const addressParts = parseAddress(job.address);
                let kelurahan = d['Coverage']?.replace('Kel. ', '') || addressParts.kel;
                if(kelurahan === '-') { 
                    if(job.address.includes("Jatinegara")) kelurahan = "Jatinegara";
                    if(job.address.includes("Cipinang")) kelurahan = "Cipinang";
                }
                dataToExport.push({
                    "No Layanan": d['No Layanan'] || d['Layanan'] || "-",
                    "Nama Pelanggan": job.name,
                    "Status Pengerjaan": job.completed ? "Selesai" : "Pending",
                    "Nomor Telpon": d['No WA'] || d['No Telp'] || "-",
                    "Tanggal Selesai Kunjungan": job.completed ? (job.completedAt || todayStr) : "-",
                    "Nama Teknisi": rawTechName,
                    "Alamat Lengkap": job.address,
                    "RT": addressParts.rt,
                    "RW": addressParts.rw,
                    "Area Kelurahan": kelurahan,
                    "SN": tech.sn || "-"
                });
            });
        });
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wscols = [{wch: 15}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 40}, {wch: 5}, {wch: 5}, {wch: 15}, {wch: 20}];
        ws['!cols'] = wscols;
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan Teknisi");
        XLSX.writeFile(wb, "Laporan_Teknisi_Sinyalku.xlsx");
    };

    async function copyToClipboard(text, btnElement, successMsg = "‚úÖ Tersalin!") {
        let success = false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try { await navigator.clipboard.writeText(text); success = true; } catch (err) {}
        }
        if (!success) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px"; 
                document.body.appendChild(textArea);
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) success = true;
            } catch (err) {}
        }
        if (success && btnElement) {
            const originalText = btnElement.innerHTML;
            const originalBg = btnElement.style.backgroundColor;
            btnElement.innerHTML = successMsg;
            btnElement.style.backgroundColor = "#28a745"; 
            setTimeout(() => {
                btnElement.innerHTML = originalText;
                btnElement.style.backgroundColor = originalBg;
            }, 2000);
        }
    }

    let currentTab = 'psb';
    window.openModal = function() {
        let pin = prompt("üîí Masukkan PIN untuk membuat tiket:");
        if (pin !== "240525") { alert("‚ùå PIN SALAH! Akses ditolak."); return; }
        populateTechSelect(); 
        document.getElementById("modalTicket").style.display = "block";
    }
    function populateTechSelect() {
        const s1 = document.getElementById('tech-1');
        const s2 = document.getElementById('tech-2');
        if (s1.options.length > 0) return; 
        techList.forEach(name => {
            s1.add(new Option(name, name));
            s2.add(new Option(name, name));
        });
        s1.selectedIndex = 0; s2.value = ""; 
    }
    window.closeModal = function() { document.getElementById("modalTicket").style.display = "none"; }
    window.onclick = function(event) { 
        if (event.target == document.getElementById("modalTicket")) closeModal();
        if (event.target == document.getElementById("modalStock")) closeStockModal();
        if (event.target == document.getElementById("modalStockList")) closeStockListModal();
        if (event.target == document.getElementById("modalGudang")) closeGudangModal();
        if (event.target == document.getElementById("modalBulk")) closeBulkModal();
    }
    window.switchTab = function(tab) {
        currentTab = tab;
        const btns = document.querySelectorAll('.tab-header .tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(tab === 'psb') {
            document.querySelectorAll('.tab-header .tab-btn')[0].classList.add('active');
            document.getElementById('form-psb').style.display = 'block';
            document.getElementById('form-mt').style.display = 'none';
        } else {
            document.querySelectorAll('.tab-header .tab-btn')[1].classList.add('active');
            document.getElementById('form-psb').style.display = 'none';
            document.getElementById('form-mt').style.display = 'block';
        }
    }

    loadFirebaseData();
</script>

</body>
</html>
