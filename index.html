<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi Sinyalku - Online Realtime</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- RESET & BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f9; 
            padding: 10px; 
            color: #333; 
            margin: 0; 
            font-size: 14px;
        }
        
        /* --- LAYOUT CONTAINER --- */
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            width: 100%;
        }

        /* --- HEADER SECTION --- */
        .header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            text-align: center;
        }
        
        h1 { 
            color: #2c3e50; 
            margin: 0 0 15px 0; 
            font-size: 1.5rem; 
            line-height: 1.3; 
        }

        .btn-group-header {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-action-main {
            color: white; border: none;
            padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s, background 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-copy-all { background-color: #17a2b8; }
        .btn-excel { background-color: #217346; } /* Warna Hijau Excel */

        .btn-action-main:active { transform: scale(0.95); }

        /* --- CARD TEAMS --- */
        .team-card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            margin-bottom: 20px; 
            overflow: hidden; 
            border: 1px solid #e1e4e8; 
        }
        
        .team-header { 
            padding: 15px; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 1rem;
        }

        .header-team1 { background: linear-gradient(135deg, #007bff, #0056b3); } 
        .header-team2 { background: linear-gradient(135deg, #28a745, #1e7e34); } 
        .header-team3 { background: linear-gradient(135deg, #dc3545, #bd2130); }

        /* --- JOB LIST --- */
        .job-list { list-style: none; padding: 0; margin: 0; }
        .job-item { 
            border-bottom: 1px solid #eee; 
            padding: 15px; 
            transition: background 0.2s; 
        }
        .job-item:last-child { border-bottom: none; }

        /* --- JOB ROW LAYOUT --- */
        .job-main-row { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 12px; 
            justify-content: space-between;
        }

        .job-left { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            flex: 1 1 60%; 
            min-width: 250px;
        }

        .custom-checkbox { 
            width: 24px; height: 24px; 
            cursor: pointer; accent-color: #28a745; 
            flex-shrink: 0; 
            margin-top: 2px;
        }

        .customer-info h3 { 
            margin: 0; font-size: 1.05rem; color: #2c3e50; line-height: 1.4;
        }
        .customer-info p { 
            margin: 4px 0 0; font-size: 0.9rem; color: #666; 
        }

        /* --- BADGES --- */
        .badge { 
            padding: 4px 8px; border-radius: 6px; 
            font-size: 0.75rem; font-weight: bold; 
            text-transform: uppercase; display: inline-block; 
            margin-top: 4px;
        }
        .badge-psb { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .badge-mt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-los { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .badge-prio { background-color: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; }
        .badge-info { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }

        /* --- ACTION BUTTONS --- */
        .action-buttons { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        
        .toggle-btn, .btn-copy { 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            cursor: pointer;
            white-space: nowrap;
            flex: 1; 
            text-align: center;
        }

        .toggle-btn { background: #f0f7ff; border: 1px solid #007bff; color: #007bff; }
        .btn-copy { background: #fff5eb; border: 1px solid #fd7e14; color: #fd7e14; }

        /* --- DETAILS SECTION --- */
        .job-details { 
            display: none; 
            margin-top: 15px; 
            background-color: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #e9ecef;
        }

        .detail-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 12px; 
            margin-bottom: 15px; 
        }
        
        .detail-item { 
            background: white; 
            padding: 8px; 
            border-radius: 4px; 
            border: 1px solid #eee; 
        }
        .detail-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px;}
        .detail-value { font-size: 0.95rem; color: #333; font-weight: 500; word-break: break-word; }

        /* --- MANUAL INPUT FORM --- */
        .manual-input-section { 
            background-color: #fff; 
            border: 1px solid #dfe6ed; 
            padding: 15px; 
            border-radius: 8px; 
        }
        .input-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        @media (max-width: 600px) {
            .input-grid { grid-template-columns: 1fr; }
        }

        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .input-group input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 5px; 
            font-size: 1rem; 
        }

        /* --- PROGRESS & COMPLETED STATE --- */
        .progress-container { height: 6px; background: #e9ecef; width: 100%; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease; }
        
        .job-item.completed { background-color: #f6fff9; opacity: 0.8; }
        .job-item.completed .customer-info h3 { text-decoration: line-through; color: #999; }

        /* --- RESET BUTTON --- */
        .btn-reset { 
            background-color: #6c757d; color: white; border: none; 
            padding: 12px; border-radius: 8px; cursor: pointer; 
            font-size: 1rem; width: 100%; display: block; margin-top: 30px; margin-bottom: 50px;
        }

        /* --- STATUS CONNECTION --- */
        #connection-status {
            font-size: 0.75rem; color: #888; margin-top: 5px;
        }

        /* --- MEDIA QUERIES (KHUSUS HP) --- */
        @media (max-width: 576px) {
            body { padding: 5px; background-color: #fff; }
            .container { padding: 0; }
            .team-card { border-radius: 0; border-left: none; border-right: none; box-shadow: none; border-bottom: 2px solid #eee; }
            
            .header-section { margin: 15px 10px; }
            
            .job-main-row { flex-direction: column; align-items: flex-start; }
            .job-left { width: 100%; }
            .action-buttons { width: 100%; margin-top: 10px; }
            .toggle-btn, .btn-copy { width: 100%; padding: 10px; }
            
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>
            üìã Monitoring Teknisi<br>
            <span style="font-size: 0.6em; color: green; display: block; margin-top:5px;">Online Realtime ‚Ä¢ Update Terbaru</span>
            <div id="connection-status">Connecting to server...</div>
        </h1>
        <div class="btn-group-header">
            <button class="btn-action-main btn-copy-all" onclick="copyAllSummary()">üìë Copy Rekap</button>
            <button class="btn-action-main btn-excel" onclick="downloadExcel()">üìä Download Excel</button>
        </div>
    </div>

    <div class="team-card">
        <div class="team-header header-team2">
            <span>Tim 1: Kholis & Dani</span>
            <span id="count-1" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-1"></div></div>
        <ul class="job-list" id="list-1"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team1">
            <span>Tim 2: Yudha & Bimo</span>
            <span id="count-2" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-2"></div></div>
        <ul class="job-list" id="list-2"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team3">
            <span>Tim 3: Pian</span>
            <span id="count-3" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-3"></div></div>
        <ul class="job-list" id="list-3"></ul>
    </div>

    <div style="padding: 0 15px;">
        <button class="btn-reset" onclick="resetAll()">üîÑ Reset Data (Hapus Database)</button>
    </div>
</div>

<script type="module">
    // Import Firebase dari CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
      authDomain: "monitoring-3aeb6.firebaseapp.com",
      databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
      projectId: "monitoring-3aeb6",
      storageBucket: "monitoring-3aeb6.firebasestorage.app",
      messagingSenderId: "888117973644",
      appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
      measurementId: "G-PTL0F1FPK0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'monitoring_data_7jan'); // Path Database

    // --- DATA STATIS (JOB LIST) ---
    const teams = [
        {
            id: 1, 
            teamName: "Tim 1: Kholis & Dani",
            jobs: [
                { name: "TIARA FAJRINI", tag: "PSB (150rb)", tagClass: "badge-psb", time: "11:00", address: "Jl Tipar Cakung GG Toge RT 05 RW 05 (Samping Mushola Al Ikhlas)", details: { "Paket": "150k + Regis 50k", "Email": "mmjani8686@gmail.com", "Ref": "Abdul Azis", "No WA": "085211594767", "Status": "Ngontrak", "No KTP": "3172036309940009" } },
                { name: "VIA KURNIAWATI", tag: "MT (LOS - PRIO)", tagClass: "badge-los", time: "11:00", address: "Jatinegara, Kota Jakarta Timur (Status: Sewa)", details: { "Kendala": "Baru pasang LOS, Kunjungan Prioritas", "No Layanan": "1393005746", "Masa Aktif": "s/d 04 Feb 2026", "Tgl Daftar": "04 Jan 2026", "Coverage": "Kel. Jatinegara" } },
                { name: "PIPI MARINI SIADARI", tag: "MT (RAPIH KABEL)", tagClass: "badge-info", time: "FLEXIBEL", address: "Perumahan Jatinegara Indah, Jl Gn Kerinci RT 10/RW 09", details: { "Action": "Rapihin Kabel", "Patokan": "Pabrik Tahu, Rmh Indri/Intan", "Layanan": "1393003676", "No Telp": "082128581525", "Tgl Pasang": "04 Mei 2025" } },
                { name: "ARDY KADRI", tag: "PSB (GAMER)", tagClass: "badge-psb", time: "13:00", address: "Jl Al Kautsar RT 09 RW 13 No.28", details: { "Catatan": "Cek lokasi! Info jauh dr jaringan", "Paket": "Gamer", "Email": "ardhy.1010@gmail.com", "No WA": "081282862606", "Status": "Sewa", "No KTP": "3175081204900011" } },
                { name: "SINTIA AULIA", tag: "PSB (100rb)", tagClass: "badge-psb", time: "15:00", address: "Jl. Kali Buaran Rt4/Rw4", details: { "Paket": "100k + Regis 150k", "Email": "sintiaa1303@gmail.com", "No WA": "085772353371", "Status": "Pribadi", "No KTP": "3175065303051002" } },
                { name: "PIPIT", tag: "PSB (150rb)", tagClass: "badge-psb", time: "17:00", address: "Kp. Rawa Badung", details: { "Catatan": "Bisa Sore", "Paket": "150 rb", "Email": "daoedzka2020@gmail.com", "Status": "Pribadi", "No WA": "087874787808" } }
            ]
        },
        {
            id: 2, 
            teamName: "Tim 2: Yudha & Bimo",
            jobs: [
                { name: "SITI ALFIAH", tag: "PSB (190mbps)", tagClass: "badge-psb", time: "11:00", address: "Cipinang Muara 04/03", details: { "Paket": "190 mbps", "No WA": "085659650190", "No KTP": "3171055402870002" } },
                { name: "ACHMAD FIRDAUS", tag: "PSB (SRB)", tagClass: "badge-psb", time: "13:00", address: "Jl. Lio 2 RT. 03 RW. 04 No. 15", details: { "Paket": "SRB 150k upto 100mbps", "Biaya Regis": "50k", "Email": "achmadirsyadfirfaus@gmail.com", "Ref SRB": "Bapak OMIN (Ketua RT 03)", "No KTP": "3175030303941001" } },
                { name: "ALFAN MUCHIBAH", tag: "EXTEND (+70rb)", tagClass: "badge-prio", time: "15:00", address: "Kampung Sumur RT 06/010 No.75 Duren Sawit", details: { "PENTING": "Pastikan pelanggan tau extend +70rb/bln", "Layanan": "1347005769", "Masa Aktif": "s/d 05 Feb 2026", "Status": "Pribadi", "No Telp": "085959869023" } },
                { name: "IKHSAN AZIS SULTHONI", tag: "PINDAH RUMAH", tagClass: "badge-mt", time: "17:00", address: "Jln Dermaga Raya, Gg Kembar RT 04/17 No 17", details: { "Layanan": "1347004489", "Status": "Ngontrak (sudah 4 thn)", "Masa Aktif": "s/d 21 Jan 2026", "No Telp": "088976121346" } }
            ]
        },
        {
            id: 3, 
            teamName: "Tim 3: Pian",
            jobs: [
                { name: "HAIKAL ADMAJA M.", tag: "PSB (LATE 3 JAN)", tagClass: "badge-psb", time: "12:00", address: "Jl Raya Penggilingan Gg Aim Blok Vi No. 249", details: { "Patokan": "Bidan Ucu", "Paket": "150k + Regis 50k", "No WA": "6281511280707", "Status": "Sewa", "Tgl Pasang": "3 Jan 2025" } },
                { name: "SUSWATI", tag: "MT (AMBIL MODEM)", tagClass: "badge-los", time: "FLEXIBEL", address: "Kp Pulojahe RT 11 RW 14", details: { "Action": "Ambil Modem", "Layanan": "0607115000", "No Telp": "085697891053", "Tgl Daftar": "06 Jan 2023" } }
            ]
        }
    ];

    // --- RENDER HTML ---
    function renderJobs() {
        teams.forEach(team => {
            const listContainer = document.getElementById(`list-${team.id}`);
            listContainer.innerHTML = ''; 

            team.jobs.forEach((job, index) => {
                const li = document.createElement('li');
                li.className = 'job-item';
                
                let detailHTML = '';
                for (const [key, value] of Object.entries(job.details)) {
                    detailHTML += `<div class="detail-item"><span class="detail-label">${key}</span><span class="detail-value">${value}</span></div>`;
                }

                const uniqueId = `details-${team.id}-${index}`;
                const checkboxId = `chk-${team.id}-${index}`;
                const isPSB = job.tag.toUpperCase().includes("PSB");

                let formHTML = '';
                if (isPSB) {
                    formHTML = `
                    <div class="manual-input-section">
                        <h4 style="margin:0 0 15px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìù Input Data Teknis</h4>
                        <div class="input-grid">
                            <div class="input-group"><label>Kode SN</label><input type="text" class="realtime-input" id="sn-${team.id}-${index}" placeholder="ZTEGC..."></div>
                            <div class="input-group"><label>Mac</label><input type="text" class="realtime-input" id="mac-${team.id}-${index}" placeholder="A1:B2..."></div>
                            <div class="input-group"><label>Mac vlan</label><input type="text" class="realtime-input" id="vlan-${team.id}-${index}" placeholder="Vlan.."></div>
                            <div class="input-group"><label>Panjang kabel</label><input type="text" class="realtime-input" id="kabel-${team.id}-${index}" placeholder="150m"></div>
                            <div class="input-group"><label>Port</label><input type="text" class="realtime-input" id="port-${team.id}-${index}" placeholder="2"></div>
                            <div class="input-group"><label>Id ODP</label><input type="text" class="realtime-input" id="odp-${team.id}-${index}" placeholder="ODP-.."></div>
                            <div class="input-group" style="grid-column: 1/-1;"><label>Redaman</label><input type="text" class="realtime-input" id="redaman-${team.id}-${index}" placeholder="-18 dBm"></div>
                        </div>
                    </div>`;
                }

                li.innerHTML = `
                    <div class="job-main-row">
                        <div class="job-left">
                            <input type="checkbox" id="${checkboxId}" class="custom-checkbox">
                            <div class="customer-info">
                                <h3>${job.name} <span class="badge ${job.tagClass}">${job.tag}</span></h3>
                                <p>üìç ${job.address}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyData(${team.id}, ${index}, this)">üìã Copy</button>
                            <button class="toggle-btn" onclick="toggleDetails('${uniqueId}')">üîΩ Detail</button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="job-details">
                        <div class="detail-grid">
                            <div class="detail-item"><span class="detail-label">Jadwal</span><span class="detail-value">${job.time}</span></div>
                            ${detailHTML}
                        </div>
                        ${formHTML}
                    </div>
                `;
                listContainer.appendChild(li);

                // Add Event Listeners for Realtime Sync
                const checkbox = document.getElementById(checkboxId);
                checkbox.addEventListener('change', (e) => {
                    updateFirebase(checkboxId, e.target.checked);
                });

                if(isPSB) {
                    const inputs = li.querySelectorAll('.realtime-input');
                    inputs.forEach(input => {
                        input.addEventListener('input', (e) => {
                            updateFirebase(e.target.id, e.target.value);
                        });
                    });
                }
            });
        });
    }

    // --- FIREBASE SYNC FUNCTIONS ---
    function updateFirebase(id, value) {
        // Simpan data dalam struktur { id_elemen : value }
        update(dbRef, {
            [id]: value
        });
    }

    // LISTENER UTAMA: Baca data dari Firebase Realtime
    onValue(dbRef, (snapshot) => {
        document.getElementById('connection-status').innerText = "‚úÖ Terhubung Online";
        document.getElementById('connection-status').style.color = "green";
        
        const data = snapshot.val();
        if (data) {
            // Loop semua elemen yang tersimpan di DB
            for (const [key, value] of Object.entries(data)) {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = value;
                        const li = el.closest('.job-item');
                        value ? li.classList.add('completed') : li.classList.remove('completed');
                    } else {
                        // Untuk text input
                        el.value = value;
                    }
                }
            }
        } else {
            // Jika DB kosong (reset), hilangkan semua centang/input
            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                box.checked = false;
                box.closest('.job-item').classList.remove('completed');
            });
            document.querySelectorAll('.realtime-input').forEach(inp => inp.value = '');
        }
        
        // Update Progress Bar UI
        teams.forEach(t => updateProgressUI(t.id));
    });

    function updateProgressUI(teamId) {
        const list = document.getElementById(`list-${teamId}`);
        const total = list.querySelectorAll('input[type="checkbox"]').length;
        const checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
        const percent = (total === 0) ? 0 : (checked / total) * 100;
        document.getElementById(`progress-${teamId}`).style.width = percent + '%';
        document.getElementById(`count-${teamId}`).innerText = `${checked}/${total} Selesai`;
    }

    // --- HELPER FUNCTION UNTUK PARSE ALAMAT ---
    function parseAddress(addr) {
        // Regex sederhana untuk mencari RT dan RW
        const rtMatch = addr.match(/RT\s*[\.\:\-\/]?\s*0?(\d+)/i);
        const rwMatch = addr.match(/RW\s*[\.\:\-\/]?\s*0?(\d+)/i);
        // Kelurahan biasanya setelah kata Kel. atau bisa diasumsikan dari data Coverage
        const kelMatch = addr.match(/Kel\.?\s*([A-Za-z\s]+)/i);

        return {
            rt: rtMatch ? rtMatch[1] : '-',
            rw: rwMatch ? rwMatch[1] : '-',
            kel: kelMatch ? kelMatch[1] : '-'
        };
    }

    // --- GLOBAL FUNCTIONS (Agar bisa dipanggil onclick HTML) ---
    
    window.toggleDetails = function(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "block") ? "none" : "block";
    };

    window.copyData = async function(teamId, jobIndex, btn) {
        const team = teams.find(t => t.id === teamId);
        const job = team.jobs[jobIndex];
        const d = job.details;
        const isPSB = job.tag.toUpperCase().includes("PSB");

        const email = d['Email'] || '-';
        const wa = d['No WA'] || d['No Telp'] || '-';
        const paket = d['Paket'] || d['Layanan'] || '-'; 
        const regist = d['Biaya Regis'] || '-';
        const ktp = d['No KTP'] || '-';
        const refName = d['Ref SRB'] || d['Ref'] || '-';
        
        const headerInfo = `TEKNISI : ${team.teamName}\nKATEGORI : ${job.tag}\n--------------------------------`;

        let technicalData = '';
        if (isPSB) {
            // Ambil value langsung dari input element (sudah terisi via Firebase)
            const snVal = document.getElementById(`sn-${teamId}-${jobIndex}`).value || '-';
            const macVal = document.getElementById(`mac-${teamId}-${jobIndex}`).value || '-';
            const vlanVal = document.getElementById(`vlan-${teamId}-${jobIndex}`).value || '-';
            const kabelVal = document.getElementById(`kabel-${teamId}-${jobIndex}`).value || '-';
            const portVal = document.getElementById(`port-${teamId}-${jobIndex}`).value || '-';
            const odpVal = document.getElementById(`odp-${teamId}-${jobIndex}`).value || '-';
            const redamanVal = document.getElementById(`redaman-${teamId}-${jobIndex}`).value || '-';

            technicalData = `\n\n--- DATA TEKNIS ---
kode SN : ${snVal}
Mac : ${macVal}
Mac vlan : ${vlanVal}
Panjang kabel : ${kabelVal}
Port : ${portVal}
Id ODP : ${odpVal}
Redaman : ${redamanVal}`;
        }

        const textToCopy = `${headerInfo}
Nama Lengkap : ${job.name} ( JAM ${job.time} )
Alamat Lengkap : ${job.address}
Email Aktif: ${email}
No. Wa: ${wa}
Paket Layanan : ${paket}
Biaya regist : ${regist}
No KTP : ${ktp}
Tanggal/Jam Pemasangan : ${job.time === 'FLEXIBEL' ? 'FLEXIBEL' : 'Sesuai Jadwal'}
Refrensi SRB dari : ${refName}
FOTO Depan Rumah :${technicalData}`;

        copyToClipboard(textToCopy, btn);
    };

    window.copyAllSummary = function() {
        let summaryText = `üìã *MONITORING TEKNISI SINYALKU*\nüìÖ 7 Jan 2026\n\n`;

        teams.forEach(team => {
            summaryText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            summaryText += `üõ†Ô∏è *${team.teamName.toUpperCase()}*\n`; 
            summaryText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;

            team.jobs.forEach((job, index) => {
                const checkbox = document.getElementById(`chk-${team.id}-${index}`);
                const isChecked = checkbox ? checkbox.checked : false;
                const statusText = isChecked ? "‚úÖ SELESAI" : "‚è≥ PENDING";
                const d = job.details;
                const email = d['Email'];
                const phone = d['No WA'] || d['No Telp'] || '-';

                let line1 = `*${index + 1}. ${job.name}*`;
                if (email) { line1 += ` | ‚úâÔ∏è ${email}`; }
                let line2 = `   üì± ${phone} | üìç ${job.address}`;
                let line3 = `   üè∑Ô∏è ${job.tag} | ${statusText}`;

                summaryText += `${line1}\n${line2}\n${line3}\n\n`;
            });
        });

        summaryText += `_Generated by Monitoring System Online_`;
        const btn = document.querySelector('.btn-copy-all');
        copyToClipboard(summaryText, btn, "‚úÖ Rekap Tersalin!");
    };

    // --- FUNGSI BARU: DOWNLOAD EXCEL ---
    window.downloadExcel = function() {
        let dataToExport = [];
        const todayStr = new Date().toLocaleDateString('id-ID');

        teams.forEach(team => {
            // Ambil nama teknisi saja (hapus "Tim X: ")
            const rawTechName = team.teamName.split(':')[1]?.trim() || team.teamName;

            team.jobs.forEach((job, index) => {
                const d = job.details;
                
                // 1. Ambil Status Checkbox
                const checkbox = document.getElementById(`chk-${team.id}-${index}`);
                const isDone = checkbox ? checkbox.checked : false;
                const statusPengerjaan = isDone ? "Selesai" : "Pending";
                const tglSelesai = isDone ? todayStr : "-"; // Tanggal hari ini jika selesai

                // 2. Ambil SN (Jika ada input SN)
                const snInput = document.getElementById(`sn-${team.id}-${index}`);
                const snValue = snInput ? snInput.value : "-";

                // 3. Parse Alamat untuk RT/RW/Kelurahan
                const addressParts = parseAddress(job.address);
                // Cek apakah Kelurahan ada di details 'Coverage' atau hasil parse
                let kelurahan = d['Coverage']?.replace('Kel. ', '') || addressParts.kel;
                if(kelurahan === '-') { 
                    // Fallback kasar: ambil kata terakhir alamat jika mengandung "Jatinegara" dsb
                    if(job.address.includes("Jatinegara")) kelurahan = "Jatinegara";
                    if(job.address.includes("Cipinang")) kelurahan = "Cipinang";
                }

                // 4. Susun Baris Data sesuai Request
                const row = {
                    "No Layanan": d['No Layanan'] || d['Layanan'] || "-",
                    "Nama Pelanggan": job.name,
                    "Status Pengerjaan": statusPengerjaan,
                    "Nomor Telpon": d['No WA'] || d['No Telp'] || "-",
                    "Tanggal Selesai Kunjungan": tglSelesai,
                    "Nama Teknisi": rawTechName,
                    "Alamat Lengkap": job.address,
                    "RT": addressParts.rt,
                    "RW": addressParts.rw,
                    "Area Kelurahan": kelurahan,
                    "SN": snValue
                };
                
                dataToExport.push(row);
            });
        });

        // Buat Worksheet
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        
        // Atur Lebar Kolom (Optional, biar rapi)
        const wscols = [
            {wch: 15}, // No Lay
            {wch: 25}, // Nama
            {wch: 15}, // Status
            {wch: 15}, // Telp
            {wch: 15}, // Tgl
            {wch: 20}, // Teknisi
            {wch: 40}, // Alamat
            {wch: 5},  // RT
            {wch: 5},  // RW
            {wch: 15}, // Kelurahan
            {wch: 20}  // SN
        ];
        ws['!cols'] = wscols;

        // Buat Workbook dan Download
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan Teknisi");
        XLSX.writeFile(wb, "Laporan_Teknisi_Sinyalku.xlsx");
    };

    window.resetAll = function() {
        if(confirm("AWAS! Ini akan menghapus SEMUA data checklist & inputan teknis di Database Online untuk semua orang. Yakin?")) {
            set(dbRef, null).then(() => {
                alert("Database berhasil di-reset!");
            });
        }
    };

    async function copyToClipboard(text, btnElement, successMsg = "‚úÖ Tersalin!") {
        let success = false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try { await navigator.clipboard.writeText(text); success = true; } catch (err) {}
        }
        if (!success) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px"; 
                document.body.appendChild(textArea);
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) success = true;
            } catch (err) {}
        }

        if (success && btnElement) {
            const originalText = btnElement.innerHTML;
            const originalBg = btnElement.style.backgroundColor;
            
            btnElement.innerHTML = successMsg;
            btnElement.style.backgroundColor = "#28a745"; 
            if(btnElement.classList.contains('btn-copy')) {
                btnElement.style.borderColor = "#28a745"; 
                btnElement.style.color = "#fff";
                btnElement.style.backgroundColor = "#28a745";
            }

            setTimeout(() => {
                btnElement.innerHTML = originalText;
                btnElement.style.backgroundColor = originalBg;
                if(btnElement.classList.contains('btn-copy')) {
                    btnElement.style.borderColor = "#fd7e14"; 
                    btnElement.style.color = "#fd7e14";
                    btnElement.style.backgroundColor = "#fff5eb";
                }
            }, 2000);
        } else {
            alert("Gagal menyalin data. Silakan coba manual.");
        }
    }

    // Initialize Render
    renderJobs();
</script>

</body>
</html>
