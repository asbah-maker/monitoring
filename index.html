<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi - AI & Online</title>
    <style>
        /* --- CSS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; font-size: 14px; }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .header-section { text-align: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 10px 0; color: #1a73e8; font-size: 1.4rem; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .btn-ai { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); }
        .btn-copy-all { background: #00b894; }
        .btn:active { transform: scale(0.95); }

        /* Team Cards */
        .team-card { background: white; border-radius: 12px; margin-bottom: 15px; overflow: hidden; border: 1px solid #dfe6e9; }
        .team-header { padding: 12px 15px; color: white; display: flex; justify-content: space-between; font-weight: bold; }
        .th-1 { background: linear-gradient(135deg, #0984e3, #74b9ff); }
        .th-2 { background: linear-gradient(135deg, #00b894, #55efc4); }
        .th-3 { background: linear-gradient(135deg, #d63031, #ff7675); }

        /* Lists */
        ul { padding: 0; margin: 0; list-style: none; }
        .job-item { padding: 15px; border-bottom: 1px solid #f1f2f6; position: relative; }
        .job-item.completed { background: #f8f9fa; opacity: 0.7; }
        .job-item.completed h3 { text-decoration: line-through; color: #b2bec3; }

        .job-content { display: flex; gap: 10px; align-items: flex-start; }
        .check-box { width: 22px; height: 22px; margin-top: 3px; cursor: pointer; accent-color: #00b894; }
        
        .info h3 { margin: 0; font-size: 1rem; color: #2d3436; }
        .info p { margin: 4px 0 0; color: #636e72; font-size: 0.85rem; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; color: white; font-weight: bold; margin-left: 5px; vertical-align: middle; }
        .bg-psb { background: #0984e3; }
        .bg-mt { background: #e17055; }
        .bg-los { background: #d63031; }

        .actions { margin-top: 10px; display: flex; gap: 10px; }
        .act-btn { flex: 1; padding: 6px; border: 1px solid #dfe6e9; background: #f5f6fa; border-radius: 4px; cursor: pointer; font-size: 0.8rem; color: #636e72; }
        .btn-del { color: red; border-color: #fab1a0; background: #fff0f0; max-width: 60px;}

        /* Modal AI */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical; margin-bottom: 10px; }
        
        .ai-options { margin-bottom: 15px; }
        .ai-options label { font-weight: bold; display: block; margin-bottom: 5px; }
        .ai-options select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; }

        .preview-box { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px dashed #aaa; display: none; font-size: 0.85rem; }
        .loading { text-align: center; color: #667eea; font-weight: bold; display: none; }

        /* Status Bar */
        .status-bar { font-size: 0.75rem; text-align: center; margin-top: 5px; color: #aaa; }
        .status-online { color: green; font-weight: bold; }
        .status-offline { color: red; font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>üì° Monitoring Teknisi</h1>
        <div class="status-bar">Status Database: <span id="db-status">Menghubungkan...</span></div>
        <div class="btn-group" style="margin-top:15px;">
            <button class="btn btn-ai" onclick="openModal()">‚ú® Auto Input (AI)</button>
            <button class="btn btn-copy-all" onclick="copyRekap()">üìã Copy Rekap</button>
        </div>
    </div>

    <div id="teams-container"></div>
</div>

<div id="aiModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0;">ü§ñ AI Ticket Parser</h3>
            <span onclick="closeModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        
        <p style="font-size:0.9rem; color:#666;">Paste chat/tiket dari WA di bawah ini. AI akan merapikannya.</p>
        <textarea id="rawText" placeholder="Contoh: Pasang baru an. Budi jl mawar no 5 jam 10 paket 150rb..."></textarea>
        
        <div class="ai-options">
            <label>Masukkan ke Tim:</label>
            <select id="targetTeam">
                <option value="1">Tim 1: Kholis & Dani</option>
                <option value="2">Tim 2: Yudha & Bimo</option>
                <option value="3">Tim 3: Pian</option>
            </select>
        </div>

        <div id="loadingIndicator" class="loading">üîÑ Sedang Menganalisa...</div>
        <div id="aiPreview" class="preview-box"></div>

        <button id="btnAnalyze" class="btn btn-ai" style="width:100%; justify-content:center; margin-top:10px;" onclick="analyzeText()">üîç Analisa Teks</button>
        <button id="btnSave" class="btn btn-copy-all" style="width:100%; justify-content:center; margin-top:10px; display:none;" onclick="saveToFirebase()">üíæ Simpan ke Database</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. KONFIGURASI ---
    const firebaseConfig = {
        apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
        authDomain: "monitoring-3aeb6.firebaseapp.com",
        databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
        projectId: "monitoring-3aeb6",
        storageBucket: "monitoring-3aeb6.firebasestorage.app",
        messagingSenderId: "888117973644",
        appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
        measurementId: "G-PTL0F1FPK0"
    };

    const GEMINI_API_KEY = "AIzaSyB7MKdgP1gGSTUsfP2g-dPq_CtbBdPpEns"; 

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 2. STATE MANAGEMENT ---
    let localTeamsData = {
        1: { name: "Tim 1: Kholis & Dani", color: "th-1", jobs: {} },
        2: { name: "Tim 2: Yudha & Bimo", color: "th-2", jobs: {} },
        3: { name: "Tim 3: Pian", color: "th-3", jobs: {} }
    };
    let parsedResult = null; // Menyimpan hasil AI sementara

    // --- 3. DATABASE LISTENER (REALTIME) ---
    const dbStatus = document.getElementById('db-status');
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        if (snap.val() === true) {
            dbStatus.innerText = "Online ‚úÖ";
            dbStatus.className = "status-online";
        } else {
            dbStatus.innerText = "Offline ‚ùå";
            dbStatus.className = "status-offline";
        }
    });

    // Listen to 'tickets' node
    onValue(ref(db, 'tickets'), (snapshot) => {
        const data = snapshot.val();
        
        // Reset jobs local
        Object.keys(localTeamsData).forEach(k => localTeamsData[k].jobs = {});

        if (data) {
            // Mapping data firebase ke local structure
            Object.keys(data).forEach(teamId => {
                if(localTeamsData[teamId]) {
                    localTeamsData[teamId].jobs = data[teamId];
                }
            });
        }
        renderApp();
    });

    // --- 4. RENDER UI ---
    window.renderApp = function() {
        const container = document.getElementById('teams-container');
        container.innerHTML = '';

        Object.keys(localTeamsData).forEach(teamId => {
            const team = localTeamsData[teamId];
            const jobKeys = Object.keys(team.jobs);
            
            // Hitung progress
            let completed = 0;
            jobKeys.forEach(k => { if(team.jobs[k].checked) completed++; });
            
            let html = `
            <div class="team-card">
                <div class="team-header ${team.color}">
                    <span>${team.name}</span>
                    <span>${completed}/${jobKeys.length}</span>
                </div>
                <ul>`;

            if (jobKeys.length === 0) {
                html += `<li style="padding:15px; text-align:center; color:#ccc;">Belum ada tiket</li>`;
            } else {
                jobKeys.forEach(key => {
                    const job = team.jobs[key];
                    const bgBadge = job.tag.includes('PSB') ? 'bg-psb' : (job.tag.includes('LOS') ? 'bg-los' : 'bg-mt');
                    const isChecked = job.checked ? 'checked' : '';
                    const classCompleted = job.checked ? 'completed' : '';

                    html += `
                    <li class="job-item ${classCompleted}">
                        <div class="job-content">
                            <input type="checkbox" class="check-box" ${isChecked} onchange="toggleCheck('${teamId}', '${key}', this.checked)">
                            <div class="info" style="flex:1;">
                                <h3>${job.name} <span class="badge ${bgBadge}">${job.tag}</span></h3>
                                <p>üìç ${job.address}</p>
                                <p style="font-size:0.8rem; color:#888;">üïí ${job.time} | üìù ${job.details}</p>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="act-btn" onclick="copySingle('${job.name}', '${job.address}', '${job.tag}', '${job.details}')">üìã Copy</button>
                            <button class="act-btn btn-del" onclick="deleteJob('${teamId}', '${key}')">üóëÔ∏è Hapus</button>
                        </div>
                    </li>`;
                });
            }
            html += `</ul></div>`;
            container.innerHTML += html;
        });
    }

    // --- 5. LOGIC AI (GEMINI) ---
    window.analyzeText = async function() {
        const text = document.getElementById('rawText').value;
        if (!text) return alert("Isi teks dulu!");

        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('btnAnalyze').disabled = true;

        const prompt = `
        Analisa teks tiket teknisi berikut dan ekstrak menjadi format JSON.
        Teks: "${text}"
        
        Aturan Output JSON:
        {
          "name": "Nama Pelanggan (Huruf Besar)",
          "tag": "Jenis Tiket (contoh: PSB (150rb), MT (LOS), MT (GANGGUAN), UPGRADE)",
          "address": "Alamat Singkat",
          "time": "Jam (contoh: 10:00 atau FLEXIBEL)",
          "details": "Detail lain seperti No HP, Paket, atau Keterangan (gabungkan jadi satu string pendek)"
        }
        Hanya kembalikan JSON valid tanpa markdown.
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            
            // Bersihkan markdown jika ada (```json ... ```)
            const cleanJson = aiText.replace(/```json|```/g, '').trim();
            parsedResult = JSON.parse(cleanJson);

            // Tampilkan Preview
            const previewDiv = document.getElementById('aiPreview');
            previewDiv.style.display = 'block';
            previewDiv.innerHTML = `
                <strong>Hasil Analisa AI:</strong><br>
                Nama: ${parsedResult.name}<br>
                Tag: ${parsedResult.tag}<br>
                Alamat: ${parsedResult.address}<br>
                Jam: ${parsedResult.time}<br>
                Detail: ${parsedResult.details}
            `;

            document.getElementById('btnSave').style.display = 'flex';

        } catch (error) {
            console.error(error);
            alert("Gagal menganalisa. Coba lagi atau input manual.");
        } finally {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('btnAnalyze').disabled = false;
        }
    }

    // --- 6. ACTIONS (SAVE, DELETE, TOGGLE) ---
    window.saveToFirebase = function() {
        if (!parsedResult) return;
        const teamId = document.getElementById('targetTeam').value;
        
        // Push ke Firebase
        push(ref(db, `tickets/${teamId}`), {
            ...parsedResult,
            checked: false,
            createdAt: Date.now()
        }).then(() => {
            alert("Tiket berhasil disimpan!");
            closeModal();
            document.getElementById('rawText').value = '';
            document.getElementById('aiPreview').style.display = 'none';
            document.getElementById('btnSave').style.display = 'none';
            parsedResult = null;
        });
    }

    window.toggleCheck = function(teamId, key, isChecked) {
        update(ref(db, `tickets/${teamId}/${key}`), {
            checked: isChecked
        });
    }

    window.deleteJob = function(teamId, key) {
        if(confirm("Hapus tiket ini?")) {
            remove(ref(db, `tickets/${teamId}/${key}`));
        }
    }

    // --- 7. HELPER FUNCTIONS ---
    window.openModal = () => document.getElementById('aiModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('aiModal').style.display = 'none';

    window.copySingle = (name, addr, tag, det) => {
        const txt = `Laporan Teknisi\nNama: ${name}\nStatus: ${tag}\nLokasi: ${addr}\nKet: ${det}`;
        navigator.clipboard.writeText(txt);
        alert("Disalin!");
    }

    window.copyRekap = () => {
        let txt = "*REKAP MONITORING*\n";
        Object.keys(localTeamsData).forEach(tid => {
            const team = localTeamsData[tid];
            const jobs = team.jobs;
            const keys = Object.keys(jobs);
            
            if(keys.length > 0) {
                txt += `\n*${team.name}*\n`;
                keys.forEach((k, i) => {
                    const j = jobs[k];
                    const icon = j.checked ? "‚úÖ" : "‚è≥";
                    txt += `${i+1}. ${j.name} (${j.tag}) ${icon}\n`;
                });
            }
        });
        navigator.clipboard.writeText(txt);
        alert("Rekap Harian Tersalin!");
    }

</script>

</body>
</html>
