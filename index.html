<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi Sinyalku - Inventory Pro V5.6 (Full Editable ISOLIR)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS UTAMA & RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f9; padding: 10px; color: #333; margin: 0; font-size: 14px;
        }

        /* --- LAYOUT CONTAINER --- */
        .container { max-width: 1000px; margin: 0 auto; width: 100%; }
        
        .header-section { 
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 25px; text-align: center; 
        }
        h1 { color: #2c3e50; margin: 0 0 15px 0; font-size: 1.5rem; line-height: 1.3; }
        
        /* --- BUTTONS --- */
        .btn-group-header { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; }
        
        .btn-action-main {
            color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-copy-all { background-color: #17a2b8; }
        .btn-excel { background-color: #217346; }
        .btn-ticket { background-color: #6610f2; }
        .btn-gudang { background-color: #d35400; } 
        .btn-rekap-modem { background-color: #343a40; border: 2px solid #23272b; }
        .btn-reset { background-color: #dc3545; border: 2px solid #b02a37; }
        .btn-action-main:active { transform: scale(0.95); }

        /* --- TEAM CARD --- */
        .team-card { 
            background: white; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            margin-bottom: 20px; overflow: hidden; border: 1px solid #e1e4e8; 
        }
        .team-header { 
            padding: 15px; color: white; font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center; font-size: 1rem; 
        }
        
        /* WARNA BACKGROUND HEADER */
        .bg-blue { background: linear-gradient(135deg, #007bff, #0056b3); } 
        .bg-green { background: linear-gradient(135deg, #28a745, #1e7e34); } 
        .bg-red { background: linear-gradient(135deg, #dc3545, #bd2130); }
        .bg-orange { background: linear-gradient(135deg, #fd7e14, #e35d0b); }
        .bg-purple { background: linear-gradient(135deg, #6f42c1, #59359a); }
        .bg-teal { background: linear-gradient(135deg, #20c997, #198766); }
        .bg-dark { background: linear-gradient(135deg, #343a40, #23272b); }

        /* --- JOB LIST ITEMS --- */
        .job-list { list-style: none; padding: 0; margin: 0; }
        .job-item { border-bottom: 1px solid #eee; padding: 15px; transition: background 0.3s; }
        .job-main-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; justify-content: space-between; }
        .job-left { display: flex; align-items: flex-start; gap: 12px; flex: 1 1 50%; min-width: 250px; }
        
        /* --- STATUS BUTTONS --- */
        .status-actions { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; margin-top: 2px; }
        .btn-check-status {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ddd;
            background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all 0.2s; outline: none;
        }
        .btn-check-status:hover { background-color: #f8f9fa; }
        
        /* State Active Styles */
        .btn-check-status.active-success { background-color: #28a745; border-color: #28a745; color: white; }
        .btn-check-status.active-fail { background-color: #dc3545; border-color: #dc3545; color: white; }
        .btn-check-status.inactive { opacity: 0.4; transform: scale(0.9); }

        .customer-info h3 { margin: 0; font-size: 1.05rem; color: #2c3e50; }
        .customer-info p { margin: 4px 0 0; font-size: 0.9rem; color: #666; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px; }
        .badge-psb { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .badge-mt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-isolir { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .toggle-btn, .btn-copy, .btn-delete, .btn-copy-team { 
            padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; 
            cursor: pointer; white-space: nowrap; flex: 1; text-align: center; 
        }
        .toggle-btn { background: #f0f7ff; border: 1px solid #007bff; color: #007bff; }
        .btn-copy { background: #fff5eb; border: 1px solid #fd7e14; color: #fd7e14; }
        .btn-delete { background: #ffebee; border: 1px solid #dc3545; color: #dc3545; }
        
        .btn-copy-team { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; flex: none; display: flex; align-items: center; gap: 5px; }
        .btn-copy-team:hover { background: rgba(255,255,255,0.3); }

        .btn-view-stock { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; margin-left: 5px; }
        .btn-view-stock:hover { background: rgba(0,0,0,0.4); }

        /* --- DETAIL & INPUTS --- */
        .job-details { display: none; margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .detail-item { background: white; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        .detail-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px;}
        .detail-value { font-size: 0.95rem; color: #333; font-weight: 500; word-break: break-word; }

        .manual-input-section { background-color: #fff; border: 1px solid #dfe6ed; padding: 15px; border-radius: 8px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }
        
        .locked-input { background-color: #e9ecef; color: #495057; cursor: not-allowed; border: 1px solid #ced4da; font-weight: bold; }
        .modem-selector { background-color: #e8f0fe; border: 1px solid #1a73e8; color: #1a73e8; font-weight: bold; margin-bottom: 10px; width: 100%; padding: 10px; border-radius: 5px;}
        option:disabled { color: red; background-color: #f2f2f2; text-decoration: line-through; }

        .progress-container { height: 6px; background: #e9ecef; width: 100%; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease; }
        
        /* Row States */
        .job-item.completed { background-color: #f6fff9; opacity: 0.9; }
        .job-item.completed .customer-info h3 { text-decoration: line-through; color: #28a745; }
        
        .job-item.failed { background-color: #fff5f5; border-left: 4px solid #dc3545; }
        .job-item.failed .customer-info h3 { color: #dc3545; }
        
        .fail-reason-box {
            background: #ffebee; color: #c62828; padding: 5px 8px; border-radius: 4px;
            font-size: 0.85rem; margin-top: 5px; display: inline-block; font-weight: bold;
            border: 1px dashed #ef9a9a;
        }
        
        .success-note-box {
            background: #e8f5e9; color: #2e7d32; padding: 5px 8px; border-radius: 4px;
            font-size: 0.85rem; margin-top: 5px; display: inline-block; font-weight: bold;
            border: 1px dashed #a5d6a7;
        }
        
        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 50px; }
        .modal-content { 
            background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; 
            width: 90%; max-width: 900px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            max-height: 90vh; overflow-y: auto; 
        }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .tab-header { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .btn-add-list { width: 100%; padding: 12px; background-color: #6610f2; color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .tech-select-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f0f7ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; margin-bottom: 15px; }
        .generator-box { background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #1a73e8; }
        .generator-box textarea { width: 100%; border: 1px solid #b1ccf0; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 0.85rem; resize: vertical; }
        .btn-generate { width: 100%; background-color: #1a73e8; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; margin-top: 8px; cursor: pointer; }

        /* --- PREVIEW CARD --- */
        .preview-card { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; position: relative; }
        .preview-psb { border-left: 5px solid #007bff; }
        .preview-mt { border-left: 5px solid #ffc107; }
        .preview-isolir { border-left: 5px solid #c0392b; background-color: #fff9f9; }
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-remove-preview { position: absolute; top: 10px; right: 10px; background: #ffebee; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }

        /* --- TABLE STYLES --- */
        .table-stock { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .table-stock th, .table-stock td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table-stock th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        .table-stock tr:nth-child(even) { background-color: #f9f9f9; }
        .btn-icon-del { background: #ffebee; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        
        /* --- GUDANG COMPONENTS --- */
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 2px;}
        .st-ready { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .st-installed { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .st-bad { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; } 
        
        .gudang-control { display:flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .gudang-select { padding: 5px; border-radius: 4px; border:1px solid #ccc; width: 120px; font-size: 0.8rem;}
        .btn-send-team { background-color: #28a745; color:white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem;}
        .btn-return { background-color: #ffc107; color: #333; border: 1px solid #e0a800; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; font-weight:bold;}
        .btn-bad-retur { background-color: #dc3545; color: white; border: 1px solid #b21f2d; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; font-weight:bold; }
        
        .btn-lock { background-color: #6c757d; color: white; border: 1px solid #545b62; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; }
        .btn-unlock { background-color: #007bff; color: white; border: 1px solid #0056b3; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; }
        .btn-transfer { background-color: #17a2b8; color: white; border: 1px solid #138496; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; }

        .stat-box { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-wrap: wrap;}
        .stat-item { text-align: center; min-width: 60px; }
        .stat-num { font-weight: bold; font-size: 1.1rem; display: block; }
        .stat-lbl { font-size: 0.75rem; color: #666; }

        .gudang-actions-header { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-bulk { background: #20c997; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-clean { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-format { background: #dc3545; color: white; border: 2px solid #b21f2d; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .search-gudang-box { width: 100%; padding: 10px; border: 2px solid #007bff; border-radius: 6px; font-size: 0.95rem; margin-bottom: 5px; background-color: #f0f7ff; height: 60px; resize: vertical; }

        /* --- MEDIA QUERIES (RESPONSIVE KHUSUS HP) --- */
        @media (max-width: 600px) {
            body { padding: 5px; background-color: #fff; }
            .container { padding: 0; }
            
            /* Header di HP */
            .header-section { margin: 15px 5px; }
            .btn-action-main { width: 100%; margin-bottom: 5px; } /* Tombol jadi full width */
            
            /* Kartu Tim di HP */
            .team-card { border-radius: 0; border-left: none; border-right: none; box-shadow: none; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
            
            /* List Pekerjaan */
            .job-main-row { flex-direction: column; align-items: stretch; }
            .job-left { width: 100%; margin-bottom: 10px; }
            .action-buttons { width: 100%; justify-content: space-between; }
            .status-actions { flex-direction: row; justify-content: flex-start; margin-bottom: 10px;}
            
            /* Modal di HP */
            .modal-content { width: 95%; padding: 15px; margin-top: 10px; }
            
            /* Grid Input jadi 1 kolom di HP */
            .input-grid, .preview-grid, .tech-select-container { grid-template-columns: 1fr; }
            
            /* Tabel scrollable */
            .table-stock { font-size: 0.8rem; }
            
            /* Tombol Gudang */
            .gudang-control { flex-direction: column; align-items: stretch; }
            .gudang-select { width: 100%; margin-bottom: 5px; }
            .btn-send-team { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>
            üìã Monitoring Teknisi<br>
            <span style="font-size: 0.6em; color: green; display: block; margin-top:5px;">Realtime Database ‚Ä¢ Inventory System V5.6 (Full Editable ISOLIR)</span>
            <div id="connection-status">Connecting to server...</div>
        </h1>
        <div class="btn-group-header">
            <button class="btn-action-main btn-ticket" onclick="openModal()">üìù Buat Tiket</button>
            <button class="btn-action-main btn-gudang" onclick="openGudangModal()">üè≠ Gudang Modem</button>
            <button class="btn-action-main btn-copy-all" onclick="copyAllSummary()">üìë Copy Rekap</button>
            <button class="btn-action-main btn-excel" onclick="downloadExcel()">üìä Download Excel</button>
            
            <button class="btn-action-main btn-rekap-modem" onclick="openRekapModemOption()">üì† Copy Rekap Modem</button>

            <button class="btn-action-main btn-reset" onclick="resetDatabase()">üî¥ Reset Tiket</button>
        </div>
    </div>

    <div id="teams-container">
        <p style="text-align: center; color: #888;">Memuat data...</p>
    </div>
</div>

<div id="modalRekapOption" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <span class="close-modal" onclick="closeRekapModemOption()">&times;</span>
        <h3 style="margin-top:0; color:#343a40;">üìã Pilih Jenis Rekap Modem</h3>
        <p style="font-size:0.9rem; color:#666;">Pilih jenis laporan stok modem yang ingin dicopy:</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button class="btn-action-main bg-blue" onclick="copyRekapModem('sisa')">
                üì¶ Hanya Sisa Stok (Belum Pasang)
            </button>
            <button class="btn-action-main bg-green" onclick="copyRekapModem('all')">
                üìë Semua (Sisa + Terpasang + Bad)
            </button>
        </div>
    </div>
</div>

<div id="modalGudang" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeGudangModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #d35400;">üè≠ GUDANG MODEM PUSAT</h2>
        
        <div class="stat-box">
            <div class="stat-item"><span id="stat-ready" class="stat-num" style="color:#28a745;">0</span><span class="stat-lbl">Ready</span></div>
            <div class="stat-item"><span id="stat-pending" class="stat-num" style="color:#fd7e14;">0</span><span class="stat-lbl">Pending</span></div>
            <div class="stat-item"><span id="stat-installed" class="stat-num" style="color:#007bff;">0</span><span class="stat-lbl">Terpasang</span></div>
            <div class="stat-item"><span id="stat-bad" class="stat-num" style="color:#dc3545;">0</span><span class="stat-lbl">BAD</span></div>
        </div>

        <div class="gudang-actions-header">
            <button class="btn-bulk" onclick="openBulkModal()">‚ûï Input Stok Massal</button>
            <button class="btn-clean" onclick="clearInstalledModems()">üóëÔ∏è Hapus Data Terpasang</button>
            <button class="btn-format" onclick="formatDatabase()">üî• Format Database</button>
        </div>

        <div class="tab-header">
            <button class="tab-btn active" onclick="switchGudangTab('srb')">Modem SRB <span id="count-srb" class="badge badge-psb">0</span></button>
            <button class="tab-btn" onclick="switchGudangTab('syn')">Modem SYN <span id="count-syn" class="badge badge-mt">0</span></button>
        </div>

        <div style="margin-bottom: 10px;">
            <textarea id="gudang-search" class="search-gudang-box" placeholder="üîç Cari Banyak Modem (4 digit belakang). Pisahkan dengan koma/spasi/enter. Contoh: A9C0, 74F8" onkeyup="renderGudangTable()"></textarea>
            <div style="font-size:0.75rem; color:#666; text-align:right;">*Hasil filter otomatis muncul dibawah</div>
        </div>

        <div id="gudang-content" style="max-height: 400px; overflow-y: auto;">
            <table class="table-stock">
                <thead>
                    <tr>
                        <th style="width:30px;">No</th>
                        <th>Serial Number (SN)</th>
                        <th>MAC Address</th>
                        <th>Status / Posisi</th>
                        <th style="width:160px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="gudang-table-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalBulk" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" onclick="closeBulkModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #20c997;">‚ûï Input Stok Massal</h2>
        
        <div class="form-group">
            <label>Pilih Jenis Modem Tujuan:</label>
            <select id="bulk-type" style="font-weight: bold; color: #333;">
                <option value="srb">Modem SRB (Paket 150rb)</option>
                <option value="syn">Modem SYN (Paket Lain/MT)</option>
            </select>
        </div>

        <div class="generator-box" style="border: 1px dashed #20c997; background: #f0fff4;">
            <label style="color: #20c997; font-weight: bold;">üìã Paste Data (SN dan MAC)</label>
            <p style="font-size:0.8rem; margin:2px 0 5px 0; color:#666;">Format: Bisa 1 baris panjang atau enter. (SN [spasi] MAC)</p>
            <textarea id="bulk-text" rows="10" placeholder="Contoh: FHTT9C7BA8F8 6C-D7-19-7B-A8-F8"></textarea>
        </div>

        <button class="btn-add-list" style="background-color: #20c997;" onclick="processBulkInput()">‚ö° Proses & Simpan</button>
    </div>
</div>

<div id="modalStock" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeStockModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #007bff;">üì¶ Input Stok Manual (Darurat)</h2>
        <input type="hidden" id="stock-team-index">
        
        <div class="form-group">
            <label>Serial Number (SN)</label>
            <input type="text" id="stock-sn" placeholder="ZTEGC...">
        </div>
        <div class="form-group">
            <label>MAC Address</label>
            <input type="text" id="stock-mac" placeholder="A1:B2:C3...">
        </div>
        <button class="btn-add-list" style="background-color: #28a745;" onclick="saveStockToTeam()">‚ûï Simpan ke Stok Tim</button>
    </div>
</div>

<div id="modalStockList" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <span class="close-modal" onclick="closeStockListModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center; color: #17a2b8;">üì¶ Data Stok Modem Tim</h2>
        <h4 id="stock-list-title" style="text-align: center; margin: 0 0 15px 0; color: #666;"></h4>
        
        <div style="overflow-x: auto;">
            <table class="table-stock">
                <thead>
                    <tr>
                        <th style="width: 40px;">No</th>
                        <th>Serial Number (SN)</th>
                        <th>MAC Address</th>
                        <th style="width: 60px; text-align: center;">Tipe</th>
                        <th style="width: 60px; text-align: center;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="stock-table-body">
                </tbody>
            </table>
            <div id="stock-empty-msg" style="text-align: center; padding: 20px; color: #999; font-style: italic; display: none;">
                Belum ada data stok modem.
            </div>
        </div>
    </div>
</div>

<div id="modalTicket" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="margin-top: 0; text-align: center;">Buat Tiket Baru</h2>
        
        <div class="tech-select-container">
            <div class="tech-select-wrapper">
                <label>üë§ Teknisi 1 (Wajib)</label>
                <select id="tech-1"></select>
            </div>
            <div class="tech-select-wrapper">
                <label>üë§ Teknisi 2 (Opsional)</label>
                <select id="tech-2">
                    <option value="">-- Kosong --</option>
                </select>
            </div>
        </div>

        <div class="generator-box">
            <label id="input-label" style="color: #1a73e8; font-weight: bold; font-size: 0.9rem;">
                ‚ú® SMART INPUT (PSB / MT / ISOLIR)
            </label>
            <p style="font-size:0.75rem; color:#666; margin:3px 0 5px 0;">Paste tiket disini. Sistem akan otomatis mendeteksi format (Termasuk format ISOLIR baru).</p>
            <textarea id="bulk-input-text" rows="8" placeholder="Paste data tiket disini..."></textarea>
            <button class="btn-generate" onclick="generatePreview()">‚ö° Generate Smart Preview</button>
        </div>

        <div id="preview-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 10px;">
            <div style="text-align: center; color: #999; font-style: italic;">Preview tiket akan muncul disini...</div>
        </div>

        <button class="btn-add-list" onclick="saveBulkTickets()">‚ûï Tambahkan Semua ke List</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
      authDomain: "monitoring-3aeb6.firebaseapp.com",
      databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
      projectId: "monitoring-3aeb6",
      storageBucket: "monitoring-3aeb6.firebasestorage.app",
      messagingSenderId: "888117973644",
      appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
      measurementId: "G-PTL0F1FPK0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'monitoring_teams_master'); 
    const gudangRef = ref(db, 'gudang_master_stock_v2');

    let openDetailIds = new Set();
    const techList = ["Ajis", "Bima", "Bimo", "Dani", "Deni", "Tomy", "Takim", "Reza", "Pian", "Rahmat", "Kholis", "Yudha", "Rival"];
    techList.sort(); 

    const defaultTeams = [];
    const extraColors = ["bg-orange", "bg-purple", "bg-teal", "bg-dark"];
    let teams = [];
    let gudangStock = { srb: [], syn: [] };

    window.resetDatabase = function() {
        let pin = prompt("‚ö†Ô∏è PERINGATAN: INI AKAN MENGHAPUS SEMUA TIKET!\n\nData Gudang (Pending/Terpasang) TIDAK AKAN DIHAPUS.\nMasukkan PIN untuk konfirmasi:");
        if (pin === "240525") {
            set(dbRef, []).then(() => {
                alert("‚úÖ Tiket & Tim berhasil di-reset bersih!\nData Gudang Modem tetap tersimpan.");
                location.reload();
            }).catch((err) => {
                alert("Gagal mereset database: " + err);
            });
        } else if (pin) {
            alert("‚ùå PIN SALAH!");
        }
    }
    
    window.formatDatabase = function() {
        let pin = prompt("‚ö†Ô∏è DANGER ZONE: FORMAT DATABASE GUDANG ‚ö†Ô∏è\n\nFitur ini akan menghapus database modem (salah satu jenis) secara total.\nMasukkan PIN Administrator:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH!");
            return;
        }
        let type = prompt("Ketik jenis modem yang ingin DIHAPUS TOTAL (Permanen):\nKetik 'SRB' atau 'SYN'").toLowerCase();
        if (type !== 'srb' && type !== 'syn') {
            alert("‚ùå Jenis tidak dikenali. Ketik SRB atau SYN.");
            return;
        }
        if (confirm(`‚ö†Ô∏è PERINGATAN TERAKHIR!\n\nAnda akan menghapus SEMUA DATA MODEM ${type.toUpperCase()} (Ready, Pending, Installed, Bad).\n\nData tidak bisa dikembalikan. Lanjut?`)) {
            gudangStock[type] = []; 
            saveGudangToFirebase();
            renderGudangTable(currentGudangTab);
            updateGudangCounts();
            alert(`‚úÖ Database Modem ${type.toUpperCase()} berhasil diformat (0 Data).`);
        }
    }

    function loadFirebaseData() {
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            document.getElementById('connection-status').innerText = "‚úÖ Terhubung Online (Data Tersimpan)";
            document.getElementById('connection-status').style.color = "green";
            
            if (data) {
                teams = data;
                teams.forEach(t => { if(!t.inventory) t.inventory = []; });
            } else {
                teams = JSON.parse(JSON.stringify(defaultTeams));
            }

            const active = document.activeElement;
            const isEditingText = active && (
                active.tagName === 'TEXTAREA' || 
                (active.tagName === 'INPUT' && (active.type === 'text' || active.type === 'number'))
            );

            if (isEditingText) {
                console.log("User sedang mengetik, menunda refresh UI...");
                return;
            }

            if(gudangStock.srb || gudangStock.syn) {
                renderJobs();
                syncInstalledModems();
            }
        });

        onValue(gudangRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                gudangStock = data;
                if(!gudangStock.srb) gudangStock.srb = [];
                if(!gudangStock.syn) gudangStock.syn = [];
            } else {
                const newStock = { srb: [], syn: [] };
                set(gudangRef, newStock);
                gudangStock = newStock;
            }
            
            updateGudangCounts();
            if(document.getElementById("modalGudang").style.display === "block") {
                renderGudangTable(currentGudangTab);
            }
            
            const active = document.activeElement;
            const isEditingText = active && (active.tagName === 'TEXTAREA' || (active.tagName === 'INPUT' && active.type === 'text'));
            
            if (!isEditingText) {
                renderJobs();
            }
        });
    }

    function getModemType(sn) {
        if (gudangStock.srb && gudangStock.srb.some(i => i.sn === sn)) return 'SRB';
        if (gudangStock.syn && gudangStock.syn.some(i => i.sn === sn)) return 'SYN';
        return 'UNKNOWN';
    }

    function syncInstalledModems() {
        let needsUpdate = false;
        const installedData = {};
        
        teams.forEach(team => {
            if(team.jobs) {
                team.jobs.forEach(job => {
                    const status = job.status || (job.completed ? 'completed' : 'pending');
                    if(status === 'completed' && job.technical && job.technical.sn && job.technical.sn !== '-') {
                        const time = job.completedAt || new Date().toLocaleString('id-ID');
                        installedData[job.technical.sn] = {
                            teamName: team.teamName,
                            time: time
                        };
                    }
                });
            }
        });

        function updateItem(item) {
            if (item.isLocked === true) return; 
            if (item.status === 'bad') return;

            if (installedData[item.sn]) {
                if (item.status !== 'installed' || !item.installedDate) {
                    item.status = 'installed';
                    item.teamName = installedData[item.sn].teamName; 
                    item.installedDate = installedData[item.sn].time;
                    needsUpdate = true;
                }
            } else {
                if (item.status === 'installed') {
                    item.status = 'pending';
                    item.installedDate = null;
                    needsUpdate = true;
                }
            }
        }
        gudangStock.srb.forEach(updateItem);
        gudangStock.syn.forEach(updateItem);
        if (needsUpdate) {
            saveGudangToFirebase();
        }
    }

    function getModemStatusGlobal(sn) {
        let item = gudangStock.srb.find(x => x.sn === sn);
        if(!item) item = gudangStock.syn.find(x => x.sn === sn);
        return item ? item.status : 'unknown';
    }

    function saveDataToFirebase() {
        set(dbRef, teams).catch((err) => alert("Gagal menyimpan data ke server!"));
    }
    
    function saveGudangToFirebase() {
        set(gudangRef, gudangStock).catch((err) => alert("Gagal update gudang!"));
    }

    window.toggleMtModemInput = function(tIndex, jIndex, val) {
        teams[tIndex].jobs[jIndex].replaceModem = val;
        if(val === 'no') {
            if(teams[tIndex].jobs[jIndex].technical) {
                teams[tIndex].jobs[jIndex].technical = {};
            }
        }
        saveDataToFirebase();
        renderJobs();
    }

    function renderJobs() {
        const container = document.getElementById('teams-container');
        container.innerHTML = ''; 

        if (!Array.isArray(teams)) { teams = []; }

        teams.sort((a, b) => {
            const getNum = (str) => {
                const match = str.match(/Tim\s+(\d+)/i);
                return match ? parseInt(match[1]) : 99999;
            };
            return getNum(a.teamName) - getNum(b.teamName);
        });
        
        let visibleTeamsCount = 0;

        teams.forEach((team, tIndex) => {
            if(!team.jobs) team.jobs = [];
            if(!team.inventory) team.inventory = [];

            if (team.jobs.length === 0) { return; }
            visibleTeamsCount++;

            team.jobs.sort((a, b) => {
                const getWeight = (t) => {
                    t = (t || "").toString().toLowerCase().trim();
                    if (t === "" || t === "-" || t.includes("flexibel")) return 99999;
                    if (t.includes("pagi")) return 480;   
                    if (t.includes("siang")) return 780;  
                    if (t.includes("sore")) return 960;   
                    if (t.includes("malam")) return 1140; 
                    
                    const match = t.match(/(\d{1,2})[:.]?(\d{2})?/);
                    if (match) {
                        const hour = parseInt(match[1]);
                        const minute = match[2] ? parseInt(match[2]) : 0;
                        return (hour * 60) + minute;
                    }
                    return 99999;
                };
                return getWeight(a.time) - getWeight(b.time);
            });

            const stockCount = team.inventory.filter(inv => {
                 const st = getModemStatusGlobal(inv.sn);
                 return st !== 'installed' && st !== 'bad';
            }).length;
            
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-card';
            
            teamDiv.innerHTML = `
                <div class="team-header ${team.colorClass}">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span>${team.teamName}</span>
                        <span style="font-size: 0.75em; opacity: 0.9;">üì¶ Sisa Stok: ${stockCount} pcs</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <button class="btn-copy-team" onclick="copyTeamSummary(${tIndex}, this)">üìë Rekap Tim</button>
                        <button class="btn-view-stock" onclick="openStockListModal(${tIndex})">MODEM</button>
                        <span id="count-${team.id}" style="font-size: 0.9em; margin-left: 5px;">0/0</span>
                    </div>
                </div>
                <div class="progress-container"><div class="progress-bar" id="progress-${team.id}"></div></div>
                <ul class="job-list" id="list-${team.id}"></ul>
            `;
            container.appendChild(teamDiv);

            const listContainer = document.getElementById(`list-${team.id}`);
            
            let modemOptions = `<option value="">-- Pilih Modem dari Stok (${stockCount}) --</option>`;
            team.inventory.forEach(inv => {
                const status = getModemStatusGlobal(inv.sn);
                const type = getModemType(inv.sn);
                const typeLabel = (type === 'SRB' || type === 'SYN') ? `[${type}] ` : '';

                if (status === 'installed') {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}" disabled>‚ùå ${typeLabel}${inv.sn} (Terpasang)</option>`;
                } else if (status === 'bad') {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}" disabled>‚ö†Ô∏è ${typeLabel}${inv.sn} (BAD)</option>`;
                } else {
                    modemOptions += `<option value="${inv.sn}|${inv.mac}">üì¶ ${typeLabel}${inv.sn}</option>`;
                }
            });
            
            team.jobs.forEach((job, index) => {
                const li = document.createElement('li');
                li.className = 'job-item';
                
                const currentStatus = job.status || (job.completed ? 'completed' : 'pending');
                
                if(currentStatus === 'completed') li.classList.add('completed');
                else if(currentStatus === 'failed') li.classList.add('failed');
                
                let detailHTML = '';
                for (const [key, value] of Object.entries(job.details)) {
                    detailHTML += `<div class="detail-item"><span class="detail-label">${key}</span><span class="detail-value">${value}</span></div>`;
                }

                const uniqueId = `details-${team.id}-${index}`;
                const isPSB = job.tag.toUpperCase().includes("PSB");
                const tech = job.technical || {};
                const displayStyle = openDetailIds.has(uniqueId) ? "block" : "none";

                let formHTML = '';
                if (isPSB) {
                    formHTML = `
                    <div class="manual-input-section">
                        <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìù Input Data Teknis</h4>
                        <div style="margin-bottom:10px;">
                            <label style="font-size:0.8rem; color:#007bff; font-weight:bold;">üì¶ Ambil Modem dari Stok:</label>
                            <select class="modem-selector" onchange="fillModemData(this, ${tIndex}, ${index})">
                                ${modemOptions}
                            </select>
                        </div>
                        <div class="input-grid">
                            <div class="input-group"><label>Kode SN</label><input type="text" id="sn-${tIndex}-${index}" class="realtime-input locked-input" data-key="sn" data-team="${tIndex}" data-job="${index}" value="${tech.sn || ''}" placeholder="Otomatis..." readonly></div>
                            <div class="input-group"><label>Mac</label><input type="text" id="mac-${tIndex}-${index}" class="realtime-input locked-input" data-key="mac" data-team="${tIndex}" data-job="${index}" value="${tech.mac || ''}" placeholder="Otomatis..." readonly></div>
                            <div class="input-group"><label>Mac vlan (+1)</label><input type="text" id="vlan-${tIndex}-${index}" class="realtime-input locked-input" data-key="vlan" data-team="${tIndex}" data-job="${index}" value="${tech.vlan || ''}" placeholder="Otomatis..." readonly></div>
                            
                            <div class="input-group"><label>Panjang kabel</label><input type="text" id="kabel-${tIndex}-${index}" class="realtime-input" data-key="kabel" data-team="${tIndex}" data-job="${index}" value="${tech.kabel || ''}" placeholder="150m"></div>
                            <div class="input-group"><label>Port</label><input type="text" id="port-${tIndex}-${index}" class="realtime-input" data-key="port" data-team="${tIndex}" data-job="${index}" value="${tech.port || ''}" placeholder="2"></div>
                            <div class="input-group"><label>Id ODP</label><input type="text" id="odp-${tIndex}-${index}" class="realtime-input" data-key="odp" data-team="${tIndex}" data-job="${index}" value="${tech.odp || ''}" placeholder="ODP-.."></div>
                            <div class="input-group" style="grid-column: 1/-1;"><label>Redaman</label><input type="text" id="redaman-${tIndex}-${index}" class="realtime-input" data-key="redaman" data-team="${tIndex}" data-job="${index}" value="${tech.redaman || ''}" placeholder="-18 dBm"></div>
                        </div>
                    </div>`;
                } else {
                    const replaceStatus = job.replaceModem || 'no'; 
                    const displayMtTech = replaceStatus === 'yes' ? 'block' : 'none';

                    formHTML = `
                    <div class="manual-input-section">
                        <div style="margin-bottom:10px;">
                            <label style="font-weight:bold; color:#d35400;">üîß Opsi Perangkat:</label>
                            <select style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; font-weight:bold;"
                                onchange="toggleMtModemInput(${tIndex}, ${index}, this.value)">
                                <option value="no" ${replaceStatus === 'no' ? 'selected' : ''}>‚ùå Tidak Ganti Modem</option>
                                <option value="yes" ${replaceStatus === 'yes' ? 'selected' : ''}>‚úÖ Ganti Modem Baru</option>
                            </select>
                        </div>

                        <div id="mt-tech-${tIndex}-${index}" style="display: ${displayMtTech}; border-top:1px dashed #ccc; padding-top:10px;">
                             <label style="font-size:0.8rem; color:#007bff; font-weight:bold;">üì¶ Ambil Modem dari Stok:</label>
                             <select class="modem-selector" onchange="fillModemData(this, ${tIndex}, ${index})">
                                ${modemOptions}
                             </select>
                             <div class="input-grid">
                                <div class="input-group" style="grid-column: 1/-1;"><label>Kode SN</label><input type="text" id="sn-${tIndex}-${index}" class="realtime-input locked-input" data-key="sn" data-team="${tIndex}" data-job="${index}" value="${tech.sn || ''}" placeholder="Otomatis..." readonly></div>
                                <div class="input-group"><label>Mac</label><input type="text" id="mac-${tIndex}-${index}" class="realtime-input locked-input" data-key="mac" data-team="${tIndex}" data-job="${index}" value="${tech.mac || ''}" placeholder="Otomatis..." readonly></div>
                                <div class="input-group"><label>Mac vlan (+1)</label><input type="text" id="vlan-${tIndex}-${index}" class="realtime-input locked-input" data-key="vlan" data-team="${tIndex}" data-job="${index}" value="${tech.vlan || ''}" placeholder="Otomatis..." readonly></div>
                             </div>
                        </div>
                    </div>
                    `;
                }

                const layID = job.details['No Layanan'] || job.details['Layanan'] || '';
                const failureNote = job.failureNote ? `<div class="fail-reason-box">‚õî ${job.failureNote}</div>` : '';
                const successNote = (job.status === 'completed' && job.completionNote) ? `<div class="success-note-box">üìù ${job.completionNote}</div>` : '';
                
                li.innerHTML = `
                    <div class="job-main-row">
                        <div class="job-left">
                            <div class="status-actions">
                                <button class="btn-check-status ${currentStatus === 'completed' ? 'active-success' : (currentStatus === 'failed' ? 'inactive' : '')}" onclick="toggleJobStatus(${tIndex}, ${index}, 'completed')" title="Selesai">‚úÖ</button>
                                <button class="btn-check-status ${currentStatus === 'failed' ? 'active-fail' : (currentStatus === 'completed' ? 'inactive' : '')}" onclick="toggleJobStatus(${tIndex}, ${index}, 'failed')" title="Gagal">‚ùå</button>
                            </div>
                            <div class="customer-info">
                                <h3>${job.name} <span class="badge ${job.tagClass}">${job.tag}</span></h3>
                                <div style="font-weight:bold; color:#d35400; font-size:0.85rem; margin-top:3px;">
                                    üïí ${job.time || 'FLEXIBEL'}
                                    ${layID ? `<span style="color:#28a745; margin-left:8px;">üÜî ${layID}</span>` : ''}
                                </div>
                                ${failureNote}
                                ${successNote}
                                <p>üìç ${job.address}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyData(${tIndex}, ${index}, this)">üìã Copy</button>
                            <button class="toggle-btn" onclick="toggleDetails('${uniqueId}')">üîΩ Detail</button>
                            <button class="btn-delete" onclick="deleteTicket(${tIndex}, ${index})">‚ùå Hapus</button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="job-details" style="display: ${displayStyle};">
                        <div class="detail-grid">
                            <div class="detail-item"><span class="detail-label">Jadwal</span><span class="detail-value">${job.time}</span></div>
                            ${detailHTML}
                        </div>
                        ${formHTML}
                    </div>
                `;

                listContainer.appendChild(li);

                const inputs = li.querySelectorAll('.realtime-input');
                inputs.forEach(input => {
                    input.addEventListener('change', (e) => {
                        const key = e.target.getAttribute('data-key');
                        if(!teams[tIndex].jobs[index].technical) teams[tIndex].jobs[index].technical = {};
                        teams[tIndex].jobs[index].technical[key] = e.target.value;
                        saveDataToFirebase(); 
                    });
                });
            });
            updateProgressUI(team.id, team.jobs);
        });

        if (visibleTeamsCount === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#999; font-style:italic;">üëã Belum ada tiket aktif.<br>Silakan buat tiket baru untuk memunculkan Tim.</div>';
        }
    }

    window.toggleJobStatus = function(tIndex, jobIndex, newStatus) {
        const job = teams[tIndex].jobs[jobIndex];
        const oldStatus = job.status || (job.completed ? 'completed' : 'pending');
        const isPSB = job.tag.toUpperCase().includes("PSB");

        if (oldStatus === newStatus) {
            job.status = 'pending';
            job.completed = false;
            job.completedAt = null;
            if (oldStatus === 'failed') job.failureNote = null;
            if (oldStatus === 'completed') job.completionNote = null;
        } else {
            if (newStatus === 'completed') {
                if (isPSB) {
                    let currentNo = job.details['No Layanan'] || "";
                    if(!currentNo || currentNo.trim() === "") {
                        let inputLayanan = prompt("‚ö†Ô∏è TIKET PSB SELESAI\n\nMasukkan No Layanan (Wajib Angka):", "");
                        if (inputLayanan === null) return; 
                        inputLayanan = inputLayanan.trim();
                        if (!/^\d+$/.test(inputLayanan)) {
                            alert("‚ùå Error: No Layanan harus format angka!");
                            return;
                        }
                        job.details['No Layanan'] = inputLayanan;
                    }
                } else {
                    let note = prompt("‚úÖ TIKET SELESAI\n\nMasukkan Laporan/Solusi (Akan muncul di rekap):", job.completionNote || "");
                    if (note === null) return; 
                    job.completionNote = note; 
                }

                job.status = 'completed';
                job.completed = true;
                job.completedAt = new Date().toLocaleString('id-ID');
                job.failureNote = null; 
            } 
            else if (newStatus === 'failed') {
                let note = prompt("‚õî KUNJUNGAN GAGAL\n\nMasukkan alasan/catatan kenapa gagal:", job.failureNote || "");
                if (note === null) return; 
                if (note.trim() === "") {
                    alert("‚ùå Catatan Gagal wajib diisi!");
                    return;
                }
                job.status = 'failed';
                job.completed = false;
                job.completedAt = null;
                job.failureNote = note;
                job.completionNote = null; 
            }
        }

        saveDataToFirebase();
        updateProgressUI(teams[tIndex].id, teams[tIndex].jobs);
        renderJobs(); 
        
        setTimeout(() => {
            syncInstalledModems();
        }, 500);
    }

    window.toggleDetails = function(id) {
        const el = document.getElementById(id);
        if (el.style.display === "block") {
            el.style.display = "none";
            openDetailIds.delete(id); 
        } else {
            el.style.display = "block";
            openDetailIds.add(id); 
        }
    };

    let currentGudangTab = 'srb';
    
    window.openGudangModal = function() {
        let pin = prompt("üîí MASUKKAN PIN GUDANG:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        document.getElementById('modalGudang').style.display = "block";
        switchGudangTab(currentGudangTab);
    }
    
    window.closeGudangModal = function() {
        document.getElementById('modalGudang').style.display = "none";
    }

    window.switchGudangTab = function(type) {
        currentGudangTab = type;
        document.getElementById('gudang-search').value = "";
        
        document.querySelectorAll('.tab-header .tab-btn').forEach(btn => btn.classList.remove('active'));
        if(type === 'srb') document.querySelectorAll('.tab-header .tab-btn')[0].classList.add('active');
        else document.querySelectorAll('.tab-header .tab-btn')[1].classList.add('active');
        
        renderGudangTable(type);
    }

    function updateGudangCounts() {
        const allItems = [...(gudangStock.srb || []), ...(gudangStock.syn || [])];
        const ready = allItems.filter(i => !i.status || i.status === 'ready').length;
        const pending = allItems.filter(i => i.status === 'pending').length;
        const installed = allItems.filter(i => i.status === 'installed').length;
        const bad = allItems.filter(i => i.status === 'bad').length;

        document.getElementById('stat-ready').innerText = ready;
        document.getElementById('stat-pending').innerText = pending;
        document.getElementById('stat-installed').innerText = installed;
        document.getElementById('stat-bad').innerText = bad;

        document.getElementById('count-srb').innerText = gudangStock.srb ? gudangStock.srb.length : 0;
        document.getElementById('count-syn').innerText = gudangStock.syn ? gudangStock.syn.length : 0;
    }

    window.toggleLock = function(type, index, lockState) {
        if (!lockState) {
            let pin = prompt("üîê Masukkan PIN untuk membuka data:");
            if(pin !== "240525") {
                alert("‚ùå PIN SALAH!");
                return;
            }
        }
        gudangStock[type][index].isLocked = (lockState === true);
        saveGudangToFirebase();
        renderGudangTable(type);
        if (lockState) alert("üîí Data Terkunci (Aman dari Reset/Hapus)");
        else alert("üîì Data Terbuka");
    }

    window.transferModem = function(type, index) {
        const select = document.getElementById(`transfer-sel-${type}-${index}`);
        const targetTeamIdx = select.value;

        if (targetTeamIdx === "") {
            alert("‚ùå Pilih tim tujuan untuk ditukar!");
            return;
        }

        const item = gudangStock[type][index];
        const oldTeamIdx = item.teamId;
        const targetTeamName = teams[targetTeamIdx].teamName;

        if(confirm(`üîÑ OPER STOK?\nPindahkan modem SN: ${item.sn}\nDari: ${item.teamName}\nKe: ${targetTeamName}?`)) {
            
            if (oldTeamIdx !== null && teams[oldTeamIdx] && teams[oldTeamIdx].inventory) {
                 const invIdx = teams[oldTeamIdx].inventory.findIndex(inv => inv.sn === item.sn);
                 if (invIdx > -1) {
                     teams[oldTeamIdx].inventory.splice(invIdx, 1);
                 }
            }

            if (!teams[targetTeamIdx].inventory) teams[targetTeamIdx].inventory = [];
            teams[targetTeamIdx].inventory.push({ sn: item.sn, mac: item.mac });

            gudangStock[type][index].teamName = targetTeamName;
            gudangStock[type][index].teamId = targetTeamIdx;
            gudangStock[type][index].pendingDate = new Date().toLocaleString('id-ID');

            saveDataToFirebase(); 
            saveGudangToFirebase(); 
            
            renderGudangTable(type);
            updateGudangCounts();
            alert("‚úÖ Berhasil dioper ke tim baru!");
        }
    }

    window.renderGudangTable = function(type) {
        if (!type) {
            type = currentGudangTab;
        }

        const tbody = document.getElementById('gudang-table-body');
        tbody.innerHTML = '';
        let data = gudangStock[type] || [];

        const searchInput = document.getElementById('gudang-search').value;
        if (searchInput.trim() !== "") {
            const keywords = searchInput.toUpperCase().split(/[\s,]+/).filter(k => k.length > 0);
            
            if (keywords.length > 0) {
                data = data.filter(item => {
                    const sn = (item.sn || '').toUpperCase(); 
                    return keywords.some(key => sn.endsWith(key) || sn.includes(key));
                });
            }
        }

        const statusOrder = { 'ready': 1, 'pending': 2, 'installed': 3, 'bad': 4 };
        data.sort((a, b) => (statusOrder[a.status || 'ready'] - statusOrder[b.status || 'ready']));

        let teamOptions = '<option value="">-- Pilih Tim --</option>';
        teams.forEach((t, idx) => {
             if(t.jobs && t.jobs.length > 0) {
                 teamOptions += `<option value="${idx}">${t.teamName}</option>`;
             }
        });

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">Data tidak ditemukan</td></tr>';
            return;
        }

        data.forEach((item, index) => {
            const originalIndex = gudangStock[type].indexOf(item);

            const tr = document.createElement('tr');
            
            let statusBadge = `<span class="status-badge st-ready">Ready</span>`;
            let aksiContent = '';

            let lockBtn = '';
            if (item.status === 'installed' || item.status === 'bad') {
                if (item.isLocked === true) {
                    lockBtn = `<button class="btn-unlock" onclick="toggleLock('${type}', ${originalIndex}, false)">üîí Buka</button>`;
                } else {
                    lockBtn = `<button class="btn-lock" onclick="toggleLock('${type}', ${originalIndex}, true)">üîì Kunci</button>`;
                }
            }

            if (item.status === 'pending') {
                statusBadge = `
                    <span class="status-badge st-pending">Pending</span>
                    <span class="tech-badge">@ ${item.teamName || 'Tim ?'}</span>
                    <span class="time-badge">üïí ${item.pendingDate || '-'}</span>
                `;
                aksiContent = `
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn-return" onclick="returnToWarehouse('${type}', ${originalIndex})">‚Ü©Ô∏è Tarik</button>
                            <button class="btn-bad-retur" onclick="processModemAction('${type}', ${originalIndex}, 'bad')">‚ö†Ô∏è BAD</button>
                        </div>
                        <div style="border-top:1px dashed #ccc; padding-top:4px; display:flex; gap:2px; align-items:center;">
                            <select id="transfer-sel-${type}-${originalIndex}" class="gudang-select" style="width:100px;">
                                ${teamOptions}
                            </select>
                            <button class="btn-transfer" onclick="transferModem('${type}', ${originalIndex})">üîÑ Oper</button>
                        </div>
                    </div>
                `;
            } else if (item.status === 'installed') {
                statusBadge = `
                    <span class="status-badge st-installed">Terpasang</span>
                    <span class="tech-badge">üë§ ${item.teamName || 'Teknisi ?'}</span>
                    <span class="time-badge">‚úÖ ${item.installedDate || '-'}</span>
                `;
                
                if (item.isLocked === true) {
                    aksiContent = `<div style="text-align:center;">${lockBtn}<br><span style="font-size:0.75rem; color:red; font-weight:bold;">Terkunci</span></div>`;
                } else {
                    aksiContent = `
                        <div style="display:flex; flex-direction:column; gap:5px;">
                             <div style="text-align:center;">${lockBtn}</div>
                             <div style="display:flex; gap:5px;">
                                <button class="btn-return" onclick="processModemAction('${type}', ${originalIndex}, 'retur')">‚Ü©Ô∏è Retur</button>
                                <button class="btn-bad-retur" onclick="processModemAction('${type}', ${originalIndex}, 'bad')">‚ö†Ô∏è Set BAD</button>
                            </div>
                        </div>
                    `;
                }

            } else if (item.status === 'bad') {
                statusBadge = `
                    <span class="status-badge st-bad">BAD / RUSAK</span>
                    <span class="time-badge">‚õî Tidak Layak</span>
                `;
                
                if (item.isLocked === true) {
                    aksiContent = `<div style="text-align:center;">${lockBtn}<br><span style="font-size:0.75rem; color:red; font-weight:bold;">Terkunci</span></div>`;
                } else {
                       aksiContent = `
                        <div style="display:flex; flex-direction:column; gap:5px;">
                             <div style="text-align:center;">${lockBtn}</div>
                             <div style="display:flex; gap:5px;">
                                <button class="btn-return" onclick="processModemAction('${type}', ${originalIndex}, 'reset')">üîÑ Reset</button> 
                                <button class="btn-icon-del" onclick="deleteFromWarehouse('${type}', ${originalIndex})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }
            } else {
                aksiContent = `
                    <div class="gudang-control">
                        <select id="team-sel-${type}-${originalIndex}" class="gudang-select">
                            ${teamOptions}
                        </select>
                        <button class="btn-send-team" onclick="sendToTeam('${type}', ${originalIndex})">‚û°Ô∏è Kirim</button>
                    </div>`;
            }

            let snDisplay = item.sn;
            if(searchInput.trim() !== "") {
                 snDisplay = `<span style="background-color: yellow;">${item.sn}</span>`;
            }

            tr.innerHTML = `
                <td style="text-align:center;">${index + 1}</td>
                <td><span style="font-weight:bold; color:#333;">${snDisplay}</span></td>
                <td>${item.mac}</td>
                <td>${statusBadge}</td>
                <td>${aksiContent}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.openBulkModal = function() {
        document.getElementById('modalBulk').style.display = "block";
    }

    window.closeBulkModal = function() {
        document.getElementById('modalBulk').style.display = "none";
    }

    window.processBulkInput = function() {
        const raw = document.getElementById('bulk-text').value;
        const type = document.getElementById('bulk-type').value;

        if(!raw.trim()) { alert("Data masih kosong!"); return; }

        let successCount = 0;
        const tokens = raw.replace(/[\n,]/g, ' ').trim().split(/\s+/);

        for (let i = 0; i < tokens.length; i += 2) {
            const sn = tokens[i];
            const mac = tokens[i + 1];

            if (sn && mac) {
                let exists = gudangStock[type].find(item => item.sn === sn);
                if(!exists) {
                    gudangStock[type].push({
                        sn: sn,
                        mac: mac,
                        status: 'ready',
                        isLocked: false 
                    });
                    successCount++;
                }
            }
        }

        if(successCount > 0) {
            saveGudangToFirebase();
            alert(`‚úÖ Berhasil menambahkan ${successCount} Modem ke ${type.toUpperCase()}!`);
            closeBulkModal();
            document.getElementById('bulk-text').value = ''; 
            renderGudangTable(type);
            updateGudangCounts();
        } else {
            alert("‚ö†Ô∏è Tidak ada data baru yang ditambahkan atau format salah.\nPastikan urutannya: SN [spasi] MAC.");
        }
    }

    window.clearInstalledModems = function() {
        let pin = prompt("‚ö†Ô∏è PERINGATAN: INI AKAN MENGHAPUS DATA MODEM YANG BERSTATUS 'TERPASANG'!\n\nData Ready, Pending, dan BAD tidak akan terhapus.\nMasukkan PIN untuk konfirmasi:");
        
        if(pin === "240525") {
            const srbCountBefore = gudangStock.srb.length;
            gudangStock.srb = gudangStock.srb.filter(item => !(item.status === 'installed' && !item.isLocked));
            const srbDeleted = srbCountBefore - gudangStock.srb.length;

            const synCountBefore = gudangStock.syn.length;
            gudangStock.syn = gudangStock.syn.filter(item => !(item.status === 'installed' && !item.isLocked));
            const synDeleted = synCountBefore - gudangStock.syn.length;

            saveGudangToFirebase();
            let msg = `‚úÖ PEMBERSIHAN SELESAI!\nDeleted SRB: ${srbDeleted}\nDeleted SYN: ${synDeleted}`;
            if (srbDeleted === 0 && synDeleted === 0) {
                msg += "\n\n(Tidak ada data yang dihapus. Mungkin data Terpasang dalam status TERKUNCI üîí)";
            }
            alert(msg);
            renderGudangTable(currentGudangTab);
            updateGudangCounts();

        } else if (pin) {
            alert("‚ùå PIN SALAH!");
        }
    }

    window.processModemAction = function(type, index, action) {
        const item = gudangStock[type][index];
        
        if (action === 'retur') {
            if(confirm(`‚ö†Ô∏è RETUR MODEM?\n\nApakah anda yakin menarik modem SN: ${item.sn} kembali ke Stok Ready?`)) {
                gudangStock[type][index].status = 'ready';
                gudangStock[type][index].teamName = '';
                gudangStock[type][index].teamId = null;
                gudangStock[type][index].pendingDate = null;
                gudangStock[type][index].installedDate = null;
                gudangStock[type][index].isLocked = false; 
                finalizeAction();
            }
        } else if (action === 'bad') {
            if(confirm(`‚ö†Ô∏è SET MODEM BAD?\n\nSN: ${item.sn} akan ditandai sebagai RUSAK/BAD.`)) {
                
                if (item.status === 'pending' || item.teamName) {
                    teams.forEach(t => {
                        if(t.inventory) {
                            const invIndex = t.inventory.findIndex(inv => inv.sn === item.sn);
                            if(invIndex > -1) {
                                t.inventory.splice(invIndex, 1);
                            }
                        }
                    });
                    saveDataToFirebase();
                }

                gudangStock[type][index].status = 'bad';
                gudangStock[type][index].teamName = '';
                gudangStock[type][index].teamId = null;
                gudangStock[type][index].pendingDate = null;
                
                finalizeAction();
            }
        } else if (action === 'reset') {
             if(confirm(`Kembalikan modem BAD (SN: ${item.sn}) menjadi READY?`)) {
                gudangStock[type][index].status = 'ready';
                gudangStock[type][index].isLocked = false;
                finalizeAction();
             }
        }

        function finalizeAction() {
            saveGudangToFirebase();
            renderGudangTable(type);
            updateGudangCounts();
            renderJobs(); 
        }
    }

    window.deleteFromWarehouse = function(type, index) {
        if(confirm("Hapus modem ini permanen dari database gudang?")) {
            gudangStock[type].splice(index, 1);
            saveGudangToFirebase();
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.sendToTeam = function(type, index) {
        const select = document.getElementById(`team-sel-${type}-${index}`);
        const teamIdx = select.value;
        
        if(teamIdx === "") { alert("Pilih tim tujuan dulu!"); return; }
        
        const item = gudangStock[type][index];
        const teamName = teams[teamIdx].teamName;

        if(confirm(`Kirim modem SN: ${item.sn} ke ${teamName}?`)) {
            gudangStock[type][index].status = 'pending';
            gudangStock[type][index].teamName = teamName;
            gudangStock[type][index].teamId = teamIdx;
            gudangStock[type][index].pendingDate = new Date().toLocaleString('id-ID');

            if(!teams[teamIdx].inventory) teams[teamIdx].inventory = [];
            teams[teamIdx].inventory.push({ sn: item.sn, mac: item.mac });
            
            saveDataToFirebase();
            saveGudangToFirebase();
            
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.returnToWarehouse = function(type, index) {
        const item = gudangStock[type][index];
        const teamName = item.teamName;
        
        if(confirm(`Tarik kembali modem ${item.sn} dari ${teamName} ke Gudang?`)) {
            teams.forEach(t => {
                if(t.inventory) {
                    const invIndex = t.inventory.findIndex(inv => inv.sn === item.sn);
                    if(invIndex > -1) {
                        t.inventory.splice(invIndex, 1);
                    }
                }
            });

            gudangStock[type][index].status = 'ready';
            gudangStock[type][index].teamName = '';
            gudangStock[type][index].teamId = null;
            gudangStock[type][index].pendingDate = null;

            saveDataToFirebase();
            saveGudangToFirebase();
            
            renderGudangTable(type);
            updateGudangCounts();
        }
    }

    window.openStockModal = function(teamIndex) {
        let pin = prompt("üîí Masukkan PIN untuk Input Stok Manual:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        document.getElementById('stock-team-index').value = teamIndex;
        document.getElementById('stock-sn').value = '';
        document.getElementById('stock-mac').value = '';
        document.getElementById('modalStock').style.display = "block";
    }

    window.closeStockModal = function() {
        document.getElementById('modalStock').style.display = "none";
    }

    window.saveStockToTeam = function() {
        const idx = document.getElementById('stock-team-index').value;
        const sn = document.getElementById('stock-sn').value;
        const mac = document.getElementById('stock-mac').value;

        if(!sn || !mac) { alert("SN dan Mac harus diisi!"); return; }

        if(!teams[idx].inventory) teams[idx].inventory = [];
        
        teams[idx].inventory.push({ sn: sn, mac: mac });
        saveDataToFirebase();
        closeStockModal();
        alert("‚úÖ Stok Modem berhasil ditambahkan!");
    }

    window.openStockListModal = function(teamIndex) {
        const team = teams[teamIndex];
        const tbody = document.getElementById('stock-table-body');
        const title = document.getElementById('stock-list-title');
        const emptyMsg = document.getElementById('stock-empty-msg');
        
        title.innerText = team.teamName;
        tbody.innerHTML = '';

        if (!team.inventory || team.inventory.length === 0) {
            emptyMsg.style.display = 'block';
        } else {
            emptyMsg.style.display = 'none';
            team.inventory.forEach((item, stockIdx) => {
                const tr = document.createElement('tr');
                
                const status = getModemStatusGlobal(item.sn);
                const type = getModemType(item.sn); 
                
                let displaySN = item.sn;
                let displayAction = `<button class="btn-icon-del" onclick="deleteStock(${teamIndex}, ${stockIdx})">üóëÔ∏è</button>`;

                if(status === 'installed') {
                        displaySN = `<span style="text-decoration:line-through; color:red;">${item.sn}</span> <span class="badge badge-psb">Terpasang</span>`;
                        displayAction = `<span style="font-size:0.8em; color:#ccc;">Locked</span>`;
                } else if(status === 'bad') {
                        displaySN = `<span style="text-decoration:line-through; color:darkred;">${item.sn}</span> <span class="badge badge-reset" style="background:red; color:white;">BAD</span>`;
                        displayAction = `<span style="font-size:0.8em; color:#ccc;">Locked</span>`;
                }

                let typeBadge = '';
                if(type === 'SRB') typeBadge = '<span class="badge" style="background:#007bff; color:white;">SRB</span>';
                else if(type === 'SYN') typeBadge = '<span class="badge" style="background:#ffc107; color:black;">SYN</span>';
                else typeBadge = '<span class="badge" style="background:#ccc; color:black;">?</span>';

                tr.innerHTML = `
                    <td style="text-align:center;">${stockIdx + 1}</td>
                    <td>${displaySN}</td>
                    <td>${item.mac}</td>
                    <td style="text-align:center;">${typeBadge}</td> <td style="text-align:center;">
                        ${displayAction}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        document.getElementById('modalStockList').style.display = 'block';
    }

    window.closeStockListModal = function() {
        document.getElementById('modalStockList').style.display = "none";
    }

    window.deleteStock = function(teamIndex, stockIndex) {
        let pin = prompt("üîí Masukkan PIN untuk Hapus Stok Modem:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        teams[teamIndex].inventory.splice(stockIndex, 1);
        saveDataToFirebase();
        openStockListModal(teamIndex);
    }

    window.fillModemData = function(selectEl, teamIdx, jobIdx) {
        const val = selectEl.value;
        if(val === "" || val === "manual") return; 

        const parts = val.split("|");
        const sn = parts[0];
        const mac = parts[1];

        let vlanMac = "";
        try {
            const sep = mac.includes('-') ? '-' : ':';
            const macParts = mac.split(sep);
            
            if(macParts.length === 6) {
                let lastByte = parseInt(macParts[5], 16);
                lastByte = lastByte + 1;
                lastByte = lastByte % 256;
                let newLastPart = lastByte.toString(16).toUpperCase().padStart(2, '0');
                macParts[5] = newLastPart;
                vlanMac = macParts.join(sep);
            } else {
                vlanMac = mac; 
            }
        } catch(e) {
            vlanMac = mac;
            console.error("Error calculating vlan mac", e);
        }

        const snEl = document.getElementById(`sn-${teamIdx}-${jobIdx}`);
        const macEl = document.getElementById(`mac-${teamIdx}-${jobIdx}`);
        const vlanEl = document.getElementById(`vlan-${teamIdx}-${jobIdx}`);

        if(snEl) snEl.value = sn;
        if(macEl) macEl.value = mac;
        if(vlanEl) vlanEl.value = vlanMac;

        if(!teams[teamIdx].jobs[jobIdx].technical) teams[teamIdx].jobs[jobIdx].technical = {};
        teams[teamIdx].jobs[jobIdx].technical['sn'] = sn;
        teams[teamIdx].jobs[jobIdx].technical['mac'] = mac;
        teams[teamIdx].jobs[jobIdx].technical['vlan'] = vlanMac;
        
        saveDataToFirebase();
    }

    function updateProgressUI(teamId, jobs) {
        const total = jobs.length;
        const completed = jobs.filter(j => j.status === 'completed' || j.completed === true).length;
        const percent = (total === 0) ? 0 : (completed / total) * 100;
        const bar = document.getElementById(`progress-${teamId}`);
        const txt = document.getElementById(`count-${teamId}`);
        if(bar) bar.style.width = percent + '%';
        if(txt) txt.innerText = `${completed}/${total} Selesai`;
    }

    window.deleteTicket = function(teamIndex, jobIndex) {
        let pin = prompt("üîê Masukkan PIN untuk menghapus tiket:");
        if (pin !== "240525") {
            alert("‚ùå PIN SALAH! Akses ditolak.");
            return;
        }
        teams[teamIndex].jobs.splice(jobIndex, 1);
        saveDataToFirebase();
    }

    // --- SMART GENERATE PREVIEW (ISOLIR ADDED) ---
    window.generatePreview = function() {
        const raw = document.getElementById('bulk-input-text').value;
        const container = document.getElementById('preview-container');
        container.innerHTML = ''; 

        if (!raw.trim()) { alert("Paste data dulu!"); return; }

        // Split by "Nama Pelanggan" or "Nama Lengkap" or standard breaks
        // Updated regex to catch blocks
        const blocks = raw.split(/(?=(?:Nama Lengkap|Nama Pelanggan)\s*[:=])/gi).filter(b => b.trim().length > 10);

        if(blocks.length === 0) {
            alert("‚ùå Format tidak dikenali!\nPastikan ada tulisan 'Nama Lengkap :' (untuk PSB) atau 'Nama Pelanggan :' (untuk MT/ISOLIR).");
            return;
        }

        let psbCount = 0;
        let mtCount = 0;
        let isolirCount = 0;

        blocks.forEach((block, index) => {
            // DETEKSI JENIS TIKET
            if (block.match(/Nama Lengkap\s*[:=]/i)) {
                // INI PSB
                createPSBCard(block, index, container);
                psbCount++;
            } else if (block.match(/Last DBM/i) || block.match(/User PPPOE/i) || block.match(/OLT SN/i)) {
                // INI ISOLIR (Punya detail teknis lengkap)
                createISOLIRCard(block, index, container);
                isolirCount++;
            } else {
                // INI MT BIASA
                createMTCard(block, index, container);
                mtCount++;
            }
        });

        alert(`‚úÖ SMART GENERATE SELESAI!\nDitemukan:\n- ${psbCount} Tiket PSB\n- ${mtCount} Tiket MT\n- ${isolirCount} Tiket ISOLIR`);
    }

    function createPSBCard(block, index, container) {
        const getValue = (label) => {
            const regex = new RegExp(label + "\\s*[:=]\\s*(.*)", "i");
            const match = block.match(regex);
            return match ? match[1].trim() : "";
        };

        const nama = getValue("Nama Lengkap");
        const alamat = getValue("Alamat Lengkap");
        const email = getValue("Email Aktif");
        
        let wa = getValue("No. WA");
        const waDigits = wa.replace(/\D/g, ''); 
        if (waDigits.length < 6) { 
            wa = "-"; 
        }
        
        const paket = getValue("Paket Layanan");
        const ktp = getValue("No KTP");
        const tgl = getValue("Tanggal Pemasangan");
        const statusRaw = getValue("Status kepemilikan rumah").toLowerCase();
        
        let statusVal = "Pribadi";
        if (statusRaw.includes("sewa") || statusRaw.includes("kontrak")) statusVal = "Sewa/Kontrak";
        else if (statusRaw.includes("kost")) statusVal = "Kost";

        const card = document.createElement('div');
        card.className = 'preview-card preview-psb';
        card.innerHTML = `
            <button class="btn-remove-preview" onclick="this.parentElement.remove()">‚ùå</button>
            <h4 style="color:#007bff;">Ticket PSB #${index + 1}: ${nama}</h4>
            <div class="form-group">
                <label>Jam Kunjungan (Wajib Diisi Manual)</label>
                <input type="text" class="bulk-input-jam" placeholder="Contoh: 13:00 atau Pagi" style="border: 2px solid #007bff; background: #f0f7ff;">
            </div>
            <div class="preview-grid">
                <input type="hidden" class="bulk-type" value="PSB">
                <div class="input-group"><label>Nama</label><input type="text" class="bulk-nama" value="${nama}"></div>
                <div class="input-group"><label>Alamat</label><input type="text" class="bulk-alamat" value="${alamat}"></div>
                <div class="input-group"><label>Email</label><input type="text" class="bulk-email" value="${email}"></div>
                <div class="input-group"><label>WA</label><input type="text" class="bulk-wa" value="${wa}"></div>
                <div class="input-group"><label>Paket</label><input type="text" class="bulk-paket" value="${paket}"></div>
                <div class="input-group"><label>KTP</label><input type="text" class="bulk-ktp" value="${ktp}"></div>
                <div class="input-group"><label>Tgl Pasang</label><input type="text" class="bulk-tgl" value="${tgl}"></div>
                <div class="input-group"><label>Status</label><input type="text" class="bulk-status" value="${statusVal}"></div>
            </div>
        `;
        container.appendChild(card);
    }

    function createMTCard(block, index, container) {
        const getValue = (label) => {
            const regex = new RegExp(label + "[\\s\\n]*[:=][\\s\\n]*(.*)", "i");
            const match = block.match(regex);
            return match ? match[1].trim() : "";
        };

        const nama = getValue("Nama Pelanggan");
        let layanan = getValue("No Layanan") || getValue("ID Pelanggan");
        if(layanan.includes("||")) layanan = layanan.split("||")[0].trim();

        let telp = getValue("No Telp") || getValue("No WA");
        const telpDigits = telp.replace(/\D/g, ''); 
        if (telpDigits.length < 6) { 
            telp = "-"; 
        }

        const tgl = getValue("Tanggal Daftar");
        const coverage = getValue("Coverage");
        const alamat = getValue("Alamat");
        const kendala = getValue("Kendala") || "MT (LAIN)";

        const card = document.createElement('div');
        card.className = 'preview-card preview-mt';
        card.innerHTML = `
            <button class="btn-remove-preview" onclick="this.parentElement.remove()">‚ùå</button>
            <h4 style="color:#856404;">Ticket MT #${index + 1}: ${nama}</h4>
            <div class="form-group">
                <label>Jam Kunjungan (Wajib Diisi Manual)</label>
                <input type="text" class="bulk-input-jam" placeholder="Contoh: 13:00 atau Pagi" style="border: 2px solid #ffc107; background: #fffdf5;">
            </div>
            <div class="preview-grid">
                <input type="hidden" class="bulk-type" value="MT">
                <div class="input-group"><label>Nama</label><input type="text" class="bulk-nama" value="${nama}"></div>
                <div class="input-group"><label>Alamat</label><input type="text" class="bulk-alamat" value="${alamat}"></div>
                <div class="input-group"><label>No Layanan</label><input type="text" class="bulk-layanan" value="${layanan}"></div>
                <div class="input-group"><label>No Telp</label><input type="text" class="bulk-telp" value="${telp}"></div>
                <div class="input-group"><label>Kendala</label><input type="text" class="bulk-tag" value="${kendala}"></div>
                <div class="input-group"><label>Coverage</label><input type="text" class="bulk-cov" value="${coverage}"></div>
                <div class="input-group"><label>Tgl Daftar</label><input type="text" class="bulk-tgl" value="${tgl}"></div>
                <div class="input-group" style="grid-column: 1/-1;"><label>Catatan (Opsional)</label><input type="text" class="bulk-catatan" placeholder="Tulis catatan tambahan disini..."></div>
            </div>
        `;
        container.appendChild(card);
    }

    function createISOLIRCard(block, index, container) {
        const getValue = (label) => {
            const regex = new RegExp(label + "[\\s\\n]*[:=][\\s\\n]*(.*)", "i");
            const match = block.match(regex);
            return match ? match[1].trim() : "";
        };

        // Extract Standard Fields
        const nama = getValue("Nama Pelanggan");
        let layananFull = getValue("No Layanan"); // Keep full format e.g. 1393005090||PROMO...
        const masaAktif = getValue("Masa Aktif s/d");
        const telp = getValue("No Telp\\.?");
        const tglDaftar = getValue("Tanggal Daftar");
        const coverage = getValue("Coverage");
        const alamat = getValue("Alamat");
        
        // Extract Technical Fields (ISOLIR SPECIFIC)
        const pppoe = getValue("User PPPOE_RADIUS");
        const odc = getValue("ODC");
        const odp = getValue("ODP");
        const port = getValue("Port ODP");
        const oltSn = getValue("OLT SN/MAC");
        const dbm = getValue("Last DBM");
        const dbmTime = getValue("Last DBM Time");
        const ssid = getValue("Nama WiFi \\(SSID\\)");
        const sandi = getValue("Sandi WiFi");
        const router = getValue("Router");
        const kordinat = getValue("Titik kordinat");

        const card = document.createElement('div');
        card.className = 'preview-card preview-isolir';
        card.innerHTML = `
            <button class="btn-remove-preview" onclick="this.parentElement.remove()">‚ùå</button>
            <h4 style="color:#c0392b;">Ticket ISOLIR #${index + 1}: ${nama}</h4>
            <div class="form-group">
                <label>Jam Kunjungan (Wajib Diisi Manual)</label>
                <input type="text" class="bulk-input-jam" placeholder="Contoh: 13:00 atau Pagi" style="border: 2px solid #c0392b; background: #fffdf5;">
            </div>
            <div class="preview-grid">
                <input type="hidden" class="bulk-type" value="ISOLIR">
                
                <div class="input-group"><label>Nama</label><input type="text" class="bulk-nama" value="${nama}"></div>
                <div class="input-group"><label>Alamat</label><input type="text" class="bulk-alamat" value="${alamat}"></div>
                <div class="input-group"><label>No Layanan (Full)</label><input type="text" class="bulk-layanan" value="${layananFull}"></div>
                <div class="input-group"><label>Masa Aktif</label><input type="text" class="bulk-masa" value="${masaAktif}"></div>
                
                <input type="hidden" class="iso-telp" value="${telp}">
                <input type="hidden" class="iso-tgl" value="${tglDaftar}">
                <input type="hidden" class="iso-cov" value="${coverage}">
                
                <div style="grid-column: 1/-1; border-top: 1px dashed #ccc; margin-top: 5px; padding-top: 5px; font-weight: bold; color: #c0392b;">Detail Teknis (Editable):</div>
                
                <div class="input-group"><label>ODP</label><input type="text" class="iso-odp" value="${odp}"></div>
                <div class="input-group"><label>Port</label><input type="text" class="iso-port" value="${port}"></div>
                <div class="input-group"><label>OLT SN</label><input type="text" class="iso-oltsn" value="${oltSn}"></div>
                <div class="input-group"><label>Last DBM</label><input type="text" class="iso-dbm" value="${dbm}"></div>
                <div class="input-group"><label>DBM Time</label><input type="text" class="iso-dbmtime" value="${dbmTime}"></div>
                <div class="input-group"><label>User PPPOE</label><input type="text" class="iso-pppoe" value="${pppoe}"></div>
                <div class="input-group"><label>ODC</label><input type="text" class="iso-odc" value="${odc}"></div>
                <div class="input-group"><label>SSID</label><input type="text" class="iso-ssid" value="${ssid}"></div>
                <div class="input-group"><label>Sandi</label><input type="text" class="iso-sandi" value="${sandi}"></div>
                <div class="input-group"><label>Router</label><input type="text" class="iso-router" value="${router}"></div>
                <div class="input-group"><label>Koordinat</label><input type="text" class="iso-kordinat" value="${kordinat}"></div>
            </div>
        `;
        container.appendChild(card);
    }

    // --- SAVE BULK TICKETS (Updated for ISOLIR) ---
    window.saveBulkTickets = function() {
        const previewCards = document.querySelectorAll('.preview-card');
        if(previewCards.length === 0) { alert("Generate preview dulu!"); return; }

        const t1 = document.getElementById('tech-1').value;
        const t2 = document.getElementById('tech-2').value;

        if(!t1) { alert("Pilih minimal Teknisi 1!"); return; }

        let selectedMembers = [t1.toLowerCase()];
        if(t2 && t2 !== "") selectedMembers.push(t2.toLowerCase());
        selectedMembers.sort(); 

        let targetTeamIndex = teams.findIndex(team => {
            return JSON.stringify(team.members.sort()) === JSON.stringify(selectedMembers);
        });

        if (targetTeamIndex === -1) {
            const newId = Date.now(); 
            const colorIndex = (teams.length) % extraColors.length; 
            
            const usedNumbers = teams.map(t => {
                const match = t.teamName.match(/Tim\s+(\d+)/i);
                return match ? parseInt(match[1]) : 0;
            });
            
            let nextNum = 1;
            while (usedNumbers.includes(nextNum)) {
                nextNum++;
            }
            
            const teamNameStr = `Tim ${nextNum}: ${t1}${t2 ? ' & '+t2 : ''}`;

            const newTeamObj = {
                id: newId,
                teamName: teamNameStr,
                colorClass: extraColors[colorIndex] || "bg-dark",
                members: selectedMembers,
                jobs: [],
                inventory: []
            };
            teams.push(newTeamObj);
            targetTeamIndex = teams.length - 1;
        }

        let count = 0;
        previewCards.forEach(card => {
            const type = card.querySelector('.bulk-type').value;
            const jam = card.querySelector('.bulk-input-jam').value || "FLEXIBEL";
            const nama = card.querySelector('.bulk-nama').value || "Tanpa Nama";
            const alamat = card.querySelector('.bulk-alamat').value || "-";

            let newJob = {};

            if(type === 'PSB') {
                const email = card.querySelector('.bulk-email').value;
                const wa = card.querySelector('.bulk-wa').value;
                const paket = card.querySelector('.bulk-paket').value;
                const ktp = card.querySelector('.bulk-ktp').value;
                const tgl = card.querySelector('.bulk-tgl').value;
                const status = card.querySelector('.bulk-status').value;

                newJob = {
                    completed: false,
                    status: 'pending',
                    completedAt: null, 
                    technical: {},
                    name: nama,
                    tag: `PSB (${paket})`,
                    tagClass: "badge-psb",
                    time: jam,
                    address: alamat,
                    details: { "Paket": paket, "Email": email, "No WA": wa, "No KTP": ktp, "Status": status, "Tgl Pasang": tgl }
                };
            } else if (type === 'ISOLIR') {
                // DATA ISOLIR
                const layanan = card.querySelector('.bulk-layanan').value;
                const masaAktif = card.querySelector('.bulk-masa').value;
                
                // Get Hidden Inputs
                const telp = card.querySelector('.iso-telp').value;
                const tgl = card.querySelector('.iso-tgl').value;
                const cov = card.querySelector('.iso-cov').value;
                
                // Get Editable Technical Inputs (Updated Selector to match createISOLIRCard)
                const pppoe = card.querySelector('.iso-pppoe').value;
                const odc = card.querySelector('.iso-odc').value;
                const odp = card.querySelector('.iso-odp').value;
                const port = card.querySelector('.iso-port').value;
                const oltsn = card.querySelector('.iso-oltsn').value;
                const dbm = card.querySelector('.iso-dbm').value;
                const dbmtime = card.querySelector('.iso-dbmtime').value;
                const ssid = card.querySelector('.iso-ssid').value;
                const sandi = card.querySelector('.iso-sandi').value;
                const router = card.querySelector('.iso-router').value;
                const kordinat = card.querySelector('.iso-kordinat').value;

                newJob = {
                    completed: false,
                    status: 'pending',
                    technical: {},
                    name: nama,
                    tag: 'ISOLIR',
                    tagClass: "badge-isolir",
                    time: jam,
                    address: alamat,
                    details: {
                        "Layanan": layanan,
                        "Masa Aktif": masaAktif,
                        "No Telp": telp,
                        "Tgl Daftar": tgl,
                        "Coverage": cov,
                        "User PPPOE": pppoe,
                        "ODC": odc,
                        "ODP": odp,
                        "Port": port,
                        "OLT SN": oltsn,
                        "Last DBM": dbm,
                        "DBM Time": dbmtime,
                        "SSID": ssid,
                        "Sandi": sandi,
                        "Router": router,
                        "Koordinat": kordinat
                    }
                };

            } else {
                // DATA MT
                const layanan = card.querySelector('.bulk-layanan').value;
                const telp = card.querySelector('.bulk-telp').value;
                const tag = card.querySelector('.bulk-tag').value;
                const coverage = card.querySelector('.bulk-cov').value;
                const tgl = card.querySelector('.bulk-tgl').value;
                const catatan = card.querySelector('.bulk-catatan').value; 

                newJob = {
                    completed: false,
                    status: 'pending',
                    completedAt: null,
                    technical: {},
                    name: nama,
                    tag: tag,
                    tagClass: "badge-mt", 
                    time: jam,
                    address: alamat,
                    details: { "Layanan": layanan, "No Telp": telp, "Tgl Daftar": tgl, "Coverage": coverage, "Catatan": catatan }
                };
            }

            teams[targetTeamIndex].jobs.push(newJob);
            count++;
        });

        saveDataToFirebase();
        closeModal();
        alert(`‚úÖ Berhasil menambahkan ${count} tiket ke ${teams[targetTeamIndex].teamName}`);
        
        document.getElementById('bulk-input-text').value = '';
        document.getElementById('preview-container').innerHTML = '';
    }

    function parseAddress(addr) {
        const rtMatch = addr.match(/RT\s*[\.\:\-\/]?\s*0?(\d+)/i);
        const rwMatch = addr.match(/RW\s*[\.\:\-\/]?\s*0?(\d+)/i);
        const kelMatch = addr.match(/Kel\.?\s*([A-Za-z\s]+)/i);
        return {
            rt: rtMatch ? rtMatch[1] : '-',
            rw: rwMatch ? rwMatch[1] : '-',
            kel: kelMatch ? kelMatch[1] : '-'
        };
    }
    
    function formatMacForCopy(input) {
        if (!input || input === '-' || input.trim() === "") return '-';
        let clean = input.replace(/[^a-fA-F0-9]/g, "").toUpperCase();
        
        if (clean.length > 2) {
            return clean.match(/.{1,2}/g).join(':');
        }
        return clean;
    }

    window.copyData = async function(teamIndex, jobIndex, btn) {
        const team = teams[teamIndex];
        const job = team.jobs[jobIndex];
        const d = job.details;
        const tech = job.technical || {};
        const isPSB = job.tag.toUpperCase().includes("PSB");
        const isISOLIR = job.tag === 'ISOLIR';
        let textToCopy = "";

        if (isISOLIR) {
            // FORMAT KHUSUS ISOLIR (Sesuai Permintaan)
            textToCopy = `(Nama Pelanggan: ${job.name}
No Layanan: ${d['Layanan'] || '-'}
Masa Aktif s/d: ${d['Masa Aktif'] || '-'}
No Telp.: ${d['No Telp'] || '-'}
Tanggal Daftar: ${d['Tgl Daftar'] || '-'}
Coverage: ${d['Coverage'] || '-'}
Alamat: ${job.address}
User PPPOE_RADIUS: ${d['User PPPOE'] || '-'}
ODC: ${d['ODC'] || '-'}
ODP: ${d['ODP'] || '-'}
Port ODP: ${d['Port'] || '-'}
OLT SN/MAC: ${d['OLT SN'] || '-'}
Last DBM: ${d['Last DBM'] || '-'}
Last DBM Time: ${d['DBM Time'] || '-'}
Nama WiFi (SSID): ${d['SSID'] || '-'}
Sandi WiFi: ${d['Sandi'] || '-'}
Router: ${d['Router'] || '-'}
Titik kordinat: ${d['Koordinat'] || '-'})`;

        } else if (isPSB) {
            const snVal = tech.sn || '-';
            const macVal = formatMacForCopy(tech.mac);
            const vlanVal = formatMacForCopy(tech.vlan);
            const kabelVal = tech.kabel || '-';
            const portVal = tech.port || '-';
            const odpVal = tech.odp || '-';
            const redamanVal = tech.redaman || '-';
            
            textToCopy = `TEKNISI : ${team.teamName}
KATEGORI : ${job.tag}
--------------------------------
Nama Lengkap : ${job.name} ( JAM ${job.time} )
Alamat Lengkap : ${job.address}
Email Aktif: ${d['Email'] || '-'}
No. Wa: ${d['No WA'] || d['No Telp'] || '-'}
Paket Layanan : ${d['Paket'] || '-'}
Biaya regist : -
No KTP : ${d['No KTP'] || '-'}
Tanggal/Jam Pemasangan : ${job.time === 'FLEXIBEL' ? 'FLEXIBEL' : 'Sesuai Jadwal'}
Refrensi SRB dari : ${d['Status'] || '-'}
FOTO Depan Rumah :

--- DATA TEKNIS ---
kode SN : ${snVal}
Mac : ${macVal}
Mac vlan : ${vlanVal}
Panjang kabel : ${kabelVal}
Port : ${portVal}
Id ODP : ${odpVal}
Redaman : ${redamanVal}`;
        } else {
            // FORMAT MT
            textToCopy = `TEKNISI : ${team.teamName}
KATEGORI : ${job.tag}
--------------------------------
Nama Pelanggan : ${job.name} ( JAM ${job.time} )
No Layanan : ${d['Layanan']||'-'}
No Telp. : ${d['No Telp']||'-'}
Tanggal Daftar : ${d['Tgl Daftar']||'-'}
Coverage : ${d['Coverage']||'-'}
Catatan : ${d['Catatan']||'-'}
Alamat : ${job.address}`;

            if (job.replaceModem === 'yes' && tech.sn) {
                 const macVal = formatMacForCopy(tech.mac);
                 const vlanVal = formatMacForCopy(tech.vlan);
                 textToCopy += `\n\n--- GANTI MODEM BARU ---\nSN : ${tech.sn}\nMAC : ${macVal}\nVLAN : ${vlanVal}`;
            }
        }
        copyToClipboard(textToCopy, btn);
    };

    function getNumberEmoji(n) {
        const emojis = ['0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü'];
        return emojis[n] || `${n}.`;
    }

    window.copyTeamSummary = function(tIndex, btn) {
        const team = teams[tIndex];
        let text = `üìã REKAP ${team.teamName.toUpperCase()}\n\n`;

        team.jobs.forEach((job, index) => {
             const layID = job.details['No Layanan'] || job.details['Layanan'] || '-';
             const time = job.time || 'FLEXIBEL';
             const numIcon = getNumberEmoji(index + 1);
             
             let statusLine = "";
             let failureLine = "";
             let noteSuffix = "";

             if(job.status === 'completed' || (job.completed && !job.status)) {
                 if(job.completionNote) noteSuffix = ` (${job.completionNote})`;
                 statusLine = `‚úÖ STATUS: SELESAI${noteSuffix}`;
             }
             else if(job.status === 'failed') {
                 statusLine = `‚õî STATUS: GAGAL KUNJUNGAN`;
                 if(job.failureNote) failureLine = `\nüìù Ket: ${job.failureNote}`;
             } else {
                 statusLine = `‚è≥ STATUS: PENDING`;
             }

             text += `${numIcon} ${job.name.toUpperCase()} (${job.tag})\n`;
             text += `${statusLine}${failureLine}\n`;
             text += `üÜî ${layID} | üïí ${time}\n`;
             text += `üìç ${job.address}\n`;
             text += `----------------------------------------------\n`;
        });

        copyToClipboard(text, btn, "‚úÖ Disalin!");
    }

    window.copyAllSummary = function() {
        let summaryText = `üìã *MONITORING TEKNISI SINYALKU*\nüìÖ ${new Date().toLocaleDateString('id-ID')}\n\n`;
        
        teams.forEach(team => {
            summaryText += `üìã REKAP ${team.teamName.toUpperCase()}\n\n`;
            
            team.jobs.forEach((job, index) => {
                const layID = job.details['No Layanan'] || job.details['Layanan'] || '-';
                const time = job.time || 'FLEXIBEL';
                const numIcon = getNumberEmoji(index + 1);
                
                let statusLine = "";
                let failureLine = "";
                let noteSuffix = "";

                if(job.status === 'completed' || (job.completed && !job.status)) {
                    if(job.completionNote) noteSuffix = ` (${job.completionNote})`;
                    statusLine = `‚úÖ STATUS: SELESAI${noteSuffix}`;
                }
                else if(job.status === 'failed') {
                    statusLine = `‚õî STATUS: GAGAL KUNJUNGAN`;
                    if(job.failureNote) failureLine = `\nüìù Ket: ${job.failureNote}`;
                } else {
                    statusLine = `‚è≥ STATUS: PENDING`;
                }

                summaryText += `${numIcon} ${job.name.toUpperCase()} (${job.tag})\n`;
                summaryText += `${statusLine}${failureLine}\n`;
                summaryText += `üÜî ${layID} | üïí ${time}\n`;
                summaryText += `üìç ${job.address}\n`;
                summaryText += `----------------------------------------------\n`;
            });
            summaryText += `\n`; 
        });
        
        const btn = document.querySelector('.btn-copy-all');
        copyToClipboard(summaryText, btn, "‚úÖ Rekap Tersalin!");
    };

    window.openRekapModemOption = function() {
        document.getElementById('modalRekapOption').style.display = 'block';
    }
    
    window.closeRekapModemOption = function() {
        document.getElementById('modalRekapOption').style.display = 'none';
    }

    window.copyRekapModem = function(mode) {
        let text = `üìã *REKAP MODEM TEKNISI*\nüìÖ ${new Date().toLocaleDateString('id-ID')}\n`;
        text += mode === 'sisa' ? "(Hanya Stok Belum Terpasang)\n\n" : "(Semua: Sisa + Terpasang)\n\n";

        teams.forEach(team => {
            if(!team.inventory || team.inventory.length === 0) return;

            let items = [];
            if(mode === 'sisa') {
                items = team.inventory.filter(i => {
                    const status = getModemStatusGlobal(i.sn);
                    return status !== 'installed' && status !== 'bad';
                });
            } else {
                items = team.inventory;
            }

            if(items.length > 0) {
                text += `üë§ *${team.teamName.toUpperCase()}* (${items.length} unit)\n`;
                items.forEach((item, idx) => {
                    const status = getModemStatusGlobal(item.sn);
                    const type = getModemType(item.sn); 
                    
                    let statusTag = "";
                    if(mode === 'all') {
                         if(status === 'installed') statusTag = " [TERPASANG]";
                         else if(status === 'bad') statusTag = " [BAD]";
                         else statusTag = " [READY]";
                    }
                    
                    text += `${idx+1}. ${item.sn} [${type}]${statusTag}\n`;
                });
                text += `--------------------\n`;
            }
        });

        navigator.clipboard.writeText(text).then(() => {
            alert("‚úÖ Rekap Modem berhasil disalin ke Clipboard!");
            closeRekapModemOption();
        }).catch(err => {
            console.error("Gagal copy", err);
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("‚úÖ Rekap Modem berhasil disalin!");
            closeRekapModemOption();
        });
    }

    window.downloadExcel = function() {
        let dataToExport = [];
        const todayStr = new Date().toLocaleDateString('id-ID');
        teams.forEach(team => {
            const rawTechName = team.teamName.split(':')[1]?.trim() || team.teamName;
            team.jobs.forEach((job, index) => {
                const d = job.details;
                const tech = job.technical || {};
                const addressParts = parseAddress(job.address);
                let kelurahan = d['Coverage']?.replace('Kel. ', '') || addressParts.kel;
                if(kelurahan === '-') { 
                    if(job.address.includes("Jatinegara")) kelurahan = "Jatinegara";
                    if(job.address.includes("Cipinang")) kelurahan = "Cipinang";
                }
                
                const noLayanan = d['No Layanan'] || d['Layanan'] || "-";
                
                let statusExcel = "Pending";
                if(job.status === 'completed' || (job.completed && !job.status)) statusExcel = "Selesai";
                else if(job.status === 'failed') statusExcel = "Gagal Kunjungan";

                let catatanFull = d['Catatan'] || "-";
                
                if(job.status === 'failed' && job.failureNote) {
                    if(catatanFull === "-") catatanFull = `GAGAL: ${job.failureNote}`;
                    else catatanFull += ` | GAGAL: ${job.failureNote}`;
                }
                
                if(job.status === 'completed' && job.completionNote) {
                       if(catatanFull === "-") catatanFull = `SOLUSI: ${job.completionNote}`;
                       else catatanFull += ` | SOLUSI: ${job.completionNote}`;
                }
                
                dataToExport.push({
                    "No Layanan": noLayanan,
                    "Nama Pelanggan": job.name,
                    "Status Pengerjaan": statusExcel,
                    "Nomor Telpon": d['No WA'] || d['No Telp'] || "-",
                    "Tanggal Selesai Kunjungan": job.status === 'completed' ? (job.completedAt || todayStr) : "-",
                    "Nama Teknisi": rawTechName,
                    "Alamat Lengkap": job.address,
                    "RT": addressParts.rt,
                    "RW": addressParts.rw,
                    "Area Kelurahan": kelurahan,
                    "SN": tech.sn || "-",
                    "Catatan": catatanFull 
                });
            });
        });
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wscols = [{wch: 15}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 40}, {wch: 5}, {wch: 5}, {wch: 15}, {wch: 20}, {wch: 30}];
        ws['!cols'] = wscols;
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan Teknisi");
        XLSX.writeFile(wb, "Laporan_Teknisi_Sinyalku.xlsx");
    };

    async function copyToClipboard(text, btnElement, successMsg = "‚úÖ Tersalin!") {
        let success = false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try { await navigator.clipboard.writeText(text); success = true; } catch (err) {}
        }
        if (!success) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px"; 
                document.body.appendChild(textArea);
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) success = true;
            } catch (err) {}
        }
        if (success && btnElement) {
            const originalText = btnElement.innerHTML;
            const originalBg = btnElement.style.backgroundColor;
            btnElement.innerHTML = successMsg;
            btnElement.style.backgroundColor = "#28a745"; 
            setTimeout(() => {
                btnElement.innerHTML = originalText;
                btnElement.style.backgroundColor = originalBg;
            }, 2000);
        }
    }

    window.openModal = function() {
        let pin = prompt("üîí Masukkan PIN untuk membuat tiket:");
        if (pin !== "240525") { alert("‚ùå PIN SALAH! Akses ditolak."); return; }
        populateTechSelect(); 
        document.getElementById("modalTicket").style.display = "block";
    }
    function populateTechSelect() {
        const s1 = document.getElementById('tech-1');
        const s2 = document.getElementById('tech-2');
        if (s1.options.length > 0) return; 
        techList.forEach(name => {
            s1.add(new Option(name, name));
            s2.add(new Option(name, name));
        });
        s1.selectedIndex = 0; s2.value = ""; 
    }
    window.closeModal = function() { 
        document.getElementById("modalTicket").style.display = "none"; 
        document.getElementById('preview-container').innerHTML = '<div style="text-align: center; color: #999; font-style: italic;">Preview tiket akan muncul disini...</div>';
        document.getElementById('bulk-input-text').value = '';
    }
    window.onclick = function(event) { 
        if (event.target == document.getElementById("modalTicket")) closeModal();
        if (event.target == document.getElementById("modalStock")) closeStockModal();
        if (event.target == document.getElementById("modalStockList")) closeStockListModal();
        if (event.target == document.getElementById("modalGudang")) closeGudangModal();
        if (event.target == document.getElementById("modalBulk")) closeBulkModal();
        if (event.target == document.getElementById("modalRekapOption")) closeRekapModemOption();
    }
    
    loadFirebaseData();
</script>

</body>
</html>
