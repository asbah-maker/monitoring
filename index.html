<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi - AI Auto Sort</title>
    <style id="main-style">
        /* --- 1. BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; padding: 10px; color: #333; margin: 0; font-size: 14px;
        }
        .container { max-width: 800px; margin: 0 auto; width: 100%; }

        /* --- 2. HEADER --- */
        .header-section { 
            text-align: center; margin-bottom: 20px; padding: 15px; 
            background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        h1 { color: #1a73e8; margin: 0 0 5px 0; font-size: 1.4rem; }
        .sub-header { font-size: 0.8rem; color: #5f6368; margin-bottom: 10px; }

        .status-badge {
            font-size: 11px; padding: 4px 12px; border-radius: 20px; 
            background: #e8f0fe; color: #1a73e8; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .status-dot.active { background: #34a853; box-shadow: 0 0 0 2px rgba(52,168,83,0.2); }

        .btn-main {
            background: #1a73e8; color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; margin-top: 10px;
            display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(26,115,232,0.3);
        }
        .btn-main:active { transform: translateY(1px); }

        /* --- 3. TEAM CARDS --- */
        .team-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 16px; overflow: hidden; border: 1px solid #dadce0; }
        
        .team-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: 600; }
        .th-1 { background: linear-gradient(135deg, #1976d2, #42a5f5); }
        .th-2 { background: linear-gradient(135deg, #d32f2f, #ef5350); }
        .th-3 { background: linear-gradient(135deg, #f57c00, #ffb74d); }
        .th-4 { background: linear-gradient(135deg, #7b1fa2, #ab47bc); }

        .btn-add-ai {
            background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.5);
            color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .job-list { list-style: none; padding: 0; margin: 0; }
        .job-item { padding: 15px; border-bottom: 1px solid #f1f3f4; transition: background 0.2s; position: relative; }
        .job-item.completed { background-color: #f8f9fa; opacity: 0.7; }
        .job-item.completed h3 { text-decoration: line-through; color: #9aa0a6; }

        .job-row { display: flex; gap: 12px; align-items: flex-start; }
        .check-wrapper { padding-top: 4px; }
        .custom-checkbox { width: 22px; height: 22px; accent-color: #34a853; cursor: pointer; }

        .job-info { flex: 1; }
        .job-info h3 { margin: 0 0 6px 0; font-size: 1rem; color: #202124; line-height: 1.4; }
        .job-meta { font-size: 0.85rem; color: #5f6368; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        
        /* Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .b-psb { background: #e3f2fd; color: #1967d2; border: 1px solid #d2e3fc; }
        .b-mt { background: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        .b-up { background: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .b-time { background: #f1f3f4; color: #3c4043; border: 1px solid #dadce0; display: flex; align-items: center; gap: 4px; }

        .detail-box { display: none; margin-top: 12px; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #dadce0; font-size: 0.9rem; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dashed #dadce0; padding-bottom: 4px; }
        
        .job-tools { margin-top: 12px; display: flex; gap: 8px; }
        .btn-tool { flex: 1; padding: 8px; border: 1px solid #dadce0; background: white; border-radius: 6px; font-size: 0.8rem; cursor: pointer; color: #5f6368; }
        .btn-tool:hover { background: #f1f3f4; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 92%; max-width: 500px; padding: 20px; border-radius: 16px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .m-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; }
        .m-body textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 10px; resize: vertical; }
        
        .preview-list { max-height: 250px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 8px; margin-bottom: 10px; display: none; padding: 8px; }
        .preview-item { padding: 10px; border-bottom: 1px solid #eee; background: white; margin-bottom: 8px; border-radius: 6px; border: 1px solid #eee; position: relative; }
        
        .loading-ai { text-align: center; color: #1a73e8; font-weight: bold; display: none; padding: 10px; }
        .loading-ai span { display: inline-block; animation: blink 1.4s infinite both; }
        .loading-ai span:nth-child(2) { animation-delay: .2s; }
        .loading-ai span:nth-child(3) { animation-delay: .4s; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }

        .team-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; font-weight: bold; display:inline-block; margin-bottom:4px; }
        .tt-1 { background: #1976d2; }
        .tt-2 { background: #d32f2f; }
        .tt-3 { background: #f57c00; }
        .tt-4 { background: #7b1fa2; }

    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>üõ†Ô∏è Monitoring Teknisi</h1>
        <div class="sub-header">Sabtu, 10 Januari 2026</div>
        <div class="status-badge"><div id="conn-dot" class="status-dot"></div> <span id="conn-text">Menghubungkan...</span></div>
        <br>
        <button class="btn-main" onclick="copyAllSummary()">üìã Copy Rekap Harian</button>
    </div>

    <div class="team-card">
        <div class="team-header th-2">
            <span>Tim 2: Yudha & Bimo</span>
            <button class="btn-add-ai" onclick="openAiModal(2)">‚ú® + Tiket (AI)</button>
        </div>
        <ul id="list-2" class="job-list"></ul>
    </div>

    <div class="team-card">
        <div class="team-header th-1">
            <span>Tim 1: Reza & Ramdani</span>
            <button class="btn-add-ai" onclick="openAiModal(1)">‚ú® + Tiket (AI)</button>
        </div>
        <ul id="list-1" class="job-list"></ul>
    </div>

    <div class="team-card">
        <div class="team-header th-4">
            <span>Tim 4: Nur Kholis & Zainal</span>
            <button class="btn-add-ai" onclick="openAiModal(4)">‚ú® + Tiket (AI)</button>
        </div>
        <ul id="list-4" class="job-list"></ul>
    </div>

    <div class="team-card">
        <div class="team-header th-3">
            <span>Tim 3: Pian</span>
            <button class="btn-add-ai" onclick="openAiModal(3)">‚ú® + Tiket (AI)</button>
        </div>
        <ul id="list-3" class="job-list"></ul>
    </div>
</div>

<div id="aiModal" class="modal">
    <div class="modal-content">
        <div class="m-head">
            <span>‚ú® Smart AI (Auto Sort)</span>
            <span style="cursor:pointer" onclick="closeAiModal()">‚úï</span>
        </div>
        <div class="m-body">
            <p style="font-size:0.8rem; color:#666; margin-bottom:8px;">
                Paste <b>SEMUA</b> teks dari WA (Tim Campur tidak masalah). AI akan membaginya ke tim yang benar.
            </p>
            <textarea id="rawInput" placeholder="Paste chat WA yang berantakan disini..."></textarea>
            
            <button class="btn-main" id="btnAnalyze" style="width:100%; margin-bottom:12px; background: linear-gradient(90deg, #4285F4, #9B72CB);" onclick="callGeminiAPI()">‚ú® Analisa & Sortir (Online)</button>
            
            <div id="loadingAi" class="loading-ai">AI sedang membaca tiket<span>.</span><span>.</span><span>.</span></div>

            <div id="previewBox" class="preview-list"></div>
        </div>
        <div class="m-foot" style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-tool" onclick="closeAiModal()">Batal</button>
            <button class="btn-main" id="btnSave" style="background:#34a853; width:100%;" onclick="saveToFirebase()" disabled>Simpan Data</button>
        </div>
    </div>
</div>

<div id="currentTeamId" style="display:none;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. CONFIGURATION ---
    const GEMINI_API_KEY = "AIzaSyB7MKdgP1gGSTUsfP2g-dPq_CtbBdPpEns"; // API Key Anda

    const firebaseConfig = {
      apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
      authDomain: "monitoring-3aeb6.firebaseapp.com",
      databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
      projectId: "monitoring-3aeb6",
      storageBucket: "monitoring-3aeb6.firebasestorage.app",
      messagingSenderId: "888117973644",
      appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
      measurementId: "G-PTL0F1FPK0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- VARIABLES ---
    let tempParsedJobs = [];
    let currentChecklist = {};
    let allJobs = {};
    const baseTeams = [
        { id: 1, name: "Reza & Ramdani" },
        { id: 2, name: "Yudha & Bimo" },
        { id: 3, name: "Pian" },
        { id: 4, name: "Nur Kholis & Zainal" }
    ];

    // --- FIREBASE LISTENERS ---
    onValue(ref(db, ".info/connected"), (snap) => {
        const dot = document.getElementById('conn-dot');
        const txt = document.getElementById('conn-text');
        if(snap.val()===true){ dot.classList.add('active'); txt.innerText = "Online (Firebase)"; txt.style.color="green"; }
        else { dot.classList.remove('active'); txt.innerText = "Offline"; txt.style.color="#999"; }
    });

    onValue(ref(db, 'checklist_v1'), (snap) => {
        currentChecklist = snap.val() || {};
        updateCheckboxes();
    });

    onValue(ref(db, 'additional_tickets'), (snap) => {
        const data = snap.val() || {};
        allJobs = {}; 
        baseTeams.forEach(t => {
            const teamKey = 'team_' + t.id;
            allJobs[t.id] = [];
            if(data[teamKey]) {
                Object.keys(data[teamKey]).forEach(k => {
                    allJobs[t.id].push({ ...data[teamKey][k], key: k });
                });
            }
        });
        renderAll();
    });

    // --- AI LOGIC (GEMINI API - AUTO SORT) ---
    window.callGeminiAPI = async function() {
        const text = document.getElementById('rawInput').value;
        const defaultTeam = document.getElementById('currentTeamId').innerText;
        
        if (!text.trim()) { alert("Isi teks dulu!"); return; }

        document.getElementById('loadingAi').style.display = 'block';
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('btnAnalyze').disabled = true;

        // Prompt super pintar untuk menangani format hancur + Auto Sort Team
        const prompt = `
        Kamu adalah sistem parsing tiket teknisi internet. Tugasmu:
        1. Ekstrak tiket dari teks mentah (bisa banyak tiket).
        2. Perbaiki format aneh (misal "(: ZINTA" menjadi "Zinta", "ama Pelanggan" jadi "Nama").
        3. Tentukan TIM berdasarkan kata kunci di sekitar tiket tersebut.
           - Tim 1: Reza, Ramdani, Syn, Dani.
           - Tim 2: Yudha, Bimo, @yudha.
           - Tim 3: Pian.
           - Tim 4: Nur Kholis, Zainal, Bang Nur, Alfian.
           - Jika tidak ada nama teknisi, gunakan Tim Default: ${defaultTeam}.
        
        INPUT TEKS:
        ${text}

        ATURAN TAG:
        - Jika "LOS", "MERAH", "PUTUS" -> "MT (LOS)"
        - Jika "GANGGUAN", "LAMBAT", "MATI", "RAPIHIN" -> "MT (GANGGUAN)"
        - Jika "PSB", "PASANG", "150", "200" -> "PSB (REGULER)"
        - Jika "UPGRADE", "WIFI 6", "GANTI MODEM" -> "UPGRADE"
        - Jika "PINDAH" -> "RELOKASI"

        OUTPUT JSON Array:
        [{
            "name": "Nama Pelanggan",
            "address": "Alamat Singkat",
            "tag": "Kategori",
            "tagClass": "css-class",
            "time": "Jam (contoh: 13:00) atau FLEXIBEL",
            "teamId": Angka_Tim_1_sampai_4,
            "details": {"No WA": "...", "Paket": "...", "Kendala": "..."}
        }]

        Gunakan tagClass: "b-mt" (Gangguan), "b-los" (Los), "b-psb" (Pasang), "b-up" (Upgrade).
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const rawResult = data.candidates[0].content.parts[0].text;
            const jsonStr = rawResult.replace(/```json|```/g, '').trim();
            const jobs = JSON.parse(jsonStr);

            tempParsedJobs = jobs;
            renderPreview(jobs);

        } catch (error) {
            console.error(error);
            alert("Gagal menghubungi AI: " + error.message);
        } finally {
            document.getElementById('loadingAi').style.display = 'none';
            document.getElementById('btnAnalyze').disabled = false;
        }
    }

    function renderPreview(jobs) {
        const pBox = document.getElementById('previewBox');
        pBox.innerHTML = '';
        
        if (jobs.length === 0) {
            pBox.innerHTML = '<div style="text-align:center; padding:10px;">Tidak ada tiket terdeteksi.</div>';
            return;
        }

        jobs.forEach((j, i) => {
            let bg = '#eee'; let color = '#333';
            if(j.tag.includes('LOS') || j.tag.includes('MT')) { bg = '#fce8e6'; color = '#c5221f'; }
            if(j.tag.includes('PSB')) { bg = '#e3f2fd'; color = '#1967d2'; }
            if(j.tag.includes('UP')) { bg = '#e6f4ea'; color = '#137333'; }

            let teamName = "Tim " + j.teamId;
            let teamClass = "tt-" + j.teamId;

            pBox.innerHTML += `
                <div class="preview-item">
                    <div style="font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
                        <span><span class="team-tag ${teamClass}">${teamName}</span> ${j.name}</span>
                        <span style="background:${bg}; color:${color}; padding:2px 8px; border-radius:10px; font-size:10px;">${j.tag}</span>
                    </div>
                    <div style="font-size:0.8em; color:#666; margin-top:4px;">
                        üïí ${j.time} <br> üìç ${j.address}
                    </div>
                </div>
            `;
        });

        pBox.style.display = 'block';
        const btnSave = document.getElementById('btnSave');
        btnSave.disabled = false;
        btnSave.innerText = `Simpan ${jobs.length} Tiket`;
    }

    // --- SAVE LOGIC (AUTO DISTRIBUTE) ---
    window.saveToFirebase = async function() {
        const btn = document.getElementById('btnSave');
        btn.innerText = "‚è≥ Mendistribusikan..."; btn.disabled = true;

        try {
            // Kita loop setiap job dan simpan ke folder Tim yang sesuai (berdasarkan job.teamId)
            const promises = tempParsedJobs.map(job => {
                // Pastikan teamId valid (1-4), jika tidak, pakai default modal
                let targetTeam = job.teamId || document.getElementById('currentTeamId').innerText;
                if(targetTeam < 1 || targetTeam > 4) targetTeam = document.getElementById('currentTeamId').innerText;

                return push(ref(db, 'additional_tickets/team_' + targetTeam), job);
            });
            
            await Promise.all(promises);
            alert("‚úÖ Sukses! Semua tiket telah didistribusikan ke Tim masing-masing.");
            closeAiModal();
        } catch(e) {
            alert("Gagal: " + e.message);
        } finally {
            btn.innerText = "Simpan Data"; btn.disabled = false;
        }
    }

    // RENDER MAIN LIST
    function renderAll() {
        baseTeams.forEach(t => {
            const list = document.getElementById(`list-${t.id}`);
            list.innerHTML = '';
            const jobs = allJobs[t.id] || [];
            
            if(jobs.length === 0) { list.innerHTML = `<li class="empty-state" style="padding:20px; text-align:center; color:#999;">Belum ada tiket</li>`; return; }

            jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'job-item';
                const uniq = job.key;
                
                let details = '';
                if(job.details) {
                    for(const [k,v] of Object.entries(job.details)) {
                        details += `<div class="detail-row"><span>${k}</span><span>${v}</span></div>`;
                    }
                }

                let formPsb = '';
                if(job.tag && job.tag.includes('PSB')) {
                    formPsb = `<div style="display:flex; gap:5px; margin-top:8px;">
                        <input type="text" id="sn-${uniq}" placeholder="SN..." style="width:50%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        <input type="text" id="red-${uniq}" placeholder="Redaman..." style="width:50%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                    </div>`;
                }

                li.innerHTML = `
                    <div class="job-row">
                        <div class="check-wrapper"><input type="checkbox" class="custom-checkbox" id="chk-${uniq}" onchange="window.handleCheck('${uniq}', this.checked)"></div>
                        <div class="job-info">
                            <h3>${job.name} <span class="badge ${job.tagClass || 'b-mt'}">${job.tag || 'MT'}</span></h3>
                            <div class="job-meta"><span class="badge b-time">üïí ${job.time}</span> <span>üìç ${job.address}</span></div>
                            
                            <div id="det-${uniq}" class="detail-box">${details} ${formPsb}</div>

                            <div class="job-tools">
                                <button class="btn-tool" onclick="toggleDet('${uniq}')">Detail</button>
                                <button class="btn-tool" onclick="copyItem('${uniq}', '${t.name}', this)">Copy</button>
                                <button class="btn-tool" style="color:red; flex:0.3;" onclick="deleteItem('${t.id}', '${uniq}')">X</button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        });
        updateCheckboxes();
    }

    function updateCheckboxes() {
        document.querySelectorAll('.custom-checkbox').forEach(box => {
            const id = box.id.replace('chk-', '');
            if(currentChecklist[id]) { box.checked = true; box.closest('.job-item').classList.add('completed'); }
            else { box.checked = false; box.closest('.job-item').classList.remove('completed'); }
        });
    }

    // --- HELPERS ---
    window.handleCheck = (id, val) => set(ref(db, 'checklist_v1/' + id), val);
    window.deleteItem = (tid, key) => { if(confirm("Hapus?")) remove(ref(db, `additional_tickets/team_${tid}/${key}`)); }
    window.toggleDet = (id) => { const el = document.getElementById('det-'+id); el.style.display = el.style.display==='block'?'none':'block'; }
    
    window.copyItem = (key, tName, btn) => {
        let j = null;
        for(let id in allJobs) { const f = allJobs[id].find(x => x.key === key); if(f) j=f; }
        if(!j) return;
        
        const sn = document.getElementById(`sn-${key}`)?.value || '-';
        const txt = `*Laporan Teknisi*\nTim: ${tName}\nNama: ${j.name}\nStatus: ‚úÖ Selesai\nSN: ${sn}`;
        navigator.clipboard.writeText(txt);
        const ori = btn.innerText; btn.innerText = "‚úÖ"; setTimeout(()=>btn.innerText=ori, 1000);
    }

    window.copyAllSummary = () => {
        let txt = `üìã *REKAP ${new Date().toLocaleDateString('id-ID')}*\n`;
        baseTeams.forEach(t => {
            txt += `\n*TIM: ${t.name.toUpperCase()}*\n`;
            const jobs = allJobs[t.id] || [];
            if(!jobs.length) txt += `_(Nihil)_\n`;
            jobs.forEach((j, i) => {
                const check = currentChecklist[j.key] ? "‚úÖ" : "‚è≥";
                txt += `${i+1}. ${check} ${j.name} (${j.tag})\n`;
            });
        });
        navigator.clipboard.writeText(txt).then(() => alert("Tersalin!"));
    }

    window.openAiModal = (id) => { 
        document.getElementById('currentTeamId').innerText = id; 
        document.getElementById('modalTeamId').innerText = id; // Visual saja
        document.getElementById('rawInput').value = ''; 
        document.getElementById('previewBox').style.display = 'none'; 
        document.getElementById('aiModal').style.display = 'flex'; 
    }
    window.closeAiModal = () => document.getElementById('aiModal').style.display = 'none';

</script>
</body>
</html>
