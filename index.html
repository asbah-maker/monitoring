<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi - Gemini 1.5 Flash</title>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        /* --- STYLES (UI SAMA, PERFORMA BEDA) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; padding: 10px; color: #333; margin: 0; font-size: 14px; }
        .container { max-width: 1000px; margin: 0 auto; width: 100%; }
        
        .header-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; text-align: center; }
        h1 { color: #2c3e50; margin: 0 0 15px 0; font-size: 1.5rem; line-height: 1.3; }
        
        .btn-copy-all { background-color: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15); display: inline-flex; align-items: center; gap: 8px; }
        
        .team-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; border: 1px solid #e1e4e8; }
        .team-header { padding: 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        .header-team1 { background: linear-gradient(135deg, #007bff, #0056b3); } 
        .header-team2 { background: linear-gradient(135deg, #28a745, #1e7e34); } 
        .header-team3 { background: linear-gradient(135deg, #dc3545, #bd2130); }
        
        .btn-add-ticket { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-left: 10px; }
        
        .job-list { list-style: none; padding: 0; margin: 0; }
        .job-item { border-bottom: 1px solid #eee; padding: 15px; }
        .job-main-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; justify-content: space-between; }
        .job-left { display: flex; align-items: flex-start; gap: 12px; flex: 1 1 60%; min-width: 250px; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #28a745; flex-shrink: 0; margin-top: 2px; }
        .customer-info h3 { margin: 0; font-size: 1.05rem; color: #2c3e50; line-height: 1.4; }
        .customer-info p { margin: 4px 0 0; font-size: 0.9rem; color: #666; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px; }
        .badge-psb { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .badge-mt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-los { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .badge-prio { background-color: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; }
        .badge-info { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .toggle-btn, .btn-copy, .btn-delete { padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; flex: 1; text-align: center; }
        .toggle-btn { background: #f0f7ff; border: 1px solid #007bff; color: #007bff; }
        .btn-copy { background: #fff5eb; border: 1px solid #fd7e14; color: #fd7e14; }
        .btn-delete { background: #ffebee; border: 1px solid #c62828; color: #c62828; display: none; }

        .job-details { display: none; margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .detail-item { background: white; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        .detail-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px;}
        .detail-value { font-size: 0.95rem; color: #333; font-weight: 500; word-break: break-word; }

        .manual-input-section { background-color: #fff; border: 1px solid #dfe6ed; padding: 15px; border-radius: 8px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .input-grid { grid-template-columns: 1fr; } }
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes fadeIn { from {opacity:0; transform: translateY(-20px);} to {opacity:1; transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-modal { font-size: 1.5rem; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .btn-submit { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; }
        
        .progress-container { height: 6px; background: #e9ecef; width: 100%; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease; }
        .job-item.completed { background-color: #f6fff9; opacity: 0.8; }
        .job-item.completed .customer-info h3 { text-decoration: line-through; color: #999; }
        .btn-reset { background-color: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%; display: block; margin-top: 30px; margin-bottom: 50px; }

        /* AI STYLES */
        .ai-section { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px dashed #2196f3; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .ai-section textarea { width: 100%; border: 1px solid #90caf9; border-radius: 6px; padding: 10px; min-height: 80px; font-size: 0.9rem; resize: vertical; margin-bottom: 10px; }
        .btn-ai { background: linear-gradient(90deg, #6200ea, #b388ff); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(98, 0, 234, 0.3); transition: transform 0.2s; }
        .btn-ai:active { transform: scale(0.98); }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>
            üìã Monitoring Teknisi<br>
            <span style="font-size: 0.6em; color: green; display: block; margin-top:5px;">Update: 7 Jan 2026 (AI 1.5 Flash)</span>
        </h1>
        <button class="btn-copy-all" onclick="copyAllSummary()">üìë Copy Rekap Harian</button>
    </div>

    <div class="team-card">
        <div class="team-header header-team2">
            <div>Tim 1: Kholis & Dani <button class="btn-add-ticket" onclick="openTicketModal(1)">+ Tiket</button></div>
            <span id="count-1" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-1"></div></div>
        <ul class="job-list" id="list-1"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team1">
            <div>Tim 2: Yudha & Bimo <button class="btn-add-ticket" onclick="openTicketModal(2)">+ Tiket</button></div>
            <span id="count-2" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-2"></div></div>
        <ul class="job-list" id="list-2"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team3">
            <div>Tim 3: Pian <button class="btn-add-ticket" onclick="openTicketModal(3)">+ Tiket</button></div>
            <span id="count-3" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-3"></div></div>
        <ul class="job-list" id="list-3"></ul>
    </div>

    <div style="padding: 0 15px;">
        <button class="btn-reset" onclick="resetAll()">üîÑ Reset Semua Data (Hari Baru)</button>
    </div>
</div>

<div id="ticketModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Tambah Tiket Baru</h2>
            <span class="close-modal" onclick="closeTicketModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="modalTeamId">

            <div class="ai-section">
                <label style="display:block; text-align:left; font-weight:bold; color:#1565c0; margin-bottom:5px;">ü§ñ PASTE CHAT WA DISINI:</label>
                <textarea id="aiInput" placeholder="Contoh: Pasang baru rumah pak ahmad jl merdeka no 10 paket 50mbps no wa 0812xxx"></textarea>
                <button class="btn-ai" onclick="generateWithAI()" id="btnAi">
                    <span>‚ú® AUTO-FILL WITH AI (1.5 Flash)</span>
                </button>
            </div>
            
            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

            <div class="form-group">
                <label>Nama Pelanggan</label>
                <input type="text" id="inputName" placeholder="Contoh: Bpk Budi">
            </div>

            <div class="input-grid">
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="inputCategory">
                        <option value="PSB">PSB (Pasang Baru)</option>
                        <option value="MT">MT (Maintenance)</option>
                        <option value="LOS">LOS (Perbaikan)</option>
                        <option value="SO">SO (Sambung)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Keterangan Tag (Badge)</label>
                    <input type="text" id="inputTagDesc" placeholder="Cth: 150rb / KABEL PUTUS">
                </div>
            </div>

            <div class="form-group">
                <label>Alamat</label>
                <textarea id="inputAddress" rows="2" placeholder="Alamat lengkap..."></textarea>
            </div>

            <div class="input-grid">
                <div class="form-group">
                    <label>No WA / Telp</label>
                    <input type="text" id="inputPhone" placeholder="08...">
                </div>
                <div class="form-group">
                    <label>Paket / Layanan</label>
                    <input type="text" id="inputPaket" placeholder="Cth: 10Mbps / ID Pelanggan">
                </div>
            </div>
            
            <div class="form-group">
                <label>Catatan Tambahan</label>
                <input type="text" id="inputNote" placeholder="Cth: Kunci rumah di tetangga">
            </div>

            <button class="btn-submit" onclick="saveNewTicket()">Simpan Tiket</button>
        </div>
    </div>
</div>

<script type="module">
    // Import Library + Safety Settings
    import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";

    // --- API KEY CONFIGURATION ---
    const API_KEY = "AIzaSyB7MKdgP1gGSTUsfP2g-dPq_CtbBdPpEns"; 
    const genAI = new GoogleGenerativeAI(API_KEY);

    // AI FUNCTION (UPDATED to 1.5 Flash + JSON Mode + Unsafe Allowed)
    window.generateWithAI = async function() {
        const inputText = document.getElementById('aiInput').value;
        const btn = document.getElementById('btnAi');
        
        if(!inputText.trim()) { alert("Paste chat WA dulu bos!"); return; }

        btn.innerHTML = '<div class="loading-spinner"></div> Memproses...';
        btn.disabled = true;

        try {
            // MENGGUNAKAN MODEL 1.5 FLASH (Lebih Cepat & Pintar)
            const model = genAI.getGenerativeModel({ 
                model: "gemini-1.5-flash",
                generationConfig: { responseMimeType: "application/json" }, // KUNCI UTAMA: MEMAKSA JSON
                // MEMATIKAN SENSOR AGAR ALAMAT/NO HP TIDAK DI-BLOCK
                safetySettings: [
                    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                ]
            });
            
            const prompt = `
            Ekstrak data dari chat berikut menjadi JSON. 
            Teks: "${inputText}"
            
            Output JSON Schema:
            {
                "name": "Nama Pelanggan (String)",
                "category": "PSB/MT/LOS/SO (String)",
                "tag_desc": "Harga/Masalah (String)",
                "address": "Alamat Lengkap (String)",
                "phone": "Nomor HP (String)",
                "packet": "Nama Paket/ID (String)",
                "note": "Catatan (String)"
            }
            Jika data tidak ada, isi string kosong.
            `;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            // Parse JSON dengan aman
            const data = JSON.parse(text);

            // Auto Fill Form
            document.getElementById('inputName').value = data.name || "";
            document.getElementById('inputCategory').value = (data.category && ["PSB","MT","LOS","SO"].includes(data.category)) ? data.category : "PSB";
            document.getElementById('inputTagDesc').value = data.tag_desc || "";
            document.getElementById('inputAddress').value = data.address || "";
            document.getElementById('inputPhone').value = data.phone || "";
            document.getElementById('inputPaket').value = data.packet || "";
            document.getElementById('inputNote').value = data.note || "";

            alert("‚úÖ Data berhasil diisi otomatis!");

        } catch (error) {
            console.error("Error AI:", error);
            alert("Gagal memproses AI. Pastikan API Key valid atau koneksi lancar.");
        } finally {
            btn.innerHTML = '<span>‚ú® AUTO-FILL WITH AI (1.5 Flash)</span>';
            btn.disabled = false;
        }
    }

    // --- LOGIKA UTAMA APLIKASI (SAMA SEPERTI SEBELUMNYA) ---
    
    const rawTeams = [
        { id: 1, teamName: "Tim 1: Kholis & Dani", jobs: [] },
        { id: 2, teamName: "Tim 2: Yudha & Bimo", jobs: [] },
        { id: 3, teamName: "Tim 3: Pian", jobs: [] }
    ];

    let teams = [];

    window.initializeData = function() {
        teams = JSON.parse(JSON.stringify(rawTeams));
        const customTickets = JSON.parse(localStorage.getItem('sinyalku_custom_tickets_v1')) || [];
        customTickets.forEach(ticket => {
            const team = teams.find(t => t.id === ticket.teamId);
            if(team) {
                ticket.isCustom = true;
                team.jobs.push(ticket);
            }
        });
    }

    window.renderJobs = function() {
        teams.forEach(team => {
            const el = document.getElementById(`list-${team.id}`);
            if(el) el.innerHTML = '';
        });

        teams.forEach(team => {
            const listContainer = document.getElementById(`list-${team.id}`);
            if(!listContainer) return;

            team.jobs.forEach((job, index) => {
                const li = document.createElement('li');
                li.className = 'job-item';
                
                let detailHTML = '';
                for (const [key, value] of Object.entries(job.details)) {
                    detailHTML += `<div class="detail-item"><span class="detail-label">${key}</span><span class="detail-value">${value}</span></div>`;
                }

                const uniqueId = `details-${team.id}-${index}`;
                const checkboxId = `chk-${team.id}-${index}`;
                const isPSB = job.tag.toUpperCase().includes("PSB");

                let formHTML = '';
                if (isPSB) {
                    formHTML = `
                    <div class="manual-input-section">
                        <h4 style="margin:0 0 15px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìù Input Data Teknis</h4>
                        <div class="input-grid">
                            <div class="input-group"><label>Kode SN</label><input type="text" id="sn-${team.id}-${index}" placeholder="ZTEGC..."></div>
                            <div class="input-group"><label>Mac</label><input type="text" id="mac-${team.id}-${index}" placeholder="A1:B2..."></div>
                            <div class="input-group"><label>Mac vlan</label><input type="text" id="vlan-${team.id}-${index}" placeholder="Vlan.."></div>
                            <div class="input-group"><label>Panjang kabel</label><input type="text" id="kabel-${team.id}-${index}" placeholder="150m"></div>
                            <div class="input-group"><label>Port</label><input type="text" id="port-${team.id}-${index}" placeholder="2"></div>
                            <div class="input-group"><label>Id ODP</label><input type="text" id="odp-${team.id}-${index}" placeholder="ODP-.."></div>
                            <div class="input-group" style="grid-column: 1/-1;"><label>Redaman</label><input type="text" id="redaman-${team.id}-${index}" placeholder="-18 dBm"></div>
                        </div>
                    </div>`;
                }

                let deleteBtn = '';
                if(job.isCustom) {
                    deleteBtn = `<button class="btn-delete" style="display:block" onclick="deleteTicket(${team.id}, ${index})">‚ùå Hapus</button>`;
                }

                li.innerHTML = `
                    <div class="job-main-row">
                        <div class="job-left">
                            <input type="checkbox" id="${checkboxId}" class="custom-checkbox" onchange="toggleCheck(this, ${team.id})">
                            <div class="customer-info">
                                <h3>${job.name} <span class="badge ${job.tagClass}">${job.tag}</span></h3>
                                <p>üìç ${job.address}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyData(${team.id}, ${index}, this)">üìã Copy</button>
                            <button class="toggle-btn" onclick="toggleDetails('${uniqueId}')">üîΩ Detail</button>
                            ${deleteBtn}
                        </div>
                    </div>
                    <div id="${uniqueId}" class="job-details">
                        <div class="detail-grid">
                            <div class="detail-item"><span class="detail-label">Jadwal</span><span class="detail-value">${job.time}</span></div>
                            ${detailHTML}
                        </div>
                        ${formHTML}
                    </div>
                `;
                listContainer.appendChild(li);
            });
        });
        window.loadState();
    }

    // Modal Functions
    window.openTicketModal = function(teamId) {
        document.getElementById('modalTeamId').value = teamId;
        document.getElementById('ticketModal').style.display = 'flex';
        document.getElementById('aiInput').value = '';
        document.getElementById('inputName').value = '';
        document.getElementById('inputTagDesc').value = '';
        document.getElementById('inputAddress').value = '';
        document.getElementById('inputPhone').value = '';
        document.getElementById('inputPaket').value = '';
        document.getElementById('inputNote').value = '';
    }

    window.closeTicketModal = function() {
        document.getElementById('ticketModal').style.display = 'none';
    }

    window.saveNewTicket = function() {
        const teamId = parseInt(document.getElementById('modalTeamId').value);
        const name = document.getElementById('inputName').value;
        const cat = document.getElementById('inputCategory').value;
        const desc = document.getElementById('inputTagDesc').value;
        const address = document.getElementById('inputAddress').value;
        const phone = document.getElementById('inputPhone').value;
        const paket = document.getElementById('inputPaket').value;
        const note = document.getElementById('inputNote').value;

        if(!name || !desc) { alert("Nama dan Keterangan Tag wajib diisi!"); return; }

        let badgeClass = 'badge-info';
        if(cat === 'PSB') badgeClass = 'badge-psb';
        else if(cat === 'MT') badgeClass = 'badge-mt';
        else if(cat === 'LOS') badgeClass = 'badge-los';
        else if(cat === 'SO') badgeClass = 'badge-prio';

        const newJob = {
            teamId: teamId,
            name: name.toUpperCase(),
            tag: `${cat} (${desc})`,
            tagClass: badgeClass,
            time: "ADDITIONAL",
            address: address || "Alamat menyusul",
            details: {
                "No WA": phone || "-",
                "Paket/Layanan": paket || "-",
                "Catatan": note || "-"
            },
            timestamp: new Date().getTime(),
            isCustom: true
        };

        const customTickets = JSON.parse(localStorage.getItem('sinyalku_custom_tickets_v1')) || [];
        customTickets.push(newJob);
        localStorage.setItem('sinyalku_custom_tickets_v1', JSON.stringify(customTickets));

        alert("‚úÖ Tiket berhasil ditambahkan!");
        window.closeTicketModal();
        window.initializeData();
        window.renderJobs();
    }

    window.deleteTicket = function(teamId, index) {
        if(confirm("Hapus tiket ini?")) {
            const team = teams.find(t => t.id === teamId);
            const jobToDelete = team.jobs[index];

            if(jobToDelete.isCustom) {
                let customTickets = JSON.parse(localStorage.getItem('sinyalku_custom_tickets_v1')) || [];
                customTickets = customTickets.filter(t => t.timestamp !== jobToDelete.timestamp);
                localStorage.setItem('sinyalku_custom_tickets_v1', JSON.stringify(customTickets));
                
                const chkId = `chk-${teamId}-${index}`;
                const state = JSON.parse(localStorage.getItem('sinyalku_progress_7jan_updated_v3')) || {};
                delete state[chkId];
                localStorage.setItem('sinyalku_progress_7jan_updated_v3', JSON.stringify(state));

                window.initializeData();
                window.renderJobs();
            } else {
                alert("Data bawaan tidak bisa dihapus permanen, hanya di reset.");
            }
        }
    }

    // Copy Functions
    window.copyData = async function(teamId, jobIndex, btn) {
        const team = teams.find(t => t.id === teamId);
        const job = team.jobs[jobIndex];
        const d = job.details;
        const isPSB = job.tag.toUpperCase().includes("PSB");
        const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '-';

        let technicalData = '';
        if (isPSB) {
            technicalData = `\n\n--- DATA TEKNIS ---
kode SN : ${getVal(`sn-${teamId}-${jobIndex}`)}
Mac : ${getVal(`mac-${teamId}-${jobIndex}`)}
Mac vlan : ${getVal(`vlan-${teamId}-${jobIndex}`)}
Panjang kabel : ${getVal(`kabel-${teamId}-${jobIndex}`)}
Port : ${getVal(`port-${teamId}-${jobIndex}`)}
Id ODP : ${getVal(`odp-${teamId}-${jobIndex}`)}
Redaman : ${getVal(`redaman-${teamId}-${jobIndex}`)}`;
        }

        const textToCopy = `TEKNISI : ${team.teamName}
KATEGORI : ${job.tag}
--------------------------------
Nama Lengkap : ${job.name} ( JAM ${job.time} )
Alamat Lengkap : ${job.address}
Email Aktif: ${d['Email']||'-'}
No. Wa: ${d['No WA']||'-'}
Paket Layanan : ${d['Paket/Layanan']||d['Paket']||'-'}
Biaya regist : ${d['Biaya Regis']||'-'}
No KTP : ${d['No KTP']||'-'}
Tanggal/Jam Pemasangan : ${job.time === 'FLEXIBEL' ? 'FLEXIBEL' : 'Sesuai Jadwal'}
Refrensi SRB dari : ${d['Ref']||'-'}
FOTO Depan Rumah :${technicalData}`;

        window.copyToClipboard(textToCopy, btn);
    }

    window.copyAllSummary = function() {
        let summaryText = `üìã *MONITORING TEKNISI SINYALKU*\nüìÖ 7 Jan 2026\n\n`;
        teams.forEach(team => {
            summaryText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüõ†Ô∏è *${team.teamName.toUpperCase()}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            team.jobs.forEach((job, index) => {
                const checkbox = document.getElementById(`chk-${team.id}-${index}`);
                const isChecked = checkbox ? checkbox.checked : false;
                const statusText = isChecked ? "‚úÖ SELESAI" : "‚è≥ PENDING";
                let line1 = `*${index + 1}. ${job.name}*`;
                let line2 = `   üì± ${job.details['No WA']||'-'} | üìç ${job.address}`;
                let line3 = `   üè∑Ô∏è ${job.tag} | ${statusText}`;
                summaryText += `${line1}\n${line2}\n${line3}\n\n`;
            });
        });
        summaryText += `_Generated by Monitoring System_`;
        const btn = document.querySelector('.btn-copy-all');
        window.copyToClipboard(summaryText, btn, "‚úÖ Rekap Tersalin!");
    }

    window.copyToClipboard = async function(text, btnElement, successMsg = "‚úÖ Tersalin!") {
        try {
            await navigator.clipboard.writeText(text);
            if (btnElement) {
                const originalText = btnElement.innerHTML;
                const originalBg = btnElement.style.backgroundColor;
                btnElement.innerHTML = successMsg;
                btnElement.style.backgroundColor = "#28a745";
                setTimeout(() => {
                    btnElement.innerHTML = originalText;
                    btnElement.style.backgroundColor = originalBg;
                }, 2000);
            }
        } catch (err) {
            alert("Gagal copy. Izin browser diperlukan.");
        }
    }

    // UI Helpers
    window.toggleDetails = function(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "block") ? "none" : "block";
    }

    window.toggleCheck = function(checkbox, teamId) {
        const li = checkbox.closest('.job-item');
        checkbox.checked ? li.classList.add('completed') : li.classList.remove('completed');
        window.updateProgress(teamId);
        window.saveState();
    }

    window.updateProgress = function(teamId) {
        const list = document.getElementById(`list-${teamId}`);
        if(!list) return;
        const total = list.querySelectorAll('input[type="checkbox"]').length;
        const checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
        const percent = (total === 0) ? 0 : (checked / total) * 100;
        document.getElementById(`progress-${teamId}`).style.width = percent + '%';
        document.getElementById(`count-${teamId}`).innerText = `${checked}/${total} Selesai`;
    }

    window.saveState = function() {
        const checkboxes = document.querySelectorAll('.custom-checkbox');
        const state = {};
        checkboxes.forEach(box => { state[box.id] = box.checked; });
        localStorage.setItem('sinyalku_progress_7jan_updated_v3', JSON.stringify(state));
    }

    window.loadState = function() {
        const savedData = localStorage.getItem('sinyalku_progress_7jan_updated_v3');
        if (savedData) {
            const state = JSON.parse(savedData);
            for (const [id, isChecked] of Object.entries(state)) {
                const box = document.getElementById(id);
                if (box) {
                    box.checked = isChecked;
                    if (isChecked) box.closest('.job-item').classList.add('completed');
                }
            }
        }
        teams.forEach(t => window.updateProgress(t.id));
    }

    window.resetAll = function() {
        if(confirm("Reset semua data?")) {
            localStorage.removeItem('sinyalku_progress_7jan_updated_v3');
            localStorage.removeItem('sinyalku_custom_tickets_v1');
            location.reload();
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('ticketModal');
        if (event.target == modal) {
            window.closeTicketModal();
        }
    }

    window.initializeData();
    window.renderJobs();
</script>

</body>
</html>
