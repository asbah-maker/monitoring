<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring Teknisi Sinyalku - Online</title>
    <style id="main-style">
        /* --- RESET & BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f9; 
            padding: 10px; 
            color: #333; 
            margin: 0; 
            font-size: 14px;
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            width: 100%;
        }

        /* --- HEADER --- */
        .header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            text-align: center;
        }
        
        h1 { 
            color: #2c3e50; 
            margin: 0 0 15px 0; 
            font-size: 1.5rem; 
            line-height: 1.3; 
        }

        .status-indicator {
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
            color: #666;
            background: #fff;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            display: inline-flex;
            align-items: center;
        }
        .online-dot { 
            height: 10px; width: 10px; 
            background-color: #bbb; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px; 
        }
        .online-active { background-color: #28a745; box-shadow: 0 0 5px #28a745; }

        .btn-copy-all {
            background-color: #17a2b8; color: white; border: none;
            padding: 10px 20px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s, background 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-copy-all:active { transform: scale(0.95); }

        /* --- CARDS --- */
        .team-card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            margin-bottom: 20px; 
            overflow: hidden; 
            border: 1px solid #e1e4e8; 
        }
        
        .team-header { 
            padding: 15px; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 1rem;
        }

        .header-team1 { background: linear-gradient(135deg, #007bff, #0056b3); } 
        .header-team2 { background: linear-gradient(135deg, #28a745, #1e7e34); } 
        .header-team3 { background: linear-gradient(135deg, #dc3545, #bd2130); }

        /* Tombol Tambah Tugas Baru */
        .btn-add-task {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .btn-add-task:hover { background: rgba(255,255,255,0.3); }

        .job-list { list-style: none; padding: 0; margin: 0; }
        
        .job-item { 
            border-bottom: 1px solid #eee; 
            padding: 15px; 
            transition: background 0.2s; 
        }
        .job-item:last-child { border-bottom: none; }

        /* --- CONTENT LAYOUT --- */
        .job-main-row { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 12px; 
            justify-content: space-between;
        }

        .job-left { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            flex: 1 1 60%; 
            min-width: 250px;
        }

        .custom-checkbox { 
            width: 24px; height: 24px; 
            cursor: pointer; accent-color: #28a745; 
            flex-shrink: 0; 
            margin-top: 2px;
        }

        .customer-info h3 { margin: 0; font-size: 1.05rem; color: #2c3e50; line-height: 1.4; }
        .customer-info p { margin: 4px 0 0; font-size: 0.9rem; color: #666; }

        .badge { 
            padding: 4px 8px; border-radius: 6px; 
            font-size: 0.75rem; font-weight: bold; 
            text-transform: uppercase; display: inline-block; 
            margin-top: 4px;
        }
        .badge-psb { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .badge-mt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-los { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .badge-prio { background-color: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; }
        .badge-info { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }

        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .toggle-btn, .btn-copy { 
            padding: 8px 12px; border-radius: 6px; 
            font-size: 0.85rem; font-weight: 600; 
            cursor: pointer; white-space: nowrap; 
            flex: 1; text-align: center;
        }
        .toggle-btn { background: #f0f7ff; border: 1px solid #007bff; color: #007bff; }
        .btn-copy { background: #fff5eb; border: 1px solid #fd7e14; color: #fd7e14; }

        .job-details { 
            display: none; margin-top: 15px; 
            background-color: #f8f9fa; padding: 15px; 
            border-radius: 8px; border: 1px solid #e9ecef;
        }

        .detail-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 12px; margin-bottom: 15px; 
        }
        .detail-item { 
            background: white; padding: 8px; 
            border-radius: 4px; border: 1px solid #eee; 
        }
        .detail-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px;}
        .detail-value { font-size: 0.95rem; color: #333; font-weight: 500; word-break: break-word; }

        .manual-input-section { 
            background-color: #fff; border: 1px solid #dfe6ed; 
            padding: 15px; border-radius: 8px; 
        }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .input-grid { grid-template-columns: 1fr; } }
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .input-group input { 
            width: 100%; padding: 10px; 
            border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; 
        }

        .progress-container { height: 6px; background: #e9ecef; width: 100%; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease; }
        
        .job-item.completed { background-color: #f6fff9; opacity: 0.8; }
        .job-item.completed .customer-info h3 { text-decoration: line-through; color: #999; }

        /* --- MODAL ADD TASK --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
            padding: 10px;
        }
        .modal-box {
            background: white; width: 100%; max-width: 500px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 20px;
        }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .modal-body textarea {
            width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 6px;
            padding: 10px; font-family: monospace; font-size: 0.9rem; margin-bottom: 15px;
        }
        .modal-footer { text-align: right; display: flex; gap: 10px; justify-content: flex-end;}
        .btn-cancel { background: #ddd; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;}
        .btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;}

        @media (max-width: 576px) {
            body { padding: 5px; background-color: #fff; }
            .container { padding: 0; }
            .team-card { border-radius: 0; border-left: none; border-right: none; box-shadow: none; border-bottom: 2px solid #eee; }
            .header-section { margin: 15px 10px; }
            .job-main-row { flex-direction: column; align-items: flex-start; }
            .job-left { width: 100%; }
            .action-buttons { width: 100%; margin-top: 10px; }
            .toggle-btn, .btn-copy { width: 100%; padding: 10px; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>
            üìã Monitoring Teknisi<br>
            <span style="font-size: 0.6em; color: green; display: block; margin-top:5px;">Update: 9 Jan 2026</span>
        </h1>
        <div class="status-indicator">
            <span id="conn-dot" class="online-dot"></span> <span id="conn-text">Menghubungkan...</span>
        </div>
        <br>
        <button class="btn-copy-all" onclick="copyAllSummary()">üìë Copy Rekap Harian</button>
    </div>

    <div class="team-card">
        <div class="team-header header-team2">
            <div>
                <span>Tim 1: Ramdani & Rivaldi</span>
                <button class="btn-add-task" onclick="openModal(1)">+ Tambah</button>
            </div>
            <span id="count-1" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-1"></div></div>
        <ul class="job-list" id="list-1"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team1">
            <div>
                <span>Tim 2: Yudha & Bimo</span>
                <button class="btn-add-task" onclick="openModal(2)">+ Tambah</button>
            </div>
            <span id="count-2" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-2"></div></div>
        <ul class="job-list" id="list-2"></ul>
    </div>

    <div class="team-card">
        <div class="team-header header-team3">
            <div>
                <span>Tim 3: Pian</span>
                <button class="btn-add-task" onclick="openModal(3)">+ Tambah</button>
            </div>
            <span id="count-3" style="font-size: 0.9em;">0/0</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-3"></div></div>
        <ul class="job-list" id="list-3"></ul>
    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">Tambah Tugas Manual (Tim <span id="modalTeamId"></span>)</div>
        <div class="modal-body">
            <p style="font-size:0.85rem; color:#666; margin-bottom:5px;">Paste format tiket (Nama, Alamat, Paket, dll) di bawah ini. Sistem akan otomatis merapikan.</p>
            <textarea id="rawInput" placeholder="Contoh:
Nama Lengkap : Budi
Alamat : Jl Mawar No 1
Paket : 150k
No WA : 08123..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn-save" onclick="processAndSave()">Simpan Tugas</button>
        </div>
    </div>
</div>

<script type="module">
    // --- 1. IMPORT FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 2. KONFIGURASI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA-qFL7CutiOoAEHXDXcGVsZA65yeG6G1A",
      authDomain: "monitoring-3aeb6.firebaseapp.com",
      databaseURL: "https://monitoring-3aeb6-default-rtdb.firebaseio.com",
      projectId: "monitoring-3aeb6",
      storageBucket: "monitoring-3aeb6.firebasestorage.app",
      messagingSenderId: "888117973644",
      appId: "1:888117973644:web:d69bd316cd7178679ee1a9",
      measurementId: "G-PTL0F1FPK0"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Indikator Koneksi
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        const dot = document.getElementById('conn-dot');
        const txt = document.getElementById('conn-text');
        if (snap.val() === true) {
            dot.classList.add('online-active');
            txt.innerHTML = "Online (Data Tersimpan)";
            txt.style.color = "green";
        } else {
            dot.classList.remove('online-active');
            txt.innerHTML = "Offline (Cek Internet)";
            txt.style.color = "red";
        }
    });

    // --- DATA UTAMA (HARDCODED - DIUPDATE 9 JAN) ---
    const baseTeams = [
        {
            id: 1, 
            teamName: "Tim 1: Ramdani & Rivaldi",
            jobs: [
                { 
                    id: "h1", 
                    name: "VIA KURNIAWATI", 
                    tag: "PSB (Unknown)", 
                    tagClass: "badge-psb", 
                    time: "11:00", 
                    address: "Alamat belum diinput...", 
                    details: { "Catatan": "Data belum lengkap, silakan edit/tambah detail" } 
                }
            ]
        },
        {
            id: 2, 
            teamName: "Tim 2: Yudha & Bimo",
            jobs: [
                // Data lama dibersihkan untuk hari baru, bisa diisi via tombol Tambah
                // { id: "h6", name: "MUHAMAD SYAFRUDIN", tag: "PSB (150rb)", tagClass: "badge-psb", time: "10:00", address: "Jl. Tipar Cakung No 46", details: { "Paket": "150k + Regis 50k", "Status": "Pribadi" } }
            ]
        },
        {
            id: 3, 
            teamName: "Tim 3: Pian",
            jobs: []
        }
    ];

    // Variabel Global untuk menyimpan gabungan Hardcoded + Firebase Jobs
    let allTeamsData = JSON.parse(JSON.stringify(baseTeams)); // Clone awal

    // Expose functions untuk HTML onclick
    window.processAndSave = async function() {
        const teamId = document.getElementById('modalTeamId').innerText;
        const rawText = document.getElementById('rawInput').value;
        
        if(!rawText.trim()) { alert("Data kosong!"); return; }

        // --- PARSING LOGIC (OTOMATIS RAPIH) ---
        const lines = rawText.split('\n');
        let parsedData = {};
        
        lines.forEach(line => {
            if(line.includes(':')) {
                const parts = line.split(':');
                const key = parts[0].trim().toLowerCase();
                const val = parts.slice(1).join(':').trim(); // Gabung sisa jika ada : lain
                parsedData[key] = val;
            }
        });

        // Mapping Field (Menyesuaikan input user ke format sistem)
        const getKey = (keyword) => Object.keys(parsedData).find(k => k.includes(keyword));

        const name = parsedData[getKey('nama')] || "TANPA NAMA";
        const address = parsedData[getKey('alamat')] || "-";
        const paket = parsedData[getKey('paket')] || "-";
        
        // Logika Auto Tagging
        let tag = "TIKET TAMBAHAN";
        let tagClass = "badge-info";
        
        const paketUpper = paket.toUpperCase();
        if(paketUpper.includes("150") || paketUpper.includes("190") || paket.includes("200") || rawText.toLowerCase().includes("biaya regist")) {
            tag = `PSB (${paket})`;
            tagClass = "badge-psb";
        } else if(rawText.toLowerCase().includes("los") || rawText.toLowerCase().includes("mt") || rawText.toLowerCase().includes("perbaikan")) {
            tag = "MT (GANGGUAN)";
            tagClass = "badge-mt";
        }

        // Simpan sisa data ke details
        let details = {};
        for (const [k, v] of Object.entries(parsedData)) {
            const label = k.replace(/\b\w/g, l => l.toUpperCase());
            details[label] = v;
        }

        const newJob = {
            name: name,
            tag: tag,
            tagClass: tagClass,
            time: "FLEXIBEL", // Default flexibel untuk tugas susulan
            address: address,
            details: details
        };

        // --- SIMPAN KE FIREBASE (ADDITIONAL JOBS) ---
        const newJobRef = push(ref(db, 'additional_jobs/team_' + teamId));
        await set(newJobRef, newJob);

        alert("Tugas berhasil ditambahkan!");
        closeModal();
    }

    // --- RENDER HTML ---
    function renderJobs() {
        allTeamsData.forEach(team => {
            const listContainer = document.getElementById(`list-${team.id}`);
            if(!listContainer) return;
            listContainer.innerHTML = ''; 

            if(team.jobs.length === 0) {
                listContainer.innerHTML = '<li class="job-item" style="text-align:center; color:#999; padding:20px;"><i>‚è≥ Menunggu Tiket Tambahan...</i></li>';
                return;
            }

            team.jobs.forEach((job, index) => {
                const li = document.createElement('li');
                li.className = 'job-item';
                
                // ID unik gabungan ID job (jika dari firebase) atau index (hardcoded)
                const uniqueKey = job.firebaseKey ? job.firebaseKey : `hardcoded-${team.id}-${index}`;
                const checkboxId = `chk-${uniqueKey}`;
                const detailId = `detail-${uniqueKey}`;

                let detailHTML = '';
                if(job.details) {
                    for (const [key, value] of Object.entries(job.details)) {
                        detailHTML += `<div class="detail-item"><span class="detail-label">${key}</span><span class="detail-value">${value}</span></div>`;
                    }
                }

                const isPSB = job.tag.toUpperCase().includes("PSB");

                let formHTML = '';
                if (isPSB) {
                    formHTML = `
                    <div class="manual-input-section">
                        <h4 style="margin:0 0 15px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìù Input Data Teknis</h4>
                        <div class="input-grid">
                            <div class="input-group"><label>Kode SN</label><input type="text" id="sn-${uniqueKey}" placeholder="ZTEGC..."></div>
                            <div class="input-group"><label>Mac</label><input type="text" id="mac-${uniqueKey}" placeholder="A1:B2..."></div>
                            <div class="input-group"><label>Mac vlan</label><input type="text" id="vlan-${uniqueKey}" placeholder="Vlan.."></div>
                            <div class="input-group"><label>Panjang kabel</label><input type="text" id="kabel-${uniqueKey}" placeholder="150m"></div>
                            <div class="input-group"><label>Port</label><input type="text" id="port-${uniqueKey}" placeholder="2"></div>
                            <div class="input-group"><label>Id ODP</label><input type="text" id="odp-${uniqueKey}" placeholder="ODP-.."></div>
                            <div class="input-group" style="grid-column: 1/-1;"><label>Redaman</label><input type="text" id="redaman-${uniqueKey}" placeholder="-18 dBm"></div>
                        </div>
                    </div>`;
                }

                li.innerHTML = `
                    <div class="job-main-row">
                        <div class="job-left">
                            <input type="checkbox" id="${checkboxId}" class="custom-checkbox" data-db-id="${checkboxId}">
                            <div class="customer-info">
                                <h3>${job.name} <span class="badge ${job.tagClass}">${job.tag}</span></h3>
                                <p>üìç ${job.address}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyData('${team.id}', '${uniqueKey}', this)">üìã Copy</button>
                            <button class="toggle-btn" onclick="toggleDetails('${detailId}')">üîΩ Detail</button>
                        </div>
                    </div>
                    <div id="${detailId}" class="job-details">
                        <div class="detail-grid">
                            <div class="detail-item"><span class="detail-label">Jadwal</span><span class="detail-value">${job.time}</span></div>
                            ${detailHTML}
                        </div>
                        ${formHTML}
                    </div>
                `;
                listContainer.appendChild(li);

                // Add Event Listener for Checkbox Firebase
                const checkbox = li.querySelector(`#${checkboxId}`);
                checkbox.addEventListener('change', (e) => {
                    const status = e.target.checked;
                    set(ref(db, 'checklist_v1/' + checkboxId), status);
                });
            });
        });
        
        // Update Checkbox States (Karena render ulang, kita perlu ambil state lagi)
        updateCheckboxStates();
    }

    // Fungsi update status checkbox (dipisah biar bisa dipanggil kapan saja)
    let currentChecklistData = {};
    function updateCheckboxStates() {
         document.querySelectorAll('.custom-checkbox').forEach(box => {
            const dbId = box.getAttribute('data-db-id');
            const isChecked = currentChecklistData[dbId] === true;
            
            box.checked = isChecked;
            const li = box.closest('.job-item');
            if(isChecked) {
                li.classList.add('completed');
            } else {
                li.classList.remove('completed');
            }
        });
        updateProgressBar();
    }
    
    function updateProgressBar() {
        allTeamsData.forEach(team => {
            const list = document.getElementById(`list-${team.id}`);
            if(list) {
                const total = list.querySelectorAll('input[type="checkbox"]').length;
                const checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
                const percent = (total === 0) ? 0 : (checked / total) * 100;
                
                const pBar = document.getElementById(`progress-${team.id}`);
                const pCount = document.getElementById(`count-${team.id}`);
                
                if(pBar) pBar.style.width = percent + '%';
                if(pCount) pCount.innerText = `${checked}/${total} Selesai`;
            }
        });
    }

    // --- LISTENER GABUNGAN (CORE LOGIC BARU) ---
    // 1. Dengar Checklist (Status Selesai/Belum)
    const checklistRef = ref(db, 'checklist_v1');
    onValue(checklistRef, (snapshot) => {
        currentChecklistData = snapshot.val() || {};
        updateCheckboxStates();
    });

    // 2. Dengar Tugas Tambahan (Additional Jobs)
    const addJobsRef = ref(db, 'additional_jobs');
    onValue(addJobsRef, (snapshot) => {
        const addData = snapshot.val() || {};
        
        // Reset ke data hardcoded awal dulu
        allTeamsData = JSON.parse(JSON.stringify(baseTeams));

        // Gabungkan data firebase ke data hardcoded
        [1, 2, 3].forEach(teamId => {
            const teamKey = 'team_' + teamId;
            if(addData[teamKey]) {
                const teamIndex = allTeamsData.findIndex(t => t.id === teamId);
                if(teamIndex > -1) {
                    const jobsObj = addData[teamKey];
                    // Convert object firebase ke array
                    const firebaseJobs = Object.keys(jobsObj).map(key => {
                        return {
                            ...jobsObj[key],
                            firebaseKey: key, // Penting untuk ID unik
                            isAdditional: true
                        };
                    });
                    // Masukkan ke array jobs tim tersebut
                    allTeamsData[teamIndex].jobs.push(...firebaseJobs);
                }
            }
        });

        // Update window object untuk fungsi copy
        window.teams = allTeamsData;
        
        // Render Ulang semua tampilan
        renderJobs();
    });

    // Expose data awal
    window.teams = baseTeams;
</script>

<script>
    // --- FUNGSI UI / NON-MODULE ---
    
    function openModal(teamId) {
        document.getElementById('modalTeamId').innerText = teamId;
        document.getElementById('rawInput').value = ''; // Reset form
        document.getElementById('addModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('addModal').style.display = 'none';
    }

    function toggleDetails(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "block" ? "none" : "block");
    }

    async function copyData(teamIdStr, uniqueKey, btn) {
        // Cari tim dan job berdasarkan struktur data terbaru
        const teamId = parseInt(teamIdStr);
        const team = window.teams.find(t => t.id === teamId);
        
        // Cari job berdasarkan uniqueKey (bisa index untuk hardcoded atau key firebase)
        let job;
        if(uniqueKey.startsWith('hardcoded')) {
            const idx = parseInt(uniqueKey.split('-')[2]);
            job = team.jobs[idx]; // Ambil dari index jika hardcoded
        } else {
            job = team.jobs.find(j => j.firebaseKey === uniqueKey);
        }

        if(!job) { alert("Data job tidak ditemukan!"); return; }

        const d = job.details || {};
        const isPSB = job.tag.toUpperCase().includes("PSB");

        const getVal = (keys) => {
            for (let k of keys) {
                // Case insensitive search di details
                const foundKey = Object.keys(d).find(dk => dk.toLowerCase() === k.toLowerCase());
                if(foundKey) return d[foundKey];
            }
            return '-';
        };

        const email = getVal(['Email', 'Email Aktif']) || '-';
        const wa = getVal(['No WA', 'No. Wa', 'No Telp']) || '-';
        const paket = getVal(['Paket', 'Paket Layanan', 'Layanan']) || '-'; 
        const regist = getVal(['Biaya Regis', 'Biaya']) || '-';
        const ktp = getVal(['No KTP']) || '-';
        const refInfo = getVal(['Ref SRB', 'Ref']) || '-';
        
        const headerInfo = `TEKNISI : ${team.teamName}\nKATEGORI : ${job.tag}\n--------------------------------`;

        let technicalData = '';
        if (isPSB) {
            const ids = ['sn','mac','vlan','kabel','port','odp','redaman'];
            const vals = ids.map(id => {
                const el = document.getElementById(`${id}-${uniqueKey}`);
                return el ? el.value : '-';
            });
            technicalData = `\n\n--- DATA TEKNIS ---\nKode SN : ${vals[0]}\nMac : ${vals[1]}\nMac vlan : ${vals[2]}\nPanjang kabel : ${vals[3]}\nPort : ${vals[4]}\nId ODP : ${vals[5]}\nRedaman : ${vals[6]}`;
        }

        const textToCopy = `${headerInfo}
Nama Lengkap : ${job.name} ( JAM ${job.time} )
Alamat Lengkap : ${job.address}
Email Aktif: ${email}
No. Wa: ${wa}
Paket Layanan : ${paket}
Biaya regist : ${regist}
No KTP : ${ktp}
Tanggal/Jam Pemasangan : ${job.time.includes('FLEX') ? 'FLEXIBEL' : 'Sesuai Jadwal'}
Refrensi SRB dari : ${refInfo}
FOTO Depan Rumah :${technicalData}`;

        copyToClipboard(textToCopy, btn);
    }

    function copyAllSummary() {
        let summaryText = `üìã *MONITORING TEKNISI SINYALKU*\nüìÖ 9 Jan 2026\n\n`;
        window.teams.forEach(team => {
            summaryText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüõ†Ô∏è *${team.teamName.toUpperCase()}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            if(team.jobs.length === 0) {
                 summaryText += `_(Menunggu Tiket Tambahan)_\n\n`;
            } else {
                team.jobs.forEach((job, index) => {
                    // Tentukan ID Checkbox
                    const uniqueKey = job.firebaseKey ? job.firebaseKey : `hardcoded-${team.id}-${index}`;
                    const checkbox = document.getElementById(`chk-${uniqueKey}`);
                    
                    const isChecked = checkbox ? checkbox.checked : false;
                    const statusText = isChecked ? "‚úÖ SELESAI" : "‚è≥ PENDING";
                    
                    // Ambil No WA
                    let phone = '-';
                    if(job.details) {
                        const phoneKey = Object.keys(job.details).find(k => k.toLowerCase().includes('wa') || k.toLowerCase().includes('telp'));
                        if(phoneKey) phone = job.details[phoneKey];
                    }

                    summaryText += `*${index + 1}. ${job.name}*\n   üì± ${phone} | üìç ${job.address}\n   üè∑Ô∏è ${job.tag} | ${statusText}\n\n`;
                });
            }
        });
        summaryText += `_Generated by Monitoring System_`;
        copyToClipboard(summaryText, document.querySelector('.btn-copy-all'), "‚úÖ Rekap Tersalin!");
    }

    async function copyToClipboard(text, btnElement, successMsg = "‚úÖ Tersalin!") {
        let success = false;
        try { await navigator.clipboard.writeText(text); success = true; } catch (err) {}
        
        if (!success) {
            const ta = document.createElement("textarea");
            ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px"; 
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); success = true; } catch (e) {}
            document.body.removeChild(ta);
        }

        if (success && btnElement) {
            const originalText = btnElement.innerHTML;
            const originalBg = btnElement.style.backgroundColor;
            
            btnElement.innerHTML = successMsg;
            btnElement.style.backgroundColor = "#28a745"; 
            btnElement.style.color = "white";

            setTimeout(() => {
                btnElement.innerHTML = originalText;
                btnElement.style.backgroundColor = originalBg;
                btnElement.style.color = "";
            }, 2000);
        }
    }
</script>
</body>
</html>
